---
title: "Weather covariance matrices as U_hyp for GR50"
author: "Alice MacQueen"
date: 2021-01-05
output: html_document
---

# TRIAL script
# -------------------------
NB: Trial script on mash-env-cov branch to use weather covariance matrices as 
U_hyp in a mash run of GR50 phenotypes from 8 gardens.


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(bigsnpr)
library(switchgrassGWAS)
library(mashr)
```

# Load project data

```{r}
source("~/Github/Functions_ggplot-theme-adjustments_2018-01-03.R")
workingdir <- file.path("~", "Github", "pvdiv-phenology-gxe")
outputdir <- file.path(workingdir, "analysis", "gwas", "BLUPs", "single_sites")
mashdir <- file.path(workingdir, "analysis", "mash")
metadata <- read_rds(file.path(workingdir, "data", "metadata.rds"))
# pvdiv PLANT_ID metadata
sites <- read_rds(file.path(workingdir, "data", "sites.rds"))
# pvdiv common garden metadata
subpops <- read_rds(file.path(workingdir, "data", "subpop_color_coding.rds"))
phe_gr_df <- read_rds(file.path(workingdir, "data",
                                "Weather_related_phe_for_asreml_h2_GR50.rds"))
# all greenup related phenotypes, including greenup as functions of weather variables.
phe_fl_df <- read_rds(file.path(workingdir, "data",
                                "Weather_related_phe_for_asreml_h2_FL50.rds"))
# all flowering related phenotypes, including functions of weather variables.
k_full <- read_rds(file.path(workingdir, "data",
                    "Kinship_van_Raden_630_individuals_SNPs_r2_20percent.rds"))
# kinship matrix for 630 tetraploid individuals.

## vectors with subsets of gardens, phenotypes, and genetic subpopulations.
site_v <- list(TX1 = "TX1", TX2 = "TX2", TX3 = "TX3", OK = "OK", MO = "MO",
               NE = "NE", MI = "MI", SD = "SD")#, eight_sites = c("TX1", "TX2", "TX3", "OK", "MO", "NE", "MI", "SD"), tx_sites = c("TX1", "TX2", "TX3"), north_sites = c("MO", "NE", "MI", "SD"))
subpop_v <- list(Gulf_and_Midwest = "363g_12.1M", Midwest = "134g_8.8M", 
                 Gulf = "229g_10.3M")
subpop_v2 <- list(Gulf_and_Midwest = c("Gulf", "Midwest"), Midwest = "Midwest", 
                 Gulf = "Gulf")
phe_single <- c("FL50", "dyln_fl50", "cgdd_12c_gr2fl", "crain_gr2fl",
               "crain_1d", "GR50", "cgdd_12c_10d")
phe_mult <- list(flowering_5 = c("FL50", "dyln_fl50", "cgdd_12c_gr2fl",
                                 "crain_gr2fl", "crain_1d"), 
                 greenup_2 = c("GR50", "cgdd_12c_10d"))
inputfiles <- read_delim(file.path(workingdir, "analysis", "gwas",
                                   "inputkinship.txt"),  delim = " ", 
                                   col_names = "SNPfiles") 
# paths to large SNP files
```

# 1. Weather U_hyp

Make weather corr/covar matrices 

1. Make dataframe of each env variable across all 8 sites
2. Compute correlations with pairwise complete observations
3. Change within-site covariance to coefficient of variation for each site. NB: mash does set the maximum of the diagonal to 1... hmm. I wonder why.

Do this for three pop subsets for 'cgdd_12c_10d' and maybe for 'cgdd_12c_18d' and 'cgdd_12c_5d'.

Function to plot covariance matrices to look at their differences
```{r}
pvdiv_plot_cov <- function(covdf){
  U1 <- cor_phe
  if(isSymmetric(U1)){
        for(i in 1:nrow(U1)){
          for(j in 1:ncol(U1)){
            if(i < j){
              U1[i, j] <- NA
            }
          }
        }
  }
  U1 <- as_tibble(U1, rownames = "rowU", .name_repair = "unique") %>%
          pivot_longer(cols = -.data$rowU, names_to = "colU",
                       values_to = "covar") %>%
          filter(!is.na(.data$covar))
  U1$colU <- factor(U1$colU, levels = colnames(cor_phe))
  U1$rowU <- factor(U1$rowU, levels = colnames(cor_phe))
  
  U1_covar <- U1 %>%
    ggplot(aes(x = .data$rowU, y = .data$colU)) +
    switchgrassGWAS::theme_oeco +
    geom_tile(aes(fill = .data$covar), na.rm = TRUE) +
    scale_fill_gradientn(colors = c("#440154FF", "#3B528BFF", "#2C728EFF",
                                    "white", "#27AD81FF", "#5DC863FF",
                                    "#FDE725FF"), limits = c(-1,1)) +
    geom_text(aes(label = round(.data$covar, 1)), color = "darkgrey") +
    theme(legend.position = c(0.2, 0.9),
          axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) +
    xlab("") + ylab("") 
  return(U1_covar)
}

```

## 1a. Make U_hyp

Specify in the phe_hyp vector which functions of weather I want to make U_hyp for mash.
```{r}
U_hyp <- list()
ggcov <- list()
phe_hyp <- c("GR50", "cgdd_12c_10d", "cgdd_12c_18d", "cgdd_12c_5d", "tave_10d")

for(i in seq_along(phe_hyp)){
  for(k in seq_along(subpop_v2)){
    
  cov_df <- phe_gr_df %>%
    ungroup() %>%
    left_join(select(sites, SITE, manu_site), by = "SITE") %>%
    filter(SUBPOP %in% subpop_v2[[k]]) %>%
    select(PLANT_ID, SUBPOP, manu_site, phe_hyp[i]) %>%
    group_by(PLANT_ID, SUBPOP, manu_site) %>%
    mutate(IND = row_number()) %>%
    pivot_wider(names_from = manu_site, values_from = phe_hyp[i]) %>%
    mutate(PLANT_ID = as.factor(PLANT_ID),
           IND = as.factor(IND)) %>%
    select(-IL) %>%
    select(PLANT_ID, SUBPOP, IND, MI, MO, NE, OK, SD, TX1, TX2, TX3)

  cor_phe <- cor(cov_df[,-(1:3)], use = "pairwise")
  diag(cor_phe) <- cov_df %>%
    ungroup() %>%
    summarise(MI = sqrt(var(MI, na.rm = TRUE))/mean(MI, na.rm = TRUE),
              MO = sqrt(var(MO, na.rm = TRUE))/mean(MO, na.rm = TRUE),
              NE = sqrt(var(NE, na.rm = TRUE))/mean(NE, na.rm = TRUE),
              OK = sqrt(var(OK, na.rm = TRUE))/mean(OK, na.rm = TRUE),
              SD = sqrt(var(SD, na.rm = TRUE))/mean(SD, na.rm = TRUE),
              TX1 = sqrt(var(TX1, na.rm = TRUE))/mean(TX1, na.rm = TRUE),
              TX2 = sqrt(var(TX2, na.rm = TRUE))/mean(TX2, na.rm = TRUE),
              TX3 = sqrt(var(TX3, na.rm = TRUE))/mean(TX3, na.rm = TRUE)) %>%
    as_vector()

  ggcov1 <- pvdiv_plot_cov(cor_phe) + ggtitle(label = paste0(phe_hyp[i], "_", names(subpop_v2)[k]))
  ggcov <- list.prepend(ggcov, ggcov1)
  U_hyp <- list.prepend(U_hyp, cor_phe)
  names(U_hyp)[1] <- paste0(phe_hyp[i], "_", names(subpop_v2)[k])
  }
}

ggcov
```

# 2. Make mashr inputs for 8 GR50 phenotypes & run mash.

Some univariate GWAS for the Midwest had population structure issues. Mostly for greenup - even GR50 at MO was quite bad. Drop MO for GR50. Otherwise they look ok for FL50 and GR50.

## 2a. Gulf & Gulf&Midwest.

### mash inputs 
NB: Do this on server, where the large GWAS_datatable objects were created.
```{r}
library
k = 3 # subpop: G&M, M, Gulf
for(k in c(1, 3)){
phe_suffix <- paste("GR50", subpop_v[k], 
                    sep = "*.*")
snp <- snp_attach(inputfiles$SNPfiles[k])
gwas_rds <- pvdiv_results_in_folder(path = file.path(outputdir), 
                                      pattern = paste0("GWAS_datatable*.*",
                                                       phe_suffix))
phenotypes_1 <- str_sub(gwas_rds, start = 16, end = -42) %>%
    str_replace(., "_$", "")
phenotypes <- paste0(names(subpop_v)[k], "_", phenotypes_1)
numSNPs <- round(ceiling(1200000/length(phenotypes)^2)/1000)*1000
out1phe <- pvdiv_bigsnp2mashr(path = file.path(outputdir), 
                           snp = snp, gwas_rds = gwas_rds, 
                           phenotypes = phenotypes, numSNPs = numSNPs, 
                           clump = TRUE, scaled = TRUE, saveoutput = TRUE,
                           suffix = paste0("GR50_", names(subpop_v)[k]))
}
```

Use scp to move these output files (which all have the same suffix) to genegenie.

e.g. 
`scp -i Github/jls_alice alice@popgen.biosci.utexas.edu:~/Github/pvdiv-phenology-gxe/analysis/gwas/BLUPs/single_sites/*19000topSNPs_GR50_Midwest*  /home/alice/Github/pvdiv-phenology-gxe/analysis/gwas/BLUPs/single_sites/Midwest/`

`scp -i ~/Github/jls_alice alice@popgen.biosci.utexas.edu:~/Github/pvdiv-phenology-gxe/analysis/gwas/BLUPs/single_sites/Part-One-Output*  /home/alice/Github/pvdiv-phenology-gxe/analysis/gwas/BLUPs/single_sites/
`

### run mash 
```{r}
for(k in c(1, 3)){

  numSNPs <- 19000
  m_out <- mash_standard_run(path = file.path(outputdir, names(subpop_v)[k]),
                             numSNPs = numSNPs, 
                             U_hyp = U_hyp,
                             suffix = paste0("GR50_", names(subpop_v)[k]),
                             saveoutput = TRUE)
}

inputfiles
```


## 2b. Midwest, dropping some gardens.


# -----------------------------

# 3. Analyse mash output
## -- analysis outline --
•	How many SNP effects load onto each covariance matrix?
•	Mashhattans colored by covariance matrices.
•	What patterns do the data-driven matrices capture that our weather matrices don’t capture?
•	We characterized patterns of differential sensitivity and antagonistic pleiotropy between all SNPs and all pairs of gardens.
•	We looked for enrichments of genes that could potentially affect flowering in the 20kb genomic windows surrounding the SNPs with significant effects on flowering.
•	Rerun greenup mash and rewrite greenup mash section.




