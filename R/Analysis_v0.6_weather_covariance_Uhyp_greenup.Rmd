---
title: "Weather covariance matrices as U_hyp for GR50"
author: "Alice MacQueen"
date: 2021-01-05
output: html_document
---

# TRIAL script
# -------------------------
NB: Trial script on mash-env-cov branch to use weather covariance matrices as 
U_hyp in a mash run of GR50 phenotypes from 8 gardens.


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(bigsnpr)
library(switchgrassGWAS)
library(mashr)
library(rlist)
library(cowplot)
```

# Load project data

```{r load data}
source("~/Github/Functions_ggplot-theme-adjustments_2018-01-03.R")
workingdir <- file.path("~", "Github", "pvdiv-phenology-gxe")
outputdir <- file.path(workingdir, "analysis", "gwas", "BLUPs", "single_sites")
mashdir <- file.path(workingdir, "analysis", "mash")
metadata <- read_rds(file.path(workingdir, "data", "metadata.rds"))
# pvdiv PLANT_ID metadata
sites <- read_rds(file.path(workingdir, "data", "sites.rds"))
# pvdiv common garden metadata
subpops <- read_rds(file.path(workingdir, "data", "subpop_color_coding.rds"))
phe_gr_df <- read_rds(file.path(workingdir, "data",
                                "Weather_related_phe_for_asreml_h2_GR50.rds"))
# all greenup related phenotypes, including greenup as functions of weather variables.
phe_fl_df <- read_rds(file.path(workingdir, "data",
                                "Weather_related_phe_for_asreml_h2_FL50.rds"))
# all flowering related phenotypes, including functions of weather variables.
k_full <- read_rds(file.path(workingdir, "data",
                    "Kinship_van_Raden_630_individuals_SNPs_r2_20percent.rds"))
# kinship matrix for 630 tetraploid individuals.

## vectors with subsets of gardens, phenotypes, and genetic subpopulations.
site_v <- list(TX1 = "TX1", TX2 = "TX2", TX3 = "TX3", OK = "OK", MO = "MO",
               NE = "NE", MI = "MI", SD = "SD")#, eight_sites = c("TX1", "TX2", "TX3", "OK", "MO", "NE", "MI", "SD"), tx_sites = c("TX1", "TX2", "TX3"), north_sites = c("MO", "NE", "MI", "SD"))
subpop_v <- list(Gulf_and_Midwest = "363g_12.1M", Midwest = "134g_8.8M", 
                 Gulf = "229g_10.3M")
subpop_v2 <- list(Gulf_and_Midwest = c("Gulf", "Midwest"), Midwest = "Midwest", 
                 Gulf = "Gulf")
phe_single <- c("FL50", "dyln_fl50", "cgdd_12c_gr2fl", "crain_gr2fl",
               "crain_1d", "GR50", "cgdd_12c_10d")
phe_mult <- list(flowering_5 = c("FL50", "dyln_fl50", "cgdd_12c_gr2fl",
                                 "crain_gr2fl", "crain_1d"), 
                 greenup_2 = c("GR50", "cgdd_12c_10d"))
inputfiles <- read_delim(file.path(workingdir, "analysis", "gwas",
                                   "inputkinship.txt"),  delim = " ", 
                                   col_names = "SNPfiles") 
# paths to large SNP files
```

# 1. Weather U_hyp

Make weather corr/covar matrices 

1. Make dataframe of each env variable across all 8 sites
2. Compute correlations with pairwise complete observations
3. Change within-site covariance to coefficient of variation for each site. NB: mash does set the maximum of the diagonal to 1... hmm. I wonder why.

Do this for three pop subsets for 'cgdd_12c_10d' and maybe for 'cgdd_12c_18d' and 'cgdd_12c_5d'.

Function to plot covariance matrices to look at their differences
```{r pvdiv_plot_cov function}
pvdiv_plot_cov <- function(covdf){
  U1 <- covdf
  if(isSymmetric(U1)){
        for(i in 1:nrow(U1)){
          for(j in 1:ncol(U1)){
            if(i < j){
              U1[i, j] <- NA
            }
          }
        }
  }
  U1 <- as_tibble(U1, rownames = "rowU", .name_repair = "unique") %>%
          pivot_longer(cols = -.data$rowU, names_to = "colU",
                       values_to = "covar") %>%
          filter(!is.na(.data$covar))
  U1$colU <- factor(U1$colU, levels = colnames(covdf))
  U1$rowU <- factor(U1$rowU, levels = colnames(covdf))
  
  U1_covar <- U1 %>%
    ggplot(aes(x = .data$rowU, y = .data$colU)) +
    switchgrassGWAS::theme_oeco +
    geom_tile(aes(fill = .data$covar), na.rm = TRUE) +
    scale_fill_gradientn(colors = c("#440154FF", "#3B528BFF", "#2C728EFF",
                                    "white", "#27AD81FF", "#5DC863FF",
                                    "#FDE725FF"), limits = c(-1,1)) +
    geom_text(aes(label = round(.data$covar, 1)), color = "darkgrey") +
    theme(legend.position = c(0.2, 0.9),
          axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) +
    xlab("") + ylab("") 
  return(U1_covar)
}

```

## 1a. Make U_hyp

Specify in the phe_hyp vector which functions of weather I want to make U_hyp for mash.
```{r make u_hyp}
U_hyp <- list()
ggcov <- list()
phe_hyp <- c("GR50", "cgdd_12c_10d", "cgdd_12c_18d", "cgdd_12c_5d", "tave_10d")

for(i in seq_along(phe_hyp)){
  for(k in seq_along(subpop_v2)){
    
  cov_df <- phe_gr_df %>%
    ungroup() %>%
    left_join(select(sites, SITE, manu_site), by = "SITE") %>%
    filter(SUBPOP %in% subpop_v2[[k]]) %>%
    select(PLANT_ID, SUBPOP, manu_site, phe_hyp[i]) %>%
    group_by(PLANT_ID, SUBPOP, manu_site) %>%
    mutate(IND = row_number()) %>%
    pivot_wider(names_from = manu_site, values_from = phe_hyp[i]) %>%
    mutate(PLANT_ID = as.factor(PLANT_ID),
           IND = as.factor(IND)) %>%
    select(-IL) %>%
    select(PLANT_ID, SUBPOP, IND, MI, MO, NE, OK, SD, TX1, TX2, TX3)

  cor_phe <- cor(cov_df[,-(1:3)], use = "pairwise")
  diag(cor_phe) <- cov_df %>%
    ungroup() %>%
    summarise(MI = sqrt(var(MI, na.rm = TRUE))/mean(MI, na.rm = TRUE),
              MO = sqrt(var(MO, na.rm = TRUE))/mean(MO, na.rm = TRUE),
              NE = sqrt(var(NE, na.rm = TRUE))/mean(NE, na.rm = TRUE),
              OK = sqrt(var(OK, na.rm = TRUE))/mean(OK, na.rm = TRUE),
              SD = sqrt(var(SD, na.rm = TRUE))/mean(SD, na.rm = TRUE),
              TX1 = sqrt(var(TX1, na.rm = TRUE))/mean(TX1, na.rm = TRUE),
              TX2 = sqrt(var(TX2, na.rm = TRUE))/mean(TX2, na.rm = TRUE),
              TX3 = sqrt(var(TX3, na.rm = TRUE))/mean(TX3, na.rm = TRUE)) %>%
    as_vector()

  ggcov1 <- pvdiv_plot_cov(cor_phe) + ggtitle(label = paste0(phe_hyp[i], "_", names(subpop_v2)[k]))
  ggcov <- list.prepend(ggcov, ggcov1)
  U_hyp <- list.prepend(U_hyp, cor_phe)
  names(U_hyp)[1] <- paste0(phe_hyp[i], "_", names(subpop_v2)[k])
  }
}

# ggcov
ggcov
```

# 2. Make mashr inputs for 8 GR50 phenotypes & run mash.

Some univariate GWAS for the Midwest had population structure issues. Mostly for greenup - even GR50 at MO was quite bad. Drop MO for GR50. Otherwise they look ok for FL50 and GR50.

## 2a. Gulf & Gulf&Midwest.

### mash inputs 
NB: Do this on server, where the large GWAS_datatable objects were created.
```{r mash inputs with gulf}
library
k = 3 # subpop: G&M, M, Gulf
for(k in c(1, 3)){
phe_suffix <- paste("GR50", subpop_v[k], 
                    sep = "*.*")
snp <- snp_attach(inputfiles$SNPfiles[k])
gwas_rds <- pvdiv_results_in_folder(path = file.path(outputdir), 
                                      pattern = paste0("GWAS_datatable*.*",
                                                       phe_suffix))
phenotypes_1 <- str_sub(gwas_rds, start = 16, end = -42) %>%
    str_replace(., "_$", "")
phenotypes <- paste0(names(subpop_v)[k], "_", phenotypes_1)
numSNPs <- round(ceiling(1200000/length(phenotypes)^2)/1000)*1000
out1phe <- pvdiv_bigsnp2mashr(path = file.path(outputdir), 
                           snp = snp, gwas_rds = gwas_rds, 
                           phenotypes = phenotypes, numSNPs = numSNPs, 
                           clump = TRUE, scaled = TRUE, saveoutput = TRUE,
                           suffix = paste0("GR50_", names(subpop_v)[k]))
}
```

Use scp to move these output files (which all have the same suffix) to genegenie.

e.g. 
`scp -i Github/jls_alice alice@popgen.biosci.utexas.edu:~/Github/pvdiv-phenology-gxe/analysis/gwas/BLUPs/single_sites/*19000topSNPs_GR50_Midwest*  /home/alice/Github/pvdiv-phenology-gxe/analysis/gwas/BLUPs/single_sites/Midwest/`

`scp -i ~/Github/jls_alice alice@popgen.biosci.utexas.edu:~/Github/pvdiv-phenology-gxe/analysis/gwas/BLUPs/single_sites/Part-One-Output*  /home/alice/Github/pvdiv-phenology-gxe/analysis/gwas/BLUPs/single_sites/
`

Files with the six suffixes I have/want mash results for:
B_hat_strong_df_19000topSNPs_FL50_Gulf_and_Midwest.rds
B_hat_strong_df_19000topSNPs_FL50_Gulf.rds
B_hat_strong_df_19000topSNPs_GR50_Gulf_and_Midwest.rds
B_hat_strong_df_19000topSNPs_GR50_Gulf.rds
B_hat_strong_df_24000topSNPs_GR50_Midwest.rds
B_hat_strong_df_33000topSNPs_FL50_Midwest.rds


### run mash 

Ran mash using six 'nohup_v0.6' R scripts on the server 2021-01-12.


## 2b. Midwest, dropping gardens with zero values.
Midwest_GR50_SD have values of zero for Bhat and Shat. Drop this from Midwest analyses.
```{r check midwest}
mwdf <- readRDS(file.path(outputdir,
                          "B_hat_strong_df_19000topSNPs_GR50_Midwest.rds"))

summary(mwdf)
```


```{r mash midwest}
k=2
phe_suffix <- paste("GR50", subpop_v[k], 
                    sep = "*.*")
snp <- snp_attach(inputfiles$SNPfiles[k])
gwas_rds <- pvdiv_results_in_folder(path = file.path(outputdir), 
                                      pattern = paste0("GWAS_datatable*.*",
                                                       phe_suffix))
gwas_rds <- gwas_rds[c(1:4,6:8)]

phenotypes_1 <- str_sub(gwas_rds, start = 16, end = -41) %>%
    str_replace(., "_$", "")
phenotypes <- paste0(names(subpop_v)[k], "_", phenotypes_1)
numSNPs <- round(ceiling(1200000/length(phenotypes)^2)/1000)*1000
out1phe <- pvdiv_bigsnp2mashr(path = file.path(outputdir), 
                           snp = snp, gwas_rds = gwas_rds, 
                           phenotypes = phenotypes, numSNPs = numSNPs, 
                           clump = TRUE, scaled = TRUE, saveoutput = TRUE,
                           suffix = paste0("GR50_", names(subpop_v)[k]))
# Ran mash using a 'nohup_v0.6' R script.
```


# -----------------------------

# 3. Analyse mash output
## -- analysis outline 2020-01-12 --
•	3a What is the log likelihood of the mash models (x3) with and without U_hyp?
•	3b. How many SNP effects load onto each covariance matrix? What about SNP effects with log10BF > 2?
•	3c. Mashhattans colored by covariance matrices. Report (and plot/table) SNPs with log10BF > 2 and high loading (>0.5? 0.8?) onto one covar matrix.
  • Stress any Uhyp where the above is true and talk about candidate genes here. We have both an environmental driver and a small genomic interval here, these are of particular interest.
•	3d. We looked for enrichments of genes that could potentially affect greenup/flowering in the 20kb genomic windows surrounding the SNPs with significant effects on flowering. 
  •	Also, we looked at other metadata enrichments for these top SNPs.
•	3e. What patterns do the data-driven matrices capture that our weather matrices don’t capture?
•	3f. Finally, talk about overall SNP patterns seen in the phenotype: patterns of DS & AP.

## 3a. Log-likelihoods
```{r}
m_gulf_gr_hyp <- readRDS("~/Github/pvdiv-phenology-gxe/analysis/mash/Gulf/Strong_Effects_19000_SNPs_GR50_Gulf_Uhyp.rds")
m_gulf_gr_no <- readRDS("~/Github/pvdiv-phenology-gxe/analysis/mash/Gulf/Strong_Effects_19000_SNPs_GR50_Gulf_no_Uhyp.rds")
m_gulf_fl_hyp <- readRDS("~/Github/pvdiv-phenology-gxe/analysis/mash/Gulf/Strong_Effects_19000_SNPs_FL50_Gulf_Uhyp.rds")
m_gulf_fl_no <- readRDS("~/Github/pvdiv-phenology-gxe/analysis/mash/Gulf/Strong_Effects_19000_SNPs_FL50_Gulf_no_Uhyp.rds")

m_midw_gr_hyp <- readRDS("~/Github/pvdiv-phenology-gxe/analysis/mash/Midwest/Strong_Effects_24000_SNPs_GR50_Midwest_Uhyp.rds")
m_midw_gr_no <- readRDS("~/Github/pvdiv-phenology-gxe/analysis/mash/Midwest/Strong_Effects_24000_SNPs_GR50_Midwest_no_Uhyp.rds")  
m_midw_fl_hyp <- readRDS("~/Github/pvdiv-phenology-gxe/analysis/mash/Midwest/Strong_Effects_33000_SNPs_FL50_Midwest_Uhyp.rds")
m_midw_fl_no <- readRDS("~/Github/pvdiv-phenology-gxe/analysis/mash/Midwest/Strong_Effects_33000_SNPs_FL50_Midwest_no_Uhyp.rds")

m_gam_gr_hyp <- readRDS("~/Github/pvdiv-phenology-gxe/analysis/mash/Gulf_and_Midwest/Strong_Effects_19000_SNPs_GR50_Gulf_and_Midwest_Uhyp.rds")
m_gam_gr_no <- readRDS("~/Github/pvdiv-phenology-gxe/analysis/mash/Gulf_and_Midwest/Strong_Effects_19000_SNPs_GR50_Gulf_and_Midwest_no_Uhyp.rds")
m_gam_fl_hyp <- readRDS("~/Github/pvdiv-phenology-gxe/analysis/mash/Gulf_and_Midwest/Strong_Effects_19000_SNPs_FL50_Gulf_and_Midwest_Uhyp.rds")
m_gam_fl_no <- readRDS("~/Github/pvdiv-phenology-gxe/analysis/mash/Gulf_and_Midwest/Strong_Effects_19000_SNPs_FL50_Gulf_and_Midwest_no_Uhyp.rds")
```

```{r}
m_gulf_gr_hyp$loglik
m_gulf_gr_no$loglik
m_gulf_fl_hyp$loglik
m_gulf_fl_no$loglik

-2*(m_gulf_gr_no$loglik - m_gulf_gr_hyp$loglik) # negative
-2*(m_gulf_fl_no$loglik - m_gulf_fl_hyp$loglik) # positive
# test statistic equal to twice the absolute difference in these log likelihoods is assumed to be distributed as Chi square with one degree of freedom. Larger positive statistics are more significant.
1 - pchisq(-2*(m_gulf_fl_no$loglik - m_gulf_fl_hyp$loglik), 30) #sig
1 - pchisq(-2*(m_gulf_gr_no$loglik - m_gulf_gr_hyp$loglik), 15)
# I don't know how many df each covariance matrix (each Uhyp) would take. At least one per added Uhyp? Up to (ncond*ncond)/2 per added Uhyp? What do they do in the mash paper?


-2*(m_midw_gr_no$loglik - m_midw_gr_hyp$loglik) # positive
-2*(m_midw_fl_no$loglik - m_midw_fl_hyp$loglik) # v. negative 
1 - pchisq(-2*(m_midw_fl_no$loglik - m_midw_fl_hyp$loglik), 30*36)
1 - pchisq(-2*(m_midw_gr_no$loglik - m_midw_gr_hyp$loglik), 15*36) # sig


-2*(m_gam_gr_no$loglik - m_gam_gr_hyp$loglik)  # positive
-2*(m_gam_fl_no$loglik - m_gam_fl_hyp$loglik) # v. positive
1 - pchisq(-2*(m_gam_fl_no$loglik - m_gam_fl_hyp$loglik), 30*36) # sig
1 - pchisq(-2*(m_gam_gr_no$loglik - m_gam_gr_hyp$loglik), 15*36) # sig


1-pchisq(0.0279,1) # LR -2(L0 - L1) gives LR of 0.0279 which gives p of 0.87
1-pchisq((6.89), 1) # LR of 6.89 gives p of ~0.01
8+7+6+5+4+3+2+1
```

A test using the log-likelihood

For the MLR estimator there is an additional test for nested models. This test compares the log-likelihoods for the null and alternative models rather than the chi-square values. Below is a list of the information needed, along with the symbol (i.e., letter and number) used to represent each value.

L0 = log-likelihood for the null model.
L1 = log-likelihood for the alternative model.

c0 = scaling correction factor for the null model.
c1 = scaling correction factor for the alternative model.

p0 = number of parameters estimated in the null model.
p1 = number of parameters estimated in the alternative model.

From this information the tests statistic TRd can be calculated (note that cd is calculated first then used to calculate TRd), along with the degrees of freedom:

cd = (p0*c0-p1*c1)/(p0-p1)
TRd = -2*(L0-L1)/cd
df = p1-p0


## 3b. Covar Loadings
How many SNP effects load onto each covariance matrix?

```{r}
cov_gg <- mash_plot_covar(m_gulf_gr_hyp)
cov_gf <- mash_plot_covar(m_gulf_fl_hyp)

cov_mg <- mash_plot_covar(m_midw_gr_hyp)
cov_mf <- mash_plot_covar(m_midw_fl_hyp)

cov_gamg <- mash_plot_covar(m_gam_gr_hyp)
cov_gamf <- mash_plot_covar(m_gam_fl_hyp)

cov_gg$ggobject + 
  ggtitle("Gulf greenup", subtitle = "8.4% SNP mass")
cov_gf$ggobject + 
  ggtitle("Gulf flowering", subtitle = "31.8% SNP mass")
cov_mg$ggobject + 
  ggtitle("Midwest greenup", subtitle = "28.6% SNP mass")
cov_mf$ggobject + 
  ggtitle("Midwest flowering", subtitle = "45.1% SNP mass")
cov_gamg$ggobject + 
  ggtitle("Gulf and Midwest greenup", subtitle = "8.5% SNP mass")
cov_gamf$ggobject + 
  ggtitle("Gulf and Midwest flowering", subtitle = "47.3% SNP mass")
```
47.3% of effect mass for both subpop flowering was on hyp matrices, while only 8.5% of greenup was.
Gulf greenup: 8.4%  flowering: 31.8%
Midwest greenup: 28.6% flowering 45.1%
```{r}
5.127744e-02/4.037520e-01
```


```{r}
get_cov_type <- function(m, summarise = FALSE, subpop = FALSE){
  cov_df <- mash_plot_covar(m)
  if (subpop == FALSE) {
  cov_type <- cov_df$covar_df %>% 
    mutate(Type = case_when(grepl("ED_", `Covariance Matrix`) ~ "data-driven",
                            grepl("single_effect", `Covariance Matrix`) ~
                              "canonical",
                            grepl("simple_het", `Covariance Matrix`) ~
                              "canonical",
                            grepl("no_effects", `Covariance Matrix`) ~
                              "canonical",
                            grepl("identity", `Covariance Matrix`) ~
                              "canonical",
                            grepl("equal_effects", `Covariance Matrix`) ~
                              "canonical",
                            grepl("_and_Midwest$", `Covariance Matrix`) ~
                              "hypothesized",
                            grepl("Midwest$", `Covariance Matrix`) ~ "hypothesized",
                            grepl("Gulf$", `Covariance Matrix`) ~ "hypothesized",
                            TRUE ~ "other"
                            )) 
  } else {
    cov_type <- cov_df$covar_df %>% 
      mutate(Type = case_when(grepl("ED_", `Covariance Matrix`) ~
                                "data-driven",
                              grepl("single_effect", `Covariance Matrix`) ~
                                "canonical",
                              grepl("simple_het", `Covariance Matrix`) ~
                                "canonical",
                              grepl("no_effects", `Covariance Matrix`) ~
                                "canonical",
                              grepl("identity", `Covariance Matrix`) ~
                                "canonical",
                              grepl("equal_effects", `Covariance Matrix`) ~
                                "canonical",
                              grepl("_and_Midwest$", `Covariance Matrix`) ~
                                "GAM_hyp",
                              grepl("Midwest$", `Covariance Matrix`) ~
                                "Midw_hyp",
                              grepl("Gulf$", `Covariance Matrix`) ~ "Gulf_hyp",
                              TRUE ~ "other"
                              )) 
  }
  if (summarise == TRUE) {
    cov_type <- cov_type %>%
      group_by(Type) %>%
      summarise(Mass = sum(Mass))
  }
  return(cov_type)
}

get_cov_type(m_gulf_gr_hyp, summarise = TRUE, subpop = TRUE)
get_cov_type(m_gulf_fl_hyp, summarise = TRUE, subpop = TRUE)
get_cov_type(m_midw_gr_hyp, summarise = TRUE, subpop = TRUE)
get_cov_type(m_midw_fl_hyp, summarise = TRUE, subpop = TRUE)
get_cov_type(m_gam_gr_hyp, summarise = TRUE, subpop = TRUE)
get_cov_type(m_gam_fl_hyp, summarise = TRUE, subpop = TRUE)
```


```{r}
get_U_by_mass(m_gulf_gr_hyp,thresh = 0.01)
cov_gr1 <- mash_plot_Ulist(m_gulf_gr_hyp, range = 18, limits = TRUE)
cov_gr2 <- mash_plot_Ulist(m_gam_gr_hyp, 13, limits = TRUE)

fig_eqeff <- cov_gr1$equal_effects_df %>%
  ggplot(aes(x = .data$rowU, y = .data$colU)) +
  switchgrassGWAS::theme_oeco +
  geom_tile(aes(fill = .data$covar), na.rm = TRUE) +
  scale_fill_gradientn(colors = c("#440154FF", "#3B528BFF", "#2C728EFF",
                                "white", "#27AD81FF", "#5DC863FF",
                                "#FDE725FF"),
                       limits = c(-1, 1)) +
  theme(legend.position = "none",
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.line.x = element_blank(),
        axis.line.y = element_blank(),
        axis.title.y.right = element_text()) +
  labs(x = "", y = "", subtitle = "equal_effects")

fig_ok_eff <- cov_gr2$Stand_BhatGulf_and_Midwest_GR50_OK_df %>%
  ggplot(aes(x = .data$rowU, y = .data$colU)) +
  switchgrassGWAS::theme_oeco +
  geom_tile(aes(fill = .data$covar), na.rm = TRUE) +
  scale_fill_gradientn(colors = c("#440154FF", "#3B528BFF", "#2C728EFF",
                                "white", "#27AD81FF", "#5DC863FF",
                                "#FDE725FF"),
                       limits = c(-1, 1)) +
  theme(legend.position = "none",
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.line.x = element_blank(),
        axis.line.y = element_blank()) +
  xlab("") + ylab("") + ggtitle("single_effect_OK")
```


```{r second try making covar examples}
phe_hyp <- c("tave_10d", "tave_18d", "dyln_fl50", "cgdd_12c_gr2fl")

for(i in seq_along(phe_hyp)){
  for(k in seq_along(subpop_v2)){
    
    if (i %in% c(1,2)) {
      cov_df <- phe_gr_df %>%
        ungroup() %>%
        left_join(select(sites, SITE, manu_site), by = "SITE") %>%
        filter(SUBPOP %in% subpop_v2[[k]]) %>%
        select(PLANT_ID, SUBPOP, manu_site, phe_hyp[i]) %>%
        group_by(PLANT_ID, SUBPOP, manu_site) %>%
        mutate(IND = row_number()) %>%
        pivot_wider(names_from = manu_site, values_from = phe_hyp[i]) %>%
        mutate(PLANT_ID = as.factor(PLANT_ID),
               IND = as.factor(IND)) %>%
        select(-IL) %>%
        select(PLANT_ID, SUBPOP, IND, TX1, TX2, TX3, OK, MO, NE, MI, SD)
    } else {
      cov_df <- phe_fl_df %>%
        ungroup() %>%
        left_join(select(sites, SITE, manu_site), by = "SITE") %>%
        filter(SUBPOP %in% subpop_v2[[k]]) %>%
        select(PLANT_ID, SUBPOP, manu_site, phe_hyp[i]) %>%
        group_by(PLANT_ID, SUBPOP, manu_site) %>%
        mutate(IND = row_number()) %>%
        pivot_wider(names_from = manu_site, values_from = phe_hyp[i]) %>%
        mutate(PLANT_ID = as.factor(PLANT_ID),
               IND = as.factor(IND)) %>%
        select(-IL) %>%
        select(PLANT_ID, SUBPOP, IND, TX1, TX2, TX3, OK, MO, NE, MI, SD)
    }

  cor_phe <- cor(cov_df[,-(1:3)], use = "pairwise")
  diag(cor_phe) <- cov_df %>%
    ungroup() %>%
    summarise(TX1 = sqrt(var(TX1, na.rm = TRUE))/mean(TX1, na.rm = TRUE),
              TX2 = sqrt(var(TX2, na.rm = TRUE))/mean(TX2, na.rm = TRUE),
              TX3 = sqrt(var(TX3, na.rm = TRUE))/mean(TX3, na.rm = TRUE),
              OK = sqrt(var(OK, na.rm = TRUE))/mean(OK, na.rm = TRUE),
              MO = sqrt(var(MO, na.rm = TRUE))/mean(MO, na.rm = TRUE),
              NE = sqrt(var(NE, na.rm = TRUE))/mean(NE, na.rm = TRUE),
              MI = sqrt(var(MI, na.rm = TRUE))/mean(MI, na.rm = TRUE),
              SD = sqrt(var(SD, na.rm = TRUE))/mean(SD, na.rm = TRUE)) %>%
    as_vector()

  if(isSymmetric(cor_phe)){
        for(m in 1:nrow(cor_phe)){
          for(j in 1:ncol(cor_phe)){
            if(m < j){
              cor_phe[m, j] <- NA
            }
          }
        }
    }
  U1 <- as_tibble(cor_phe, rownames = "rowU", .name_repair = "unique") %>%
          pivot_longer(cols = -.data$rowU, names_to = "colU",
                       values_to = "covar") %>%
          filter(!is.na(.data$covar))
  U1$colU <- factor(U1$colU, levels = colnames(cor_phe))
  U1$rowU <- factor(U1$rowU, levels = colnames(cor_phe))
  U1 <- U1 %>%
    mutate(phe = phe_hyp[i],
           subpop = names(subpop_v2)[k],
           subpop = case_when(subpop == "Gulf_and_Midwest" ~ "Both",
                              TRUE ~ subpop))
  
  if(i == 1 & k == 1){
    cov_flex <- U1
  } else {
    cov_flex <- cov_flex %>%
      full_join(U1)
  }
    }
}

cov_flex$phe <- factor(cov_flex$phe, levels = c("tave_18d", "tave_10d", "dyln_fl50", "cgdd_12c_gr2fl"))
cov_flex$subpop <- factor(cov_flex$subpop, levels = c("Gulf", "Midwest", "Both)"))

figure2_a <- cov_flex %>%
  filter(phe %in% c("tave_10d", "tave_18d")) %>%
  ggplot(aes(x = .data$rowU, y = .data$colU)) +
  switchgrassGWAS::theme_oeco +
  geom_tile(aes(fill = .data$covar), na.rm = TRUE) +
  scale_fill_gradientn(colors = c("#440154FF", "#3B528BFF", "#2C728EFF",
                                "white", "#27AD81FF", "#5DC863FF",
                                "#FDE725FF"),
                       limits = c(-1, 1)) +
  #geom_text(aes(label = round(.data$covar, 1)), color = "darkgrey") +
  facet_grid(rows = vars(phe), cols = vars(subpop)) + 
  theme(legend.position = "right",
        #axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.line.x = element_blank(),
        axis.line.y = element_blank(),
        panel.spacing.x = unit(-0, 'cm')) +
  xlab("") + ylab("")

legend <- get_legend(figure2_a)  
figure2_a <- cov_flex %>%
  filter(phe %in% c("tave_10d", "tave_18d")) %>%
  ggplot(aes(x = .data$rowU, y = .data$colU)) +
  switchgrassGWAS::theme_oeco +
  geom_tile(aes(fill = .data$covar), na.rm = TRUE) +
  scale_fill_gradientn(colors = c("#440154FF", "#3B528BFF", "#2C728EFF",
                                "white", "#27AD81FF", "#5DC863FF",
                                "#FDE725FF"),
                       limits = c(-1, 1)) +
  #geom_text(aes(label = round(.data$covar, 1)), color = "darkgrey") +
  facet_grid(rows = vars(phe), cols = vars(subpop)) + 
  theme(legend.position = "none",
        #axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.line.x = element_blank(),
        axis.line.y = element_blank(),
        panel.spacing.x = unit(-0, 'cm')) +
  xlab("") + ylab("")

figure2_d <- cov_flex %>%
  filter(phe %in% c("cgdd_12c_gr2fl", "dyln_fl50")) %>%
  ggplot(aes(x = .data$rowU, y = .data$colU)) +
  switchgrassGWAS::theme_oeco +
  geom_tile(aes(fill = .data$covar), na.rm = TRUE) +
  scale_fill_gradientn(colors = c("#440154FF", "#3B528BFF", "#2C728EFF",
                                "white", "#27AD81FF", "#5DC863FF",
                                "#FDE725FF"),
                       limits = c(-1, 1)) +
  #geom_text(aes(label = round(.data$covar, 1)), color = "darkgrey") +
  facet_grid(rows = vars(phe), cols = vars(subpop)) + 
  theme(legend.position = "none",
        #axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.line.x = element_blank(),
        axis.line.y = element_blank(),
        panel.spacing.x = unit(-0, 'cm')) +
  xlab("") + ylab("")
```


```{r make rough draft figure 2}
df_2a <- get_cov_type(m_gulf_gr_hyp, summarise = TRUE) %>%
  mutate(subpop = "Gulf",
         phenotype = "greenup")
df_2b <- get_cov_type(m_midw_gr_hyp, summarise = TRUE) %>%
  mutate(subpop = "Midwest",
         phenotype = "greenup")
df_2c <- get_cov_type(m_gam_gr_hyp, summarise = TRUE) %>%
  mutate(subpop = "Both",
         phenotype = "greenup")
df_2d <- get_cov_type(m_gulf_fl_hyp, summarise = TRUE) %>%
  mutate(subpop = "Gulf",
         phenotype = "flowering")
df_2e <- get_cov_type(m_midw_fl_hyp, summarise = TRUE) %>%
  mutate(subpop = "Midwest",
         phenotype = "flowering")
df_2f <- get_cov_type(m_gam_fl_hyp, summarise = TRUE) %>%
  mutate(subpop = "Both",
         phenotype = "flowering")
df_2gr_b <- df_2a %>% full_join(df_2b) %>% full_join(df_2c)
df_2fl_b <- df_2d %>% full_join(df_2e) %>% full_join(df_2f)

df_2a <- get_cov_type(m_gulf_gr_hyp) %>%
  mutate(subpop = "Gulf",
         phenotype = "greenup")
df_2b <- get_cov_type(m_midw_gr_hyp) %>%
  mutate(subpop = "Midwest",
         phenotype = "greenup")
df_2c <- get_cov_type(m_gam_gr_hyp) %>%
  mutate(subpop = "Both",
         phenotype = "greenup")
df_2d <- get_cov_type(m_gulf_fl_hyp) %>%
  mutate(subpop = "Gulf",
         phenotype = "flowering")
df_2e <- get_cov_type(m_midw_fl_hyp) %>%
  mutate(subpop = "Midwest",
         phenotype = "flowering")
df_2f <- get_cov_type(m_gam_fl_hyp) %>%
  mutate(subpop = "Both",
         phenotype = "flowering")
df_2gr_a <- df_2a %>% full_join(df_2b) %>% full_join(df_2c) %>%
  mutate(`Covariance Matrix` = str_replace(`Covariance Matrix`, "single_effect_Gulf_and_Midwest_", "single_effect_"),
         `Covariance Matrix` = str_replace(`Covariance Matrix`, "single_effect_Midwest_", "single_effect_"),
         `Covariance Matrix` = str_replace(`Covariance Matrix`, "single_effect_Gulf_", "single_effect_")
         )
df_2fl_a <- df_2d %>% full_join(df_2e) %>% full_join(df_2f) %>%
  mutate(`Covariance Matrix` = str_replace(`Covariance Matrix`, "single_effect_Gulf_and_Midwest_", "single_effect_"),
         `Covariance Matrix` = str_replace(`Covariance Matrix`, "single_effect_Midwest_", "single_effect_"),
         `Covariance Matrix` = str_replace(`Covariance Matrix`, "single_effect_Gulf_", "single_effect_")
         )

df_2gr_b$subpop <- factor(df_2gr_b$subpop, levels = c("Gulf", "Midwest", "Both"))
df_2fl_b$subpop <- factor(df_2fl_b$subpop, levels = c("Gulf", "Midwest", "Both"))
df_2gr_a$subpop <- factor(df_2gr_a$subpop, levels = c("Gulf", "Midwest", "Both"))
df_2fl_a$subpop <- factor(df_2fl_a$subpop, levels = c("Gulf", "Midwest", "Both"))

f2b <- df_2gr_b %>%
  filter(Mass > 1e-05) %>%
  ggplot(aes(x = subpop, y = Mass)) + 
  geom_bar(aes(fill = Type), stat = "identity") +
  scale_fill_viridis_d(end = 0.9) +
  theme(axis.title.x=element_blank(),
        legend.position = "none",
        axis.text.x=element_text(hjust = 1, vjust = 1, angle = 45))
f2d <- df_2fl_b %>%
  filter(Mass > 1e-05) %>%
  ggplot(aes(x = subpop, y = Mass)) + 
  geom_bar(aes(fill = Type), stat = "identity") +
  scale_fill_viridis_d(end = 0.9) +
  theme(axis.title.x=element_blank(),
        legend.position = "none",
        axis.text.x=element_text(hjust = 1, vjust = 1, angle = 45))
f2a <- df_2gr_a %>%
  filter(Mass > 1e-06) %>%
  ggplot(aes(x = `Covariance Matrix`, y = Mass)) + 
  geom_bar(aes(fill = Type), stat = "identity") +
  facet_wrap(~subpop) +
  coord_flip() + scale_fill_viridis_d(end = 0.9) +
  theme(legend.position = c(-0.4, 0.3),
        axis.text.x=element_text(hjust = 1, vjust = 1, angle = 45), 
        panel.spacing.x = unit(-0, 'cm')) #+ labs(x = "")
f2c <- df_2fl_a %>%
  filter(Mass > 1e-06) %>%
  ggplot(aes(x = `Covariance Matrix`, y = Mass)) + 
  geom_bar(aes(fill = Type), stat = "identity") +
  facet_wrap(~subpop) +
  coord_flip() + scale_fill_viridis_d(end = 0.9) +
  theme(legend.position = "none",
        axis.text.x=element_text(hjust = 1, vjust = 1, angle = 45), 
        panel.spacing.x = unit(-0, 'cm')) #+ labs(x = "")


fig2 <- plot_grid(f2a, f2b, f2c, f2d, nrow = 2, rel_widths = c(0.75, 0.25), rel_heights = c(0.53, 0.47))
save_plot("../manuscript/plots/Figure_2_mash_covariance_masses.png", base_height = 8, base_width = 7, plot = fig2)
```
47.3% of effect mass for both subpop flowering was on hyp matrices, while only 8.5% of greenup was.
Gulf greenup: 8.4%  flowering: 31.8%
Midwest greenup: 28.6% flowering 45.1%

```{r}
ggdraw() +
  draw_plot(figure2_a, x = -.02, y = 0.51, width = 0.32, height = 0.35) +
  draw_plot(fig_eqeff, x = 0.02, y = 0.35, width = 0.125, height = 0.2) +
  draw_plot(figure2_d, x = -.02, y = 0.03, width = 0.32, height = 0.35) +
  draw_plot(f2a, x = 0.3, y = 0.47, width = 0.55, height = 0.53) +
  draw_plot(legend, x = 0.15, y = 0.34, width = 0.1, height = 0.2) +
  draw_plot(f2b, x = 0.85, y = 0.47, width = 0.15, height = 0.53) +
  draw_plot(f2c, x = 0.3, y = 0, width = 0.55, height = 0.47) +
  draw_plot(f2d, x = 0.85, y = 0, width = 0.15, height = 0.47)

save_plot(filename = "../manuscript/plots/Figure_2_Covariance_matrices_and_posterior_weights.svg", plot = last_plot(), base_height = 8, base_width = 9)
```


44765 SNPs tested for G&M, 45931 SNPs tested for Gulf.


### ii. Gulf
```{r gulf mash results}
length(get_significant_results(m_gulf_gr_hyp))  # 9645/45931  # 20.999%
length(get_significant_results(m_gulf_gr_no))   # 10427/45931 # 22.7%
get_significant_results(m_gulf_gr_hyp)[1:10]

get_U_by_mass(m_gulf_gr_hyp)
mash_plot_Ulist(m_gulf_gr_hyp, range = get_U_by_mass(m_gulf_gr_hyp), limits = FALSE)
mash_plot_manhattan_by_condition(m_gulf_gr_hyp, saveoutput = FALSE)
mash_plot_sig_by_condition(m_gulf_gr_hyp, saveoutput = FALSE)
```

### ii. G&M
```{r gulf and midwest mash results}
length(get_significant_results(m_gam_gr_hyp))  # 15786/44765  # 35.26
length(get_significant_results(m_gam_gr_no))  # 15873/44765  # 35.46%
get_significant_results(m_gam_gr_hyp)[1:10]

get_U_by_mass(m_gam_gr_hyp)
mash_plot_Ulist(m_gam_gr_hyp, range = get_U_by_mass(m_gam_gr_hyp), limits = FALSE)
mash_plot_manhattan_by_condition(m_gam_fl_hyp, saveoutput = FALSE)
mash_plot_sig_by_condition(m_gam_fl_hyp, saveoutput = FALSE)
```

Not stunning, especially compared to how the flowering hyp do.

## 3c.	Mashhattans 
Mashhattans colored by covariance matrices.

### ii. Functions for posterior weights

Get posterior weight dataframe for the covariance matrix grid. Per SNP/row, entries in this grid sum to 1.

Get log10BayesFactor for mash SNPs also and combine these into a dataframe for ggplot.
```{r mashhattan plot setup}
get_post_weights <- function(m){
  log10bf_df <- switchgrassGWAS:::get_log10bf(m = m) %>%
      as.data.frame() %>%
      rownames_to_column(var = "value") %>%
      mutate(value = as.integer(.data$value)) %>%
      as_tibble() %>%
      left_join(switchgrassGWAS:::get_marker_df(m = m), by = "value") %>%
      dplyr::rename(log10BayesFactor = .data$V1) %>%
      dplyr::select(-.data$value)
  
  pw_df <- as_tibble(m$posterior_weights)
  pw_df <- switchgrassGWAS:::get_marker_df(m = m) %>%
    bind_cols(pw_df)
  
  ggman_df <- pw_df %>%
    #left_join(m_meta) %>%
    separate(.data$Marker, into = c("Chr", "Pos"), remove = FALSE, sep = "_",
             extra = "merge", convert = TRUE) %>%
    left_join(log10bf_df, by = "Marker") %>%
    arrange(.data$Chr, .data$Pos) 
  return(ggman_df)
}

pw_gg <- get_post_weights(m_gulf_gr_hyp)
pw_gf <- get_post_weights(m_gulf_fl_hyp)

pw_mg <- get_post_weights(m_midw_gr_hyp)
pw_mf <- get_post_weights(m_midw_fl_hyp)

pw_gamg <- get_post_weights(m_gam_gr_hyp)
pw_gamf <- get_post_weights(m_gam_fl_hyp)


get_pw_filtered <- function(m, pw_thresh = 0.5, BF_thresh = 2){
  ggman_df <- get_post_weights(m)
  var <- names(ggman_df)[ncol(ggman_df)-1]  
  pw_summary <- ggman_df %>%
    pivot_longer(cols = null:var, names_to = "covar_grid", 
                 values_to = "loading") %>%
    filter(log10BayesFactor > BF_thresh) %>%
    group_by(covar_grid, loading > pw_thresh) %>%
    tally()
return(pw_summary)
}


get_pw_filtered(m_midw_fl_hyp, pw_thresh = 0.1, BF_thresh = 2) %>% 
  mutate(Type = case_when(grepl("ED_", covar_grid) ~ "data-driven",
                          grepl("Stand", covar_grid) ~ "canonical",
                          grepl("simple_het", covar_grid) ~ "canonical",
                          grepl("null", covar_grid) ~ "canonical",
                          grepl("identity", covar_grid) ~ "canonical",
                          grepl("equal_effects", covar_grid) ~ "canonical",
                          grepl("_and_Midwest", covar_grid) ~ "hyp",
                          grepl("Midwest", covar_grid) ~ "hyp",
                          grepl("Gulf", covar_grid) ~ "hyp",
                          TRUE ~ "other"
                          ))

get_significant_results(m_gulf_gr_hyp)[1:10]

```
Not many SNPs with U_hyp loading > 10% and SNP with log10BF > 2:
Both GR: 10 & 9 SNPs   cgdd_12c_18d_Gulf_and_Midwest x2 (0.9 and 0.10)
Both FL: 2 SNPs        dyln_change_sec_Midwest.7

Gulf FL: 0 SNPs
Gulf GR: 11 & 2 SNPs   cgdd_12c_18d_Gulf_and_Midwest.10 & tave_18d_Gulf_and_Midwest.6

Midw GR: 0 SNPs
Midw FL: 11 SNPs       cgdd_12c_gr2fl_Gulf_and_Midwest.8

### iii. Plot setup
Make a list containing all of the ggplots for all entries in the covariance grid represented by `pw_df`.
Then view all the ggplots in gglist.
```{r mashhattan plots loop}
pw_df <- pw_mf

gglist <- list()
log10BF <- expression(paste("log"[10], plain("(Bayes Factor)")))
for(i in seq_along(names(pw_df)[-(1:5)])){
  var <- names(pw_df)[i+4]  
  gglist[[i]] <- pw_df %>%
    arrange(!! sym(var)) %>%
    filter(!! sym(var) > 0.01) %>%
    ggplot(aes(x = .data$Pos, y = .data$log10BayesFactor)) +
    switchgrassGWAS::theme_oeco +
    geom_point(aes(color = !! sym(var), fill = !! sym(var),
                   shape = as.factor(.data$Chr))) +
    facet_wrap(~ .data$Chr, nrow = 1, scales = "free_x", 
               strip.position = "bottom") +
    scale_color_viridis_c(option = "D", end = 0.95) + 
    scale_fill_viridis_c(option = "D", end = 0.95) +
    theme(strip.text = element_text(size = 8),
          axis.text.y = element_text(size = 8),
          axis.text.x = element_blank(),
          legend.text = element_text(size = 8),
          axis.ticks.x = element_blank(),
          panel.background = element_rect(fill=NA)) +
    labs(x = "Chromosome", y = log10BF) +
    scale_x_continuous(expand = c(0.32, 0.32)) +
    scale_shape_manual(values = rep(c(21,22),9), guide = FALSE) +
    geom_hline(yintercept = 2, linetype = 2) +
    ggtitle(var)
}
ggdoe1 <- gglist[[6]] + ggtitle("SNPs in the Midwest subpopulation that covary strongly with cumulative GDD")
save_plot(filename = "../manuscript/plots/Mashhattan_covar_Midwest_flowering_cgdd.png", base_width = 9, plot = ggdoe1)
ggdoe2 <- gglist[[9]] + ggtitle("SNPs in the Midwest subpopulation with equal effects at all gardens")
save_plot(filename = "../manuscript/plots/Mashhattan_covar_Midwest_flowering_equal_effects.png", base_width = 9, plot = ggdoe2)
```

# -----------
## 3d. Enrichments
•	3d. We looked for enrichments of genes that could potentially affect greenup/flowering in the 20kb genomic windows surrounding the SNPs with significant effects on flowering. 
  •	Also, we looked at other metadata enrichments for these top SNPs.

mashdir is "~/Github/pvdiv-phenology-gxe/analysis/mash/", then there are three subpop-specific directories within that.

### Rice/thaliana FT

anno_df: All are above a 10% FDR. If there are more than 500 SNPs above the FDR, only returns the top 500 by p value. Only gets the closest gene to each SNP. Should be three site sets and three subpop sets, several (four?) flowering phenotypes.

os_annos: OsGene and AtGene columns of this df indicate if the gene has a homolog in rice or A. thaliana with a functional study. Key is the locusName column.
```{r}
source("~/Github/Functions_ggplot-theme-adjustments_2018-01-03.R")
workingdir <- file.path("~", "Github", "pvdiv-phenology-gxe")
ftanno <- read_csv(file.path(workingdir, "data/Pvirgatum_v5.1.annotation_FTGeneHomologs.csv"))
ftkey <- read_delim(file.path(workingdir, "data", "OsGene_keyword_table.txt"),
                    delim = "\t")
ftanno %>%
  filter(!is.na(OsGene)) %>%
  left_join(ftkey, by = c("OsGene" = "Symbol")) %>%
  filter(Keyword %in% c("flowering time", "heading date")) %>% unique()

osgene_keyword_df <- ftkey %>%
  dplyr::select(-RAPdb, -MSU) %>%
  group_by(Symbol, Keyword) %>%
  dplyr::slice(1) %>%
  pivot_wider(names_from = Keyword, values_from = Title)

osgene_key <- osgene_keyword_df %>%
  dplyr::select(Symbol, `flowering time`, `heading date`, anther, flower,
                `floral meristem`, `floral meristem determinacy`, flowering,
                `flower development`, `carpel differentiation`, stamen, 
                `stamen number`, everything()) %>%
  pivot_longer(cols = -Symbol, names_to = "Keyword", values_to = "Title") %>%
  filter(!is.na(Title)) %>%
  pivot_wider(names_from = Keyword, values_from = Title)

os_annos <- ftanno %>%
  filter(OsGene %in% osgene_key$Symbol | !is.na(AtGene)) %>%
  mutate(Pos_Mb = round(start/10000)/100,
         #Pos_Mb_e = floor(start/10000)/100,
         POS_bin = round(Pos_Mb*100/2)) %>%# ,
         #POS_bin_hi = round(Pos_Mb_e*100/2))
  dplyr::select(OsGene, AtGene, locusName, everything()) %>%
  dplyr::rename(`Gene ID` = locusName)
1599 / 83260
```

# Annotations with rice/thaliana functional annotation papers for specific SNPs

```{r function}
library(AnnotationDbi)
not_all_na <- function(x) any(!is.na(x))
txdb <- loadDb("~/Github/pvdiv-genome/Pvirgatum_516_v5.1.gene.txdb.sqlite")

get_post_weights <- function(m){
  log10bf_df <- switchgrassGWAS:::get_log10bf(m = m) %>%
      as.data.frame() %>%
      rownames_to_column(var = "value") %>%
      mutate(value = as.integer(.data$value)) %>%
      as_tibble() %>%
      left_join(switchgrassGWAS:::get_marker_df(m = m), by = "value") %>%
      dplyr::rename(log10BayesFactor = .data$V1) %>%
      dplyr::select(-.data$value)
  
  pw_df <- as_tibble(m$posterior_weights)
  pw_df <- switchgrassGWAS:::get_marker_df(m = m) %>%
    bind_cols(pw_df)
  
  ggman_df <- pw_df %>%
    #left_join(m_meta) %>%
    separate(.data$Marker, into = c("Chr", "Pos"), remove = FALSE, sep = "_",
             extra = "merge", convert = TRUE) %>%
    left_join(log10bf_df, by = "Marker") %>%
    arrange(.data$Chr, .data$Pos) 
  return(ggman_df)
}

get_post_annos <- function(m, region_size = 20000, BFthresh = 2){
  pw_df <- get_post_weights(m)
  pw_annos <- pw_df %>%
    filter(log10BayesFactor > BFthresh) %>%
    mutate(CHR = Chr,
           start = Pos - (region_size/2),
           end = Pos + (region_size/2)) %>%
    pvdiv_table_topsnps(., type = "table", txdb = txdb) %>%
    inner_join(os_annos, by = c("Gene ID")) %>%
    left_join(osgene_key, by = c("OsGene" = "Symbol")) %>%
    dplyr::select(where(not_all_na)) %>%
    group_by(Chr, POS, `Gene ID`) %>%
    dplyr::slice(1) %>% 
    arrange(desc(log10BayesFactor))
  return(pw_annos)
}
```

```{r}
annos_gg <- get_post_annos(m_gulf_gr_hyp)
annos_gf <- get_post_annos(m_gulf_fl_hyp)
annos_mg <- get_post_annos(m_midw_gr_hyp)
annos_mf <- get_post_annos(m_midw_fl_hyp)
annos_gamg <- get_post_annos(m_gam_gr_hyp)
annos_gamf <- get_post_annos(m_gam_fl_hyp)
```

```{r}
annos_gg %>%
  filter(cgdd_12c_18d_Gulf_and_Midwest.10 > 0.1 |
           tave_18d_Gulf_and_Midwest.6 > 0.1) %>%
  dplyr::select(where(not_all_na))

annos_gamg %>%
  filter(cgdd_12c_18d_Gulf_and_Midwest.10 > 0.1 |
           cgdd_12c_18d_Gulf_and_Midwest.9 > 0.1) %>%
  dplyr::select(where(not_all_na))

annos_mf %>%
  # dplyr::select(starts_with("cgdd_12c_gr2fl_Gulf_and"))
  filter(cgdd_12c_gr2fl_Gulf_and_Midwest.8 > 0.1) %>%
  dplyr::select(where(not_all_na))
annos_gamf %>%
  # dplyr::select(starts_with("dyln_change_sec"))
  filter(dyln_change_sec_Midwest.7 > 0.1) %>%
  dplyr::select(where(not_all_na))

Chr06N_41610882
mash_plot_effects(m_midw_fl_hyp, i = 41793)
```
Not many SNPs with U_hyp loading > 10% and SNP with log10BF > 2:
Both GR: 10 & 9 SNPs   cgdd_12c_18d_Gulf_and_Midwest x2 (0.9 and 0.10)
Both FL: 2 SNPs        dyln_change_sec_Midwest.7

Gulf FL: 0 SNPs
Gulf GR: 11 & 2 SNPs   cgdd_12c_18d_Gulf_and_Midwest.10 & tave_18d_Gulf_and_Midwest.6

Midw GR: 0 SNPs
Midw FL: 11 SNPs       cgdd_12c_gr2fl_Gulf_and_Midwest.8


### Get mash SNP metadata
```{r}
mash_obj <- readRDS("~/Github/pvdiv-phenology-gxe/analysis/mash/Midwest/Strong_Effects33000SNPs_FL50_Midwest_Uhyp.rds")
snp <- snp_attach("~/Github/pvdiv-genome/genetic_subpops/kinship/Pvirgatum_V5_GWAS_363g_Midwest_and_Gulf_subset_maf0.05.rds")

meta_mash_obj <- get_mash_metadata(m = mash_obj, snp = snp, saveoutput = FALSE)
saveRDS(meta_mash_obj, file = file.path(mashdir, names(subpop_v)[1], 
                                        paste0("Metadata_associated_with_",
                                               "alternate_alleles_",
                                              "33000SNPs_FL50_Midwest",
                                               "_m_", "363g_snp", ".rds")))
rm(meta_mash_obj)
```


# -------------------------

## 3e. Data-driven matrices


Run functions on line 743 first - to get posterior weights.
```{r}
pw_gamg %>%
  filter(log10BayesFactor >= 2)
pw_gg %>%
  filter(log10BayesFactor >= 2) %>%
  select(-(Marker:value), -log10BayesFactor) %>%
  colSums()/902 
pw_mg %>%
  filter(log10BayesFactor >= 2)
pw_gamf %>%
  filter(log10BayesFactor >= 2)
pw_gf %>%
  filter(log10BayesFactor >= 2)
pw_mf %>%
  filter(log10BayesFactor >= 2)
```
Gulf greenup sig 902 SNPs: 15.1% ED_PCA_1.9 
24.713% ED_tPCA.9
24.315% ED_tPCA.12
5.722 ED_tPCA.13

What patterns do the data-driven matrices capture that our weather matrices don’t capture?

SVD and plots of effects for the ED_PCA matrices.

ED_tPCA is made up of the 5 ED_PCA_#, each of which explains a different PVE of the tPCA. SNPs can have high pw's for just one of these PCA's, and/or for the tPCA, which is a weighted combination of all 5. While the PCA's typically have simple, garden-based effects, the tPCA is a more complicated weighted combination of these effects.

### i. Function

```{r functions to plot svd of data driven covar matrices}
m <- m_midw_fl_hyp
get_svd_df <- function(m, i = NULL, eigen_v = 1){
  Ulist <- switchgrassGWAS:::get_Ulist(m)
  stopifnot(eigen_v %in% c(1,2,3,4,5))
  if(is.null(i)){
    i_v <- which(names(Ulist) %in% names(Ulist)[get_U_by_mass(m, thresh = 0.1)])
    i = i_v[1]
  } else if(is.character(i)){
    i <- which(names(Ulist) %in% i)
  }
  stopifnot(i %in% 1:length(Ulist))
  
  b1 <- svd(Ulist[[i]])
  PVE_EV <- b1$d[eigen_v] / sum(b1$d) # Proportion of variance explained by this eigenvector
  ggb1 <- tibble(`Eigenvector` = b1$v[,eigen_v]/Ulist[[i]][which.max(abs(Ulist[[i]][,eigen_v])),eigen_v],
       Phenotype = switchgrassGWAS:::get_colnames(m)) %>%
  mutate(Phenotype = str_remove(Phenotype, "Stand_BhatGulf_and_Midwest_")) %>%
  mutate(Phenotype = str_remove(Phenotype, "Stand_BhatGulf_")) %>%
  mutate(Phenotype = str_remove(Phenotype, "Stand_BhatMidwest_")) %>%
  separate(Phenotype, into = c("Phenotype", "Garden"), sep = -3) %>%
  mutate(Phenotype = str_remove(Phenotype, "_$"),
         Garden = str_remove(Garden, "^_"),
         PVE_EV = PVE_EV,
         Garden = case_when(grepl("^0_M$", Garden) ~ "MI",
                            TRUE ~ Garden))
  ggb1$Garden <- factor(ggb1$Garden, levels = c("TX1", "TX2", "TX3", "OK", "MO", "NE", "MI", "SD"))
  return(ggb1)
}

mash_plot_svd <- function(m, i = NULL, eigen_v = 1){
  b1_df <- get_svd_df(m = m, i = i, eigen_v = eigen_v)
  if(eigen_v == 1){
    ylab <- paste0("First eigenvector\n(PVE = ", eval(round(b1_df$PVE_EV[1]*100,1)), "%)")
  } else if(eigen_v == 2){
    ylab <- paste0("Second eigenvector\n(PVE = ", eval(round(b1_df$PVE_EV[1]*100,1)), "%)")
  } else if(eigen_v == 3){
    ylab <- paste0("Third eigenvector\n(PVE = ", eval(round(b1_df$PVE_EV[1]*100,1)), "%)")
  } else if(eigen_v == 4){
    ylab <- paste0("Fourth eigenvector\n(PVE = ", eval(round(b1_df$PVE_EV[1]*100,1)), "%)")
  } else if(eigen_v == 5){
    ylab <- paste0("Fifth eigenvector\n(PVE = ", eval(round(b1_df$PVE_EV[1]*100,1)), "%)")
  }
  ggb1 <- b1_df %>%
    ggplot(aes(x = Garden, y = `Eigenvector`)) +
    switchgrassGWAS::theme_oeco + 
    geom_bar(stat = "identity", position = "dodge") +
    theme(legend.position = "top", panel.spacing.x = unit(0.1, 'cm'),
          axis.text.x = element_text(hjust = 1, angle = 45)) +
    geom_hline(yintercept = 0, linetype = 2) +
    scale_color_viridis_d(option = "B", end = 0.7, 
                        direction = -1) +
    scale_fill_viridis_d(option = "B", begin = 0.1, end = 0.7, 
                         direction = -1)  +
    labs(y = ylab)
  return(ggb1)
}
```

```{r}
gxe_gg <- get_GxE(m_gulf_gr_hyp)
gxe_mg <- get_GxE(m_midw_gr_hyp)
gxe_gamg <- get_GxE(m_gam_gr_hyp)
gxe_gf <- get_GxE(m_gulf_fl_hyp)
gxe_mf <- get_GxE(m_midw_fl_hyp)
gxe_gamf <- get_GxE(m_gam_fl_hyp)
```

```{r}
corrmatrix <-  gxe_mf$S_AP
pvdiv_plot_cor <- function(corrmatrix, upper = NULL, legend = FALSE){
  U1 <- corrmatrix

  U1 <- as_tibble(U1, rownames = "rowU", .name_repair = "unique") %>%
          pivot_longer(cols = -.data$rowU, names_to = "colU",
                       values_to = "covar") %>%
          filter(!is.na(.data$covar)) %>%
    mutate(rowU = str_remove(rowU, 
                             "Stand_BhatGulf_and_Midwest_")) %>%
    mutate(rowU = str_remove(rowU, "Stand_BhatGulf_")) %>%
    mutate(rowU = str_remove(rowU, "Stand_BhatMidwest_")) %>%
    mutate(rowU = str_remove(rowU, "GR50_")) %>%
    mutate(rowU = str_remove(rowU, "FL50_")) %>%
    mutate(colU = str_remove(colU, 
                             "Stand_BhatGulf_and_Midwest_")) %>%
    mutate(colU = str_remove(colU, "Stand_BhatGulf_")) %>%
    mutate(colU = str_remove(colU, "Stand_BhatMidwest_")) %>%
    mutate(colU = str_remove(colU, "GR50_")) %>%
    mutate(colU = str_remove(colU, "FL50_")) %>%
    mutate(rowU = case_when(grepl("^M$", rowU) ~ "MI",
                            TRUE ~ rowU),
           colU = case_when(grepl("^M$", colU) ~ "MI",
                            TRUE ~ colU),)
  U1$colU <- factor(U1$colU, levels = c("TX1", "TX2", "TX3", "OK", "MO", "NE", "MI", "SD"))
  U1$rowU <- factor(U1$rowU, levels = c("TX1", "TX2", "TX3", "OK", "MO", "NE", "MI", "SD"))
  U1 <- arrange(U1, rowU, colU) %>%
    pivot_wider(names_from = colU, values_from = covar) 
  for(i in 1:nrow(U1)){
    for(j in 2:ncol(U1)){
      if(i <= j-1){
        U1[i, j] <- NA
      }
    }
  }
  U1 <- U1 %>%
    pivot_longer(cols = -.data$rowU, names_to = "colU",
                       values_to = "covar")
  U1$colU <- factor(U1$colU, levels = c("TX1", "TX2", "TX3", "OK", "MO", "NE", "MI", "SD")) 
  if(is.null(upper)){
  upper <- max(U1$covar, na.rm = TRUE)+5
  }
  U1_covar <- U1 %>%
    filter(!is.na(.data$covar)) %>%
    ggplot(aes(x = .data$rowU, y = .data$colU)) +
    switchgrassGWAS::theme_oeco +
    geom_tile(aes(fill = .data$covar)) +
    scale_fill_viridis_c(option = "B", limits = c(0, upper)) +
    #geom_text(aes(label = round(.data$covar, 1)), color = "darkgrey") +
    theme(legend.position = "none",
          axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) +
    xlab("") + ylab("") 
  if(legend == TRUE){
    U1_covar <- U1_covar +
      theme(legend.position = c(0.2, 0.9)) +
      geom_text(aes(label = round(.data$covar, 1)), color = "darkgrey")
  }
  return(U1_covar)
}

```


```{r}
f3a <- mash_plot_svd(m_gulf_gr_hyp, i = "ED_tPCA") 
f3b <- mash_plot_svd(m_gulf_gr_hyp, i = "ED_tPCA", eigen_v = 2) 
f3e <- mash_plot_svd(m_midw_gr_hyp, i = "ED_tPCA") 
f3f <- mash_plot_svd(m_midw_gr_hyp, i = "ED_tPCA", eigen_v = 2) 
f3i <- mash_plot_svd(m_gam_gr_hyp, i = "ED_tPCA") 
f3j <- mash_plot_svd(m_gam_gr_hyp, i = "ED_tPCA", eigen_v = 2) 
f3m <- mash_plot_svd(m_gulf_fl_hyp, i = "ED_tPCA") 
f3n <- mash_plot_svd(m_gulf_fl_hyp, i = "ED_tPCA", eigen_v = 2) 
f3q <- mash_plot_svd(m_midw_fl_hyp, i = "ED_tPCA") 
f3r <- mash_plot_svd(m_midw_fl_hyp, i = "ED_tPCA", eigen_v = 2) 
f3u <- mash_plot_svd(m_gam_fl_hyp, i = "ED_tPCA") 
f3v <- mash_plot_svd(m_gam_fl_hyp, i = "ED_tPCA", eigen_v = 2) 


f3c <- pvdiv_plot_cor(corrmatrix = gxe_gg$S_AP, upper = 5500, legend = TRUE)
f3c_leg <- get_legend(f3c)
f3c <- pvdiv_plot_cor(corrmatrix = gxe_gg$S_AP, upper = 5500, legend = FALSE)
f3d <- pvdiv_plot_cor(corrmatrix = gxe_gg$S_DS, upper = 5500, legend = FALSE)

f3g <- pvdiv_plot_cor(corrmatrix = gxe_mg$S_AP, upper = 7777, legend = TRUE)
f3g_leg <- get_legend(f3g)
f3g <- pvdiv_plot_cor(corrmatrix = gxe_mg$S_AP, upper = 7777, legend = FALSE)
f3h <- pvdiv_plot_cor(corrmatrix = gxe_mg$S_DS, upper = 7777, legend = FALSE)

f3k <- pvdiv_plot_cor(corrmatrix = gxe_gamg$S_AP, upper = 7580, legend = TRUE)
f3k_leg <- get_legend(f3k)
f3k <- pvdiv_plot_cor(corrmatrix = gxe_gamg$S_AP, upper = 7580, legend = FALSE)
f3l <- pvdiv_plot_cor(corrmatrix = gxe_gamg$S_DS, upper = 7580,  legend = FALSE)

f3o <- pvdiv_plot_cor(corrmatrix = gxe_gf$S_AP, upper = 1850, legend = TRUE)
f3o_leg <- get_legend(f3o)
f3o <- pvdiv_plot_cor(corrmatrix = gxe_gf$S_AP, upper = 1850, legend = FALSE)
f3p <- pvdiv_plot_cor(corrmatrix = gxe_gf$S_DS, upper = 1850, legend = FALSE)

f3s <- pvdiv_plot_cor(corrmatrix = gxe_mf$S_AP, upper = 3636, legend = TRUE)
f3s_leg <- get_legend(f3s)
f3s <- pvdiv_plot_cor(corrmatrix = gxe_mf$S_AP, upper = 3636, legend = FALSE)
f3t <- pvdiv_plot_cor(corrmatrix = gxe_mf$S_DS, upper = 3636, legend = FALSE)

f3w <- pvdiv_plot_cor(corrmatrix = gxe_gamf$S_AP, upper = 13438, legend = TRUE)
f3w_leg <- get_legend(f3w)
f3w <- pvdiv_plot_cor(corrmatrix = gxe_gamf$S_AP, upper = 13438, legend = FALSE)
f3x <- pvdiv_plot_cor(corrmatrix = gxe_gamf$S_DS, upper = 13438, legend = FALSE)
```
put labels in latitudinal order
get rid of all the STand_Bhat_pop_GR50_ garbage

```{r}
ggdraw() +
  draw_plot(f3a, x = 0, y = 0.84, width = 0.33, height = 0.16) +
  draw_plot(f3b, x = 0, y = 0.68, width = 0.33, height = 0.16) +
  draw_plot(f3d, x = 0.165, y = 0.5, width = 0.165, height = 0.18) +
  draw_plot(f3c, x = 0, y = 0.5, width = 0.165, height = 0.18) +
  draw_plot(f3c_leg, x = 0.095, y = 0.595, width = 0.1, height = 0.1) +
  draw_plot(f3e, x = 0.33, y = 0.84, width = 0.33, height = 0.16) +
  draw_plot(f3f, x = 0.33, y = 0.68, width = 0.33, height = 0.16) +
  draw_plot(f3h, x = 0.165+.33, y = 0.5, width = 0.165, height = 0.18) +
  draw_plot(f3g, x = 0+.33, y = 0.5, width = 0.165, height = 0.18)  +
  draw_plot(f3g_leg, x = 0.095+.33, y = 0.595, width = 0.1, height = 0.1) +
  draw_plot(f3i, x = 0.66, y = 0.84, width = 0.33, height = 0.16) +
  draw_plot(f3j, x = 0.66, y = 0.68, width = 0.33, height = 0.16) +
  draw_plot(f3l, x = 0.165+.66, y = 0.5, width = 0.165, height = 0.18) +
  draw_plot(f3k, x = 0+.66, y = 0.5, width = 0.165, height = 0.18) +  
  draw_plot(f3k_leg, x = 0.095+.66, y = 0.595, width = 0.1, height = 0.1) +## greenup above here, flowering below
  draw_plot(f3m, x = 0, y = 0.84-0.5, width = 0.33, height = 0.16) +
  draw_plot(f3n, x = 0, y = 0.68-0.5, width = 0.33, height = 0.16) +
  draw_plot(f3p, x = 0.165, y = 0.5-0.5, width = 0.165, height = 0.18) +
  draw_plot(f3o, x = 0, y = 0.5-0.5, width = 0.165, height = 0.18) +  
  draw_plot(f3o_leg, x = 0.095, y = 0.595-0.5, width = 0.1, height = 0.1) +
  draw_plot(f3q, x = 0.33, y = 0.84-0.5, width = 0.33, height = 0.16) +
  draw_plot(f3r, x = 0.33, y = 0.68-0.5, width = 0.33, height = 0.16) +
  draw_plot(f3t, x = 0.165+.33, y = 0.5-0.5, width = 0.165, height = 0.18) +
  draw_plot(f3s, x = 0+.33, y = 0.5-0.5, width = 0.165, height = 0.18)  +
  draw_plot(f3s_leg, x = 0.095+.33, y = 0.595-0.5, width = 0.1, height = 0.1) +
  draw_plot(f3u, x = 0.66, y = 0.84-0.5, width = 0.33, height = 0.16) +
  draw_plot(f3v, x = 0.66, y = 0.68-0.5, width = 0.33, height = 0.16) +
  draw_plot(f3x, x = 0.165+.66, y = 0.5-0.5, width = 0.165, height = 0.18) +
  draw_plot(f3w, x = 0+.66, y = 0.5-0.5, width = 0.165, height = 0.18) +
  draw_plot(f3w_leg, x = 0.095+.66, y = 0.595-0.5, width = 0.1, height = 0.1)

save_plot(filename = "../manuscript/plots/Figure_3_Data_driven_Covariance_matrices.png", plot = last_plot(), base_height = 10, base_width = 11)
```


## 3f. DS & AP

We characterized patterns of differential sensitivity and antagonistic pleiotropy between all SNPs and all pairs of gardens.

`get_GxE` and `mash_plot_pairwise_sharing()` should do the trick here.


