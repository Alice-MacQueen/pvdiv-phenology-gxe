---
title: "D2F_4way_overlap"
author: "Alice MacQueen"
date: 2020-04-22
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(switchgrassGWAS)
library(cowplot)
library(viridis)
source("~/Github/Functions_ggplot-theme-adjustments_2018-01-03.R")
```

## 

```{r}
mash <- readRDS("~/Github/pvdiv-phenology-gxe/analysis/mash/Gulf_Midwest/Strong_Effects49260SNPs.rds")
qtl <- read_csv(file = "~/Github/pvdiv-phenology-gxe/data/QTLs_with_flank_markers_FL50_7_sites_full_model.csv")
sites <- readRDS("~/Github/pvdiv-phenotypes/data/sites.rds")
```

```{r}
df <- get_significant_results(m=mash) %>%
  enframe(name = "SNP")
df1 <- switchgrassGWAS:::get_marker_df(mash)
df1 <- df1 %>%
  mutate(log10bf = switchgrassGWAS:::get_log10bf(m=mash),
         sigcond = switchgrassGWAS:::get_n_significant_conditions(mash)
         )
effects <- ashr::get_pm(mash)
sd <- ashr::get_psd(mash)
colnames(sd) <- str_replace(colnames(sd), "Bhat", "Shat")

df1 <- cbind(df1, effects, sd)
```

```{r}
qtl %>%
  arrange(desc(lod)) %>%
  dplyr::select(lodcolumn, lod, chr, flank_lo, flank_hi)
```
From most to least significant, for QTL:
	Chr02N_58.039498 61.274395
	Chr05N_1.502713 4.328965
	Chr05N_58.916323 65.990782
	Chr04K_1.959391 5.499253
	Chr02K_63.687871 65.484856
	  Chr09K_13.655791 18.177373
		Chr03K_17.368264	Chr03K_26.170048
		Chr08N_5.54356	Chr08N_34.415808
	
# Chr02N  58.039498 61.274395
```{r}
switchgrassGWAS::mash_plot_effects(m=mash, i = 11087)
switchgrassGWAS::mash_plot_effects(m=mash, i = 11468)

df1 %>%
  filter(log10bf > 5) # 25 values
df1 %>%
  filter(log10bf > 4) # 93 values (1800 above 2)
```
Close
	Chr02N_58.039498 61.274395
Chr02N_15281005	9405	4.057999	1	
Chr02N_50051440	10742	4.288475	5	5.8214656195	
Chr02N_56422155	11087	5.158628	6	5.9439138054	
Chr02N_57947932	11178	4.390894	6	4.7648643926	
Chr02N_63420472	11467	4.374355	5	5.5078867975	
Chr02N_63420484	11468	5.022484	6	-5.0720890743

Close, first is better
	Chr05N_1.502713 4.328965
	Chr05N_58.916323 65.990782
Chr05N_4512043	25413	5.929161	6	8.5445301065	
Chr05N_20476771	26421	4.303708	5	6.4982493387	
Chr05N_24505333	26560	4.225575	5	7.4869178552	
Chr05N_25731508	26609	4.081614	1	-0.0036192576	
Chr05N_28066146	26673	4.727816	6	8.9999136556	
Chr05N_36999363	26879	5.038580	5	-5.0653499084	
Chr05N_37110671	26885	4.151390	5	6.1070001182	
Chr05N_38945328	26961	4.980246	6
Chr05N_46107016	27330	4.099486	6	3.6428083879	
Chr05N_65588952	28354	4.003577	6	

Close
	Chr04K_1.959391 5.499253
Chr04K_1935684	17557	4.235319	5	6.1526138902	
Chr04K_6537440	17814	4.403893	5	4.7144521481	
Chr04K_6567024	17818	4.962056	6	5.1767913940	
Chr04K_8657535	17940	5.205059  6
Chr04K_12651532	18152	6.096971  6


Not close
	Chr02K_63.687871 65.484856
Chr02K_23509869	6711	5.595545	6	-6.7548782752	
Chr02K_23682427	6713	5.430460	5	6.9669557271	
Chr02K_35881338	6882	4.095730	6	

```{r}
panela <- df1 %>%
  filter(grepl("Chr02N_(5|6)", Marker) & between(value, 11000, 11500)) %>%
  separate(Marker, into = c("Chr", "_", "Position"), sep = c(6,7), remove = FALSE) %>%
  mutate(Position = as.numeric(Position)) %>%
  ggplot(aes(x=Position, y = log10bf)) +
  geom_point(aes(color = sigcond)) +
  scale_color_viridis(option = "B", end = 0.8) # 26711
save_plot(filename = "Chr02N_58_to_61Mb_D2F_mash_result_zoom.png", plot = panela, base_asp = 1.2)

panelb <- switchgrassGWAS::mash_plot_effects(m=mash, i = 11087)
#panelb <- switchgrassGWAS::mash_plot_effects(m=mash, i = 11467)
##panelb <- switchgrassGWAS::mash_plot_effects(m=mash, i = 11468)
#panelb <- switchgrassGWAS::mash_plot_effects(m=mash, i = 11178)

p3 <- plot_grid(panela, panelb$ggobject, rel_widths = c(2,1))
save_plot(filename = "Chr02N_58_to_61Mb_mash_result_zoom_2panel.png", plot = p3, base_asp = 1.5)
```
# Chr05N 
```{r}

panela <- df1 %>%
  filter(grepl("Chr05N_", Marker) & between(value, 24000, 25600)) %>%
  separate(Marker, into = c("Chr", "_", "Position"), sep = c(6,7), remove = FALSE) %>%
  mutate(Position = as.numeric(Position)) %>%
  ggplot(aes(x=Position, y = log10bf)) +
  geom_point(aes(color = sigcond)) +
  scale_color_viridis(option = "B", end = 0.8) # 26711


panelb <- switchgrassGWAS::mash_plot_effects(m=mash, i = 25413)
#panelb <- switchgrassGWAS::mash_plot_effects(m=mash, i = 11467)
##panelb <- switchgrassGWAS::mash_plot_effects(m=mash, i = 11468)
#panelb <- switchgrassGWAS::mash_plot_effects(m=mash, i = 11178)

(p3 <- plot_grid(panela, panelb$ggobject, rel_widths = c(2,1)))
save_plot(filename = "Chr05N_0_to_8Mb_D2F_mash_result_zoom.png", plot = panela, base_asp = 1.2)
save_plot(filename = "Chr05N_0_to_8Mb_mash_result_zoom_2panel.png", plot = p3, base_asp = 1.5)
```

# Chr05N 60Mb
```{r}

panela <- df1 %>%
  filter(grepl("Chr05N_(5|6)", Marker) & between(value, 28000, 28500)) %>%
  separate(Marker, into = c("Chr", "_", "Position"), sep = c(6,7), remove = FALSE) %>%
  mutate(Position = as.numeric(Position)) %>%
  ggplot(aes(x=Position, y = log10bf)) +
  geom_point(aes(color = sigcond)) +
  scale_color_viridis(option = "B", end = 0.8) # 26711


panelb <- switchgrassGWAS::mash_plot_effects(m=mash, i = 28354)
#panelb <- switchgrassGWAS::mash_plot_effects(m=mash, i = 11467)
##panelb <- switchgrassGWAS::mash_plot_effects(m=mash, i = 11468)
#panelb <- switchgrassGWAS::mash_plot_effects(m=mash, i = 11178)

(p3 <- plot_grid(panela, panelb$ggobject, rel_widths = c(2,1)))
save_plot(filename = "Chr05N_58_to_68Mb_D2F_mash_result_zoom.png", plot = panela, base_asp = 1.2)
save_plot(filename = "Chr05N_58_to_68Mb_mash_result_zoom_2panel.png", plot = p3, base_asp = 1.5)
```

# Chr04K

Close
	Chr04K_1.959391 5.499253
Chr04K_1935684	17557	4.235319	5	6.1526138902	
Chr04K_6537440	17814	4.403893	5	4.7144521481	
Chr04K_6567024	17818	4.962056	6	5.1767913940	
Chr04K_8657535	17940	5.205059  6
Chr04K_12651532	18152	6.096971  6
```{r}

panela <- df1 %>%
  filter(grepl("Chr04K_", Marker) & between(value, 17500, 18200)) %>%
  separate(Marker, into = c("Chr", "_", "Position"), sep = c(6,7), remove = FALSE) %>%
  mutate(Position = as.numeric(Position)) %>%
  ggplot(aes(x=Position, y = log10bf)) +
  geom_point(aes(color = sigcond)) +
  scale_color_viridis(option = "B", end = 0.8) # 26711

panelb <- switchgrassGWAS::mash_plot_effects(m=mash, i = 18152)
#panelb <- switchgrassGWAS::mash_plot_effects(m=mash, i = 17557)
##panelb <- switchgrassGWAS::mash_plot_effects(m=mash, i = 17814)
#panelb <- switchgrassGWAS::mash_plot_effects(m=mash, i = 17818)
 switchgrassGWAS::mash_plot_effects(m=mash, i = 17940)
 
(p3 <- plot_grid(panela, panelb$ggobject, rel_widths = c(2,1)))
save_plot(filename = "Chr04K_1_to_12Mb_D2F_mash_result_zoom.png", plot = panela, base_asp = 1.2)
save_plot(filename = "Chr04K_1_to_12Mb_mash_result_zoom_2panel.png", plot = p3, base_asp = 1.5)
```

# Chr08N_5.54356	Chr08N_34.415808
```{r}

panela <- df1 %>%
  filter(grepl("Chr08N_", Marker) & between(value, 40000, 41100)) %>%
  separate(Marker, into = c("Chr", "_", "Position"), sep = c(6,7), remove = FALSE) %>%
  mutate(Position = as.numeric(Position)) %>%
  ggplot(aes(x=Position, y = log10bf)) +
  geom_point(aes(color = sigcond)) +
  scale_color_viridis(option = "B", end = 0.8) # 26711

panelb <- switchgrassGWAS::mash_plot_effects(m=mash, i = 40305)
#panelb <- switchgrassGWAS::mash_plot_effects(m=mash, i = 40514)

(p3 <- plot_grid(panela, panelb$ggobject, rel_widths = c(2,1)))
save_plot(filename = "Chr08N_0_to_1Mb_D2F_mash_result_zoom.png", plot = panela, base_asp = 1.2)
save_plot(filename = "Chr08N_0_to_1Mb_mash_result_zoom_2panel.png", plot = p3, base_asp = 1.5)
```

# Li's QTL CSV

```{r}
qtl <- qtl %>%
  separate(flank_hi, into = c("Chr_hi", "_hi", "Position_hi"), sep = c(6,7), remove = FALSE) %>%
  separate(flank_lo, into = c("Chr_lo", "_lo", "Position_lo"), sep = c(6,7), remove = FALSE) %>%
  mutate(Position_hi = as.numeric(Position_hi)*1000000,
         Position_lo = as.numeric(Position_lo)*1000000)
qtl
```

```{r}

# load("~/Github/pvdiv-phenology-gxe/data/sites.rda")

levelsSN = rev(c("BRKG", "KBSM", "FRMI", "LINC", "CLMB", "STIL", "OVTN", "TMPL", "PKLE", "KING"))
levelsNS = c("BRKG", "KBSM", "FRMI", "LINC", "CLMB", "STIL", "OVTN", "TMPL", "PKLE", "KING")
```


```{r}
i=1
width = 1000000

for(i in 1:nrow(qtl)){
df_a <- df1 %>%
  separate(Marker, into = c("Chr", "_", "Position"), sep = c(6,7), remove = FALSE) %>%
  mutate(Position = as.numeric(Position)) %>%
  filter(grepl(qtl$chr[i], Chr) & between(Position, qtl$Position_lo[i]-width, qtl$Position_hi[i]+width)) 
panel_a <- df_a %>%
  ggplot(aes(x=Position, y = log10bf)) +
  geom_point(aes(color = sigcond)) +
  scale_color_viridis(option = "B", end = 0.9)  + 
  labs(x = "Position", y = "log10(Bayes Factor)") +
  geom_label(data = df_a[df_a$log10bf==max(df_a$log10bf),], mapping = aes(x = Position, y = log10bf, label = Marker), nudge_y = -0.4)

panelb <- switchgrassGWAS::mash_plot_effects(m=mash, i = df_a[df_a$log10bf==max(df_a$log10bf),]$value)
df_b <- panelb$effect_df %>%
  mutate(Site = str_sub(value, start =11, end = 14)) %>%
  left_join(sites) 
sites$Site <- factor(sites$Site, levels = levelsSN)
df_b$Site <- factor(df_b$Site, levels = levelsSN)
panel_b <- df_b %>%
  ggplot(aes(x = Site)) +
    geom_point(mapping = aes(y = mn)) +
    geom_errorbar(mapping = aes(ymin = mn - se,
                                ymax = mn + se, width = 0.3)) +
    geom_hline(yintercept = 0, lty = 2) +
    labs(x = "Conditions", y = "Effect Size") + coord_flip()

p3 <- plot_grid(panel_a, panel_b, rel_widths = c(2,1))
save_plot(filename = paste(qtl$Chr_lo[i], qtl$Position_lo[i], "to", qtl$Position_hi[i], "FL50_mash_result_zoom.png", sep = "_"), plot = p3, base_asp = 3)
}
```

