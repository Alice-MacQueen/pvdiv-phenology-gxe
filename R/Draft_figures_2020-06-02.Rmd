---
title: "Draft_figures_2020-06-02"
author: "Alice MacQueen"
date: "6/2/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(cowplot)
library(viridis)
library(lubridate)
source("~/Github/Functions_ggplot-theme-adjustments_2018-01-03.R")
```

#

```{r}
metadata <- readRDS("~/Github/pvdiv-phenotypes/data/metadata.rds")
metadata <- metadata %>%
  mutate(SUBPOP = case_when(!is.na(GENETIC_SUBPOP_KINSHIP) ~ as.character(GENETIC_SUBPOP_KINSHIP),
                            !is.na(PLOIDY) ~ as.character(PLOIDY),
                            TRUE ~ NA_character_),
         LATITUDE = abs(LATITUDE),
         LONGITUDE = abs(LONGITUDE)) 
phe_all <- read_rds("../data/all_phenotype_meas_4wcr_gwas.rds")
sites <- readRDS("~/Github/pvdiv-phenotypes/data/sites.rds")
phe_all$SUBPOP <- factor(phe_all$SUBPOP, levels = c("4X", "Atlantic", "Gulf", "Midwest", "8X"))
sites <- sites %>%
  mutate(manu_site = case_when(State != "TX" ~ State,
                               SITE == "KING" ~ "TX1",
                               SITE == "PKLE" ~ "TX2",
                               SITE == "TMPL" ~ "TX3",
                               SITE == "OVTN" ~ "TX4"))
sites$manu_site <- factor(sites$manu_site, levels = c("TX1", "TX2", "TX3", "TX4", "OK", "MO", "NE", "IL", "MI", "SD"))

subpops <- enframe(unique(metadata$SUBPOP), name = NULL, value = "SUBPOP") %>%
  mutate(color_code = case_when(SUBPOP == "Atlantic" ~ "#6E91CB",
                                SUBPOP == "Gulf" ~ "#F47F72",    
                                SUBPOP == "Midwest" ~ "#442C83",
                                SUBPOP == "4X" ~ "grey", 
                                SUBPOP == "8X" ~ "#090906"))
subpops$SUBPOP <- factor(subpops$SUBPOP, levels = c("4X", "Atlantic", "Gulf", "Midwest", "8X"))

# gulf: #F47F72, atlantic: #6E91CB, midwest: #442C83
```

FWCR	AP13	2921		parent - gulf
FWCR	AxD	2124		F1 (AxB in results)
FWCR	DAC	493		  parent - midwest
FWCR	VS16	1135		parent - midwest
FWCR	VxW	2242		F1 (CxD in results)
FWCR	WBC	1945		parent - gulf
FWCR	NA	4		
GWAS	AP13	4410	in FWCR also
What J #'s (if any) are DAC, VS16, WBC in the GWAS panel?
DAC J440.A, J440.B Source_ID_2 Dacotah
J230.A Source_ID_1  WBC
J292.A SOURCE_ID_1 VS16 (counted as 8X in metadata, may be an issue)

J045.A SOURCE_ID_2 NSL 29896, Summer
```{r}
phe_F0_up <- phe_all %>%
  filter(WHERE == "FWCR" & PLANT_ID %in% c("DAC", "VS16", "J440.A", "J036.A", "J037.A")) 
phe_F0_low <- phe_all %>%
  filter(WHERE == "FWCR" & PLANT_ID %in% c("AP13", "WBC", "J230.A")) 
phe_F0 <- phe_all %>%
  filter(WHERE == "FWCR" & PLANT_ID %in% c("AP13", "DAC", "VS16", "WBC", "J440.A", "J440.B", "J230.A", "J292.A", "J045.A", "J036.A", "J037.A", "J022.B", "J210.A")) 
phe_F1 <- phe_all %>%
  filter(WHERE == "FWCR" & PLANT_ID %in% c("AxD", "VxW")) 
phe_F2 <- phe_all %>%
  filter(WHERE == "FWCR" & !(PLANT_ID %in% c("AP13", "DAC", "VS16", "WBC", "AxD", "VxW"))) 
```

# Set up 2019 weather data for plots
```{r}
ptt_df <- readRDS(file = "~/Github/pvdiv-phenology-gxe/data/Weather_with_PTT_2019.rds")

wea_df <- ptt_df %>%
  dplyr::select(DOY:GDD_13C_SM, PTT_13C)

GR_start <- phe_all %>% 
  ungroup() %>%
  group_by(SITE, YEAR) %>%
  filter(PHE == "GR50") %>%
  summarise(GR_start = floor(min(MEAS)))
FL_end <- phe_all %>% 
  ungroup() %>%
  group_by(SITE, YEAR) %>%
  filter(PHE == "FL50") %>%
  summarise(FL_end = ceiling(max(MEAS)))

wea_gr_fl <- wea_df %>%
  left_join(GR_start, by = "SITE", "YEAR") %>%
  left_join(FL_end, by = c("SITE", "YEAR")) %>%
  group_by(Day_of_year, SITE, YEAR) %>%
  filter(between(Day_of_year, GR_start, FL_end)) %>% 
  ungroup() # Just the weather data between the minimum GR50 and max FL50.
# wea_df has all the weather, wea_gr_fl has the weather for the subset between
# greenup and flowering.
```

# --
# Run all chunks above as setup

# -- Plots

We first evaluated the evidence that switchgrass photoperiodicity was genotype dependent â€“ specifically, that switchgrass flowers when exposed to shortening days of a specific length. 
```{r}
fl50_dyln <- phe_all %>%
  filter(PHE == "FL50") %>%
  left_join(wea_gr_fl, by = c("SITE", "YEAR", "MEAS" = "Day_of_year"))
fl50_dyln$SITE <- factor(fl50_dyln$SITE, levels = c("KING", "PKLE", "TMPL", "OVTN", "STIL", "CLMB", "LINC", "FRMI", "KBSM", "BRKG"))

fl1_dyln <- phe_all %>%
  filter(PHE == "FL1") %>%
  left_join(wea_gr_fl, by = c("SITE", "YEAR", "MEAS" = "Day_of_year"))
fl1_dyln$SITE <- factor(fl1_dyln$SITE, levels = c("KING", "PKLE", "TMPL", "OVTN", "STIL", "CLMB", "LINC", "FRMI", "KBSM", "BRKG"))

fl50_dyln %>%
  group_by(SUBPOP) %>%
  summarise(min_dyln = min(DYLN),
            max_dyln = max(DYLN))
max_dyln <- wea_gr_fl %>%
  group_by(SITE) %>%
  summarise(min_dyln = min(DYLN, na.rm = TRUE),
            max_dyln = max(DYLN, na.rm = TRUE))
```

Many genotypes flowered while days were lengthening at the three southernmost sites (Table X). 
Specifically, at Kingsville, 107 genotypes (38.9%) had 50% of tillers flowering before the summer solstice, after which, days start shortening. At Pickle, 518 genotypes (62.3%) were flowering while days were lengthening. At Temple, 107 genotype (26.9%) were flowering while days were lengthening, while at Stillwater and Columbia, 5 and 9 genotypes (2.0%, 1.2%) flowered while days were lengthening. These observations indicated that photoperiodicity could not be the only environmental triggering flowering in this species. 
```{r}
fl50_dyln %>%
  filter(WHERE == "GWAS") %>%
  mutate(FL_B4_SOL = case_when(MEAS > 173 ~ "DAYS_SHORTENING",
                               MEAS <= 172 ~ "DAYS_LENGTHENING",
                               TRUE ~ NA_character_)) %>%
  group_by(SITE, FL_B4_SOL, PLANT_ID) %>%
  summarise(count = n()) %>%
  group_by(SITE, FL_B4_SOL) %>%
  tally() %>%
  group_by(SITE) %>%
  mutate(frac = n/sum(n))

fl50_dyln %>%
  filter(WHERE == "GWAS") %>%
  mutate(FL_B4_SOL = case_when(MEAS > 173 ~ "DAYS_SHORTENING",
                               MEAS <= 172 ~ "DAYS_LENGTHENING",
                               TRUE ~ NA_character_)) %>%
  group_by(SITE, FL_B4_SOL, SUBPOP, PLANT_ID) %>%
  summarise(count = n()) %>%
  group_by(SITE, FL_B4_SOL, SUBPOP) %>%
  tally() %>%
  group_by(SITE, SUBPOP) %>%
  #mutate(frac = n/sum(n)) %>%
  pivot_wider(names_from = SUBPOP, values_from = n) %>%
  left_join(sites) %>%
  write_csv("../manuscript/plots/Plant_flowering_b4_or_after_solstice.csv")

fl50_dyln$SITE <- factor(fl50_dyln$SITE, levels = c("KING", "PKLE", "TMPL", "OVTN", "STIL", "CLMB", "LINC", "FRMI", "KBSM", "BRKG"))

daylength_change <- fl50_dyln %>%
  filter(WHERE == "GWAS" & !(SITE %in% c("OVTN", "FRMI"))) %>%
  mutate(FL_B4_SOL = case_when(MEAS > 173 ~ "Shortening",
                               MEAS <= 172 ~ "Lengthening",
                               TRUE ~ NA_character_)) %>%
  group_by(SITE, FL_B4_SOL, SUBPOP, PLANT_ID) %>%
  summarise(count = n()) %>%
  group_by(SITE, FL_B4_SOL, SUBPOP) %>%
  tally() #%>%
  #group_by(SITE, SUBPOP) %>%
  #mutate(frac = n/sum(n)) %>%
  #pivot_wider(names_from = SUBPOP, values_from = n) %>%
  #left_join(sites) %>%
daylength_change$SUBPOP <- factor(daylength_change$SUBPOP, levels = c("4X", "Atlantic", "Gulf", "Midwest", "8X"))
color_code <- c("grey", "#6E91CB","#F47F72", "#442C83", "#090906")
dyln_change <- daylength_change %>%
  left_join(sites) %>%
  left_join(subpops) %>%
  dplyr::select(SITE, FL_B4_SOL, SUBPOP, n) %>%
  ungroup() %>%
  #add_row(SITE = "BRKG", FL_B4_SOL = "Shortening") %>%
  #add_row(SITE = "LINC", FL_B4_SOL = "Shortening") %>%
  complete(SITE, FL_B4_SOL, SUBPOP, fill = list(n = 0))
delta_dyln %>%
  ggplot(aes(x = FL_B4_SOL, y = n, width = 0.7)) + 
  geom_bar(aes(fill = SUBPOP), stat = "identity", position = position_dodge()) +
  facet_wrap(~manu_site, nrow = 2) +
  scale_fill_manual(values = color_code) +
  theme(axis.text.x = element_text(hjust = 1, vjust = 1, angle = 45),
        legend.position = "right", panel.spacing.x = unit(x = 0.01, unit = "npc")) +
  ylab("Count of Genotypes") +
  xlab("Does the genotype flower when days are 
       lengthening or shortening?") 
save_plot(filename = "../manuscript/plots/daylength_change_subpops.png", plot = delta_dyln)


```
```{r}
dyln_change$SUBPOP <- factor(dyln_change$SUBPOP, levels = rev(c("4X", "Atlantic", "Gulf", "Midwest", "8X")))
color_code <- rev(c("grey", "#6E91CB","#F47F72", "#442C83", "#090906"))

site_subpop_list <- list()
eightsites <- c("KING", "PKLE", "TMPL", "STIL", "CLMB", "LINC", "KBSM", "BRKG")

for(i in seq_along(eightsites)){
p1 <- dyln_change %>%
  filter((SITE %in% eightsites[i]) & FL_B4_SOL == "Lengthening") %>%
  ggplot(aes(x = SUBPOP, y = n, width = 1)) + 
  geom_col(aes(fill = SUBPOP), position = "dodge") +
  scale_y_reverse(expand = c(0.002, 0.002), limits = c(240, 0)) + coord_flip() +
  scale_fill_manual(values = color_code) +
  theme(axis.text.x = element_text(hjust = 1, vjust = 1, angle = 45),
        legend.position = "none", panel.spacing.x = unit(x = 0, unit = "mm"),
        plot.margin = unit(c(5.5, 0, 5.5, 5.5), "pt")) +
  ylab("Genotypes") +
  xlab("Subpopulation") + labs(subtitle = "Lengthening", title = sites$manu_site[sites$SITE == eightsites[i]])
p2 <- dyln_change %>%
  filter((SITE %in% eightsites[i]) & FL_B4_SOL == "Shortening") %>%
  ggplot(aes(x = SUBPOP, y = n, width = 1)) + 
  geom_col(aes(fill = SUBPOP), position = "dodge") +
  scale_y_continuous(expand = c(0.002, 0.002), limits = c(0,240)) +
  coord_flip() +
  scale_fill_manual(values = color_code) +
  theme(axis.text.x = element_text(hjust = 1, vjust = 1, angle = 45),
        axis.text.y = element_blank(), axis.title.y = element_blank(),
        legend.position = "none", panel.spacing.x = unit(x = 0, unit = "mm"),        axis.line.y = element_blank(), axis.ticks.y = element_blank(),
        plot.margin = unit(c(5.5, 5.5, 5.5, -3.5), "pt")) +
  geom_hline(yintercept = 0, linetype = 2) + labs(subtitle = "Shortening", title = " ") + ylab(" ")

  
site_subpop_list[[i]] <- plot_grid(p1, p2, rel_widths = c(1.66,1))
}

subpop_dyln_plot <- plot_grid(site_subpop_list[[1]], site_subpop_list[[2]], site_subpop_list[[3]],
          site_subpop_list[[4]], site_subpop_list[[5]], site_subpop_list[[6]],
          site_subpop_list[[7]], site_subpop_list[[8]], nrow = 2)

save_plot(filename = "../manuscript/plots/daylength_change_subpops_back_to_back.png", plot = subpop_dyln_plot, base_asp = 2.2, base_height = 5)
```


At Kingsville, all five subpopulations had individuals that flowered while days were lengthening. Only the admixed 4X and the Gulf subpops had a majority of individuals that flowered while days were shortening (55% and 85.3%).
At Pickle, all five subpopulations had individuals that flowered while days were lengthening. Only the Gulf subpop had a majority of individuals that flowered while days were shortening (94.0%).
At Temple,  all five subpopulations had individuals that flowered while days were lengthening. The admixed 4X, Atlantic, and Gulf had a majority of individuals that flowered while days were shortening (65.2%, 57.9%, and 99.5%).
At Stillwater, 4X, Atlantic, and Midwest individuals flowered while days were lengthening, but these individuals were in the minority (5.3%, 2.3%, 3.7%).
At Columbia, 8X and Midwest individuals flowered while days were lengthening (1.4% and 5%).
Further north than Columbia, virtually all individuals flowered while days were shortening.

Latitude of origin bins for flowering while day lengthening/shortening plot

```{r}
fl50_dyln %>%
  filter(!is.na(LATITUDE)) %>%
  mutate(latbin = floor(abs(LATITUDE)/5)) %>%
  filter(WHERE == "GWAS") %>%
  mutate(FL_B4_SOL = case_when(MEAS > 173 ~ "Shortening",
                               MEAS <= 172 ~ "Lengthening",
                               TRUE ~ NA_character_)) %>%
  group_by(SITE, latbin) %>% tally()

dyln_latbin <- fl50_dyln %>%
  filter(!is.na(LATITUDE)) %>%
  mutate(latbin = floor(abs(LATITUDE))) %>%
  filter(WHERE == "GWAS" & !(SITE %in% c("OVTN", "FRMI"))) %>%
  mutate(FL_B4_SOL = case_when(MEAS > 173 ~ "Shortening",
                               MEAS <= 172 ~ "Lengthening",
                               TRUE ~ NA_character_)) %>%
  group_by(SITE, FL_B4_SOL, latbin, PLANT_ID, SUBPOP) %>%
  summarise(count = n()) %>%
  dplyr::select(-PLANT_ID) %>%
  complete(SITE, FL_B4_SOL, latbin, SUBPOP) %>%
  group_by(SITE, FL_B4_SOL, latbin, SUBPOP) %>%
  summarise(count = sum(!is.na(count))) %>%
  complete(SITE, FL_B4_SOL, latbin, SUBPOP, fill = list(count = 0)) %>%
  arrange(latbin)

#dyln_change <- 
dyln_latbin %>%
  left_join(sites, by = "SITE") %>%
  filter(!(SITE %in% c("FRMI", "OVTN"))) %>%
  ggplot(aes(x = FL_B4_SOL, y = count, width = 0.8)) + 
  geom_bar(aes(fill = as_factor(latbin)), stat = "identity", position = position_dodge()) +
  facet_wrap(~manu_site, nrow = 2) +
  scale_fill_viridis(option = "B", discrete = TRUE, direction = -1) +
  theme(axis.text.x = element_text(hjust = 1, vjust = 1, angle = 45),
        legend.position = "right", panel.spacing.x = unit(x = 0.01, unit = "npc")) +
  ylab("Count of Genotypes") +
  xlab("Do genotypes from that latitude of origin flower when days are 
       lengthening or shortening?") 
save_plot(filename = "../manuscript/plots/daylength_change_subpops.png", plot = dyln_change)
dyln_latbin2 <- dyln_latbin %>% ungroup() %>% add_row(latbin = 24, count = 0) %>%
  complete(SITE, FL_B4_SOL, latbin, SUBPOP, fill = list(count = 0)) %>%
  filter(!is.na(FL_B4_SOL) & !is.na(SUBPOP)) %>%
  mutate(count = case_when(latbin == 24 ~ 48,
                           TRUE ~ count)) %>%
  unique()
```

```{r}
latranges <- metadata %>%
  group_by(SUBPOP) %>%
  summarise(min = min(LATITUDE, na.rm = TRUE),
            max = max(LATITUDE, na.rm = TRUE))

metadata$SUBPOP <- factor(metadata$SUBPOP, levels = c("4X", "Atlantic", "Gulf", "Midwest", "8X"))
paneld <- metadata %>%
  ggplot(aes(x = SUBPOP, y = LATITUDE)) +
  geom_violin(aes(color = SUBPOP)) + geom_jitter(aes(color = SUBPOP), alpha = 0.1, height = 0, width = 0.1) + scale_color_manual(values = rev(color_code)) + theme(legend.position = "none", axis.text.x = element_text(hjust = 1, vjust = 1, angle = 45)) + ylab("Latitude of origin") + xlab("Subpopulation") + labs(title = "", subtitle = "")
```


```{r}
  
panela <- dyln_latbin2 %>%
  left_join(sites, by = "SITE") %>%
  filter((SITE %in% c("KING"))) %>%
  mutate(n = case_when(FL_B4_SOL == "Lengthening" ~ -count,
                       TRUE ~ count)) %>%
  ggplot(aes(x = latbin, y = n, width = 1)) + 
  geom_col(aes(fill = as_factor(latbin)), position = "dodge") +
  coord_flip() +
  facet_wrap(~FL_B4_SOL, ncol = 2, scales = "free_x") +
  scale_fill_viridis(option = "B", discrete = TRUE, direction = -1) +
  theme(axis.text.x = element_text(hjust = 1, vjust = 1, angle = 45),
        legend.position = "none", panel.spacing.x = unit(x = 0, unit = "mm")) +
  scale_y_continuous(expand = c(0.002, 0.002), 
    labels = function(x) signif(abs(x), 3)) +
  ylab("Number of genotypes") +
  xlab("Latitude of origin") + labs(title = "TX1", subtitle = "Day length change on date of flowering") +
  xlim(c(25,45))
panelb <- dyln_latbin2 %>%
  left_join(sites, by = "SITE") %>%
  filter((SITE %in% c("PKLE"))) %>%
  mutate(n = case_when(FL_B4_SOL == "Lengthening" ~ -count,
                       TRUE ~ count)) %>%
  ggplot(aes(x = latbin, y = n, width = 1)) + 
  geom_col(aes(fill = as_factor(latbin)), position = "dodge") +
  coord_flip() +
  facet_wrap(~FL_B4_SOL, ncol = 2, scales = "free_x") +
  scale_fill_viridis(option = "B", discrete = TRUE, direction = -1) +
  theme(axis.text.x = element_text(hjust = 1, vjust = 1, angle = 45),
        legend.position = "none", panel.spacing.x = unit(x = 0, unit = "mm")) +
  scale_y_continuous(expand = c(0.002, 0.002), 
    labels = function(x) signif(abs(x), 3)) +
  ylab("Number of genotypes") +
  xlab("Latitude of origin") + labs(title = "TX2", subtitle = "Day length change on date of flowering") +
  xlim(c(25,45))
panelc <- dyln_latbin2 %>%
  left_join(sites, by = "SITE") %>%
  filter((SITE %in% c("TMPL"))) %>%
  mutate(n = case_when(FL_B4_SOL == "Lengthening" ~ -count,
                       TRUE ~ count)) %>%
  ggplot(aes(x = latbin, y = n, width = 1)) + 
  geom_col(aes(fill = as_factor(latbin)), position = "dodge") +
  coord_flip() +
  facet_wrap(~FL_B4_SOL, ncol = 2, scales = "free_x") +
  scale_fill_viridis(option = "B", discrete = TRUE, direction = -1) +
  theme(axis.text.x = element_text(hjust = 1, vjust = 1, angle = 45),
        legend.position = "none", panel.spacing.x = unit(x = 0, unit = "mm")) +
  scale_y_continuous(expand = c(0.002, 0.002), 
    labels = function(x) signif(abs(x), 3)) +
  ylab("Number of genotypes") +
  xlab("Latitude of origin") + labs(title = "TX3", subtitle = "Day length change on date of flowering") +
  xlim(c(25,45))

dyln_lat_plot <- plot_grid(paneld, panela, panelb, panelc, nrow = 1)
save_plot(filename = "../manuscript/plots/Daylength_changes_flowering_date_by_latitude_of_origin_subpops.svg", plot = dyln_lat_plot, base_asp = 2.6, base_height = 4)
```

```{r}
filter(unique(dyln_latbin2), count > 200)
panela <- dyln_latbin2 %>%
  left_join(sites, by = "SITE") %>%
  filter((SITE %in% c("KING"))) %>%
  mutate(n = case_when(FL_B4_SOL == "Lengthening" ~ -count,
                       TRUE ~ count)) %>%
  ggplot(aes(x = latbin, y = n, width = 1)) + 
  geom_col(aes(fill = SUBPOP)) +
  coord_flip() +
  facet_wrap(~FL_B4_SOL, ncol = 2, scales = "free_x") +
  scale_fill_manual(values = rev(color_code)) +
  theme(axis.text.x = element_text(hjust = 1, vjust = 1, angle = 45),
        legend.position = "none", panel.spacing.x = unit(x = 0, unit = "mm")) +
  scale_y_continuous(expand = c(0.002, 0.002), 
    labels = function(x) signif(abs(x), 3)) +
  ylab("Number of genotypes") +
  xlab("Latitude of origin") + labs(title = "TX1", subtitle = "Day length change on date of flowering") +
  xlim(c(24,45))
panelb <- dyln_latbin2 %>%
  left_join(sites, by = "SITE") %>%
  filter((SITE %in% c("PKLE"))) %>%
  mutate(n = case_when(FL_B4_SOL == "Lengthening" ~ -count,
                       TRUE ~ count)) %>%
  ggplot(aes(x = latbin, y = n, width = 1)) + 
  geom_col(aes(fill = SUBPOP)) +
  coord_flip() +
  facet_wrap(~FL_B4_SOL, ncol = 2, scales = "free_x") +
  scale_fill_manual(values = rev(color_code)) +
  theme(axis.text.x = element_text(hjust = 1, vjust = 1, angle = 45),
        legend.position = "none", panel.spacing.x = unit(x = 0, unit = "mm")) +
  scale_y_continuous(expand = c(0.002, 0.002), 
    labels = function(x) signif(abs(x), 3)) +
  ylab("Number of genotypes") +
  xlab("Latitude of origin") + labs(title = "TX2", subtitle = "Day length change on date of flowering") +
  xlim(c(24,45))
panelc <- dyln_latbin2 %>%
  left_join(sites, by = "SITE") %>%
  filter((SITE %in% c("TMPL"))) %>%
  mutate(n = case_when(FL_B4_SOL == "Lengthening" ~ -count,
                       TRUE ~ count)) %>%
  ggplot(aes(x = latbin, y = n, width = 1)) + 
  geom_col(aes(fill = SUBPOP)) +
  coord_flip() +
  facet_wrap(~FL_B4_SOL, ncol = 2, scales = "free_x") +
  scale_fill_manual(values = rev(color_code)) +
  theme(axis.text.x = element_text(hjust = 1, vjust = 1, angle = 45),
        legend.position = "right", panel.spacing.x = unit(x = 0, unit = "mm")) +
  scale_y_continuous(expand = c(0.002, 0.002), 
    labels = function(x) signif(abs(x), 3)) +
  ylab("Number of genotypes") +
  xlab("Latitude of origin") + labs(title = "TX3", subtitle = "Day length change on date of flowering") +
  xlim(c(24,45))

dyln_lat_plot <- plot_grid(panela, panelb, panelc, nrow = 1, rel_widths = c(1, 1, 1.318))
save_plot(filename = "../manuscript/plots/Daylength_changes_flowering_date_by_latitude_of_origin_and_subpop.png", plot = dyln_lat_plot, base_asp = 2.4, base_height = 4)
```

# --------------
# 4WCR Plots

We then planted the four parents, the two F1 individuals (AP13xDAC, and VS16xWBC), and XXX F2 individuals at eight field sites, and recorded greenup and flowering date for the 2016-2019 seasons. Though there was a X day gap in flowering date between the two F1 crosses, F1 individuals flowered at similar dates as the Midwest parents and Midwest subpopulation individuals in general, indicating that the flowering time genetic response to the Midwestern GDD levels was dominant to the photoperiod response and the higher GDD levels required by the Gulf subpopulation. 
```{r}
phe_F1 %>%
  filter(PHE == "FL50" & YEAR == 2019) %>%
  group_by(SITE, PLANT_ID) %>%
  summarise(fl50 = mean(MEAS, na.rm = TRUE)) %>%
  pivot_wider(names_from = PLANT_ID, values_from = fl50) %>%
  mutate(diff = VxW - AxD) %>%
  group_by(SITE) %>%
  summarise(meandiff = mean(diff)) %>%
  arrange(meandiff) %>%
  filter(!(SITE %in% c("OVTN", "MNHT"))) %>%
  summarise(meandiff = mean(meandiff))

F1plot <- phe_F1 %>%
  filter(PHE == "FL50" & (YEAR %in% c(2019) | (SITE == "TMPL" & YEAR == 2018)) & !(SITE %in% c("OVTN", "MNHT"))) %>%
  left_join(sites, by = "SITE") %>%
  group_by(manu_site, YEAR, PLANT_ID) %>%
  summarise(MEAS = mean(MEAS, na.rm = TRUE))
phe_all$SUBPOP <- factor(phe_all$SUBPOP, levels = rev(c("4X", "Atlantic", "Gulf", "Midwest", "8X")))
color_code <- c("grey", "#6E91CB","#F47F72", "#442C83", "#090906")

F1vsGWAS <- phe_all %>%
  left_join(sites, by = "SITE") %>%
  filter(PHE == "FL50" & WHERE == "GWAS" & !(SITE %in% c("FRMI", "OVTN")) & SUBPOP %in% c("Midwest", "Gulf")) %>%
  ggplot(aes(x = as_date(MEAS, origin = "2019-01-01"))) +
  geom_vline(xintercept = as_date(173, origin = "2019-01-01"), color = "#FDE725FF", size = 1) +
  geom_density(aes(color = SUBPOP)) + 
  facet_wrap(~manu_site, nrow = 2) +
  geom_vline(data = F1plot, aes(xintercept = as_date(MEAS, origin = "2019-01-01"), color = PLANT_ID), linetype = 2) +
  scale_color_manual(values = c("grey", "#F47F72", "#442C83",  "#090906")) +
  theme(legend.position = "right", axis.text.x = element_text(hjust = 1, vjust = 1, angle = 45)) +
  ylab("Subpop Fraction") + xlab("Flowering Date") +
  geom_hline(yintercept = 0, color = "darkgrey")
save_plot(filename = "../manuscript/plots/F1_vs_GWAS_distribution.png", plot = F1vsGWAS, base_asp = 2.5, base_height = 2.5)

F1vsGWAS_violin <- phe_all %>%
  left_join(sites, by = "SITE") %>%
  filter(PHE == "FL50" & WHERE == "GWAS" & !(SITE %in% c("FRMI", "OVTN")) & SUBPOP %in% c("Midwest", "Gulf")) %>%
  ggplot(aes(x = SUBPOP, y = as_date(MEAS, origin = "2019-01-01"))) +
  geom_hline(yintercept = as_date(173, origin = "2019-01-01"), color = "#FDE725FF", size = 1) +
  geom_violin(aes(fill = SUBPOP)) + 
  facet_wrap(~manu_site, nrow = 2) +
  geom_hline(data = F1plot, aes(yintercept = as_date(MEAS, origin = "2019-01-01"), color = PLANT_ID), linetype = 2) +
  scale_color_manual(values = c("grey",  "#090906", "#F47F72", "#442C83")) +
  scale_fill_manual(values = c("#442C83", "#F47F72")) +
  theme(legend.position = "right", axis.text.x = element_text(hjust = 1, vjust = 1, angle = 45)) +
  xlab("Subpopulation") + ylab("Flowering Date") + coord_flip()

save_plot(filename = "../manuscript/plots/F1_vs_GWAS_distribution_violin.png", plot = F1vsGWAS_violin, base_asp = 2.5, base_height = 2.5)

library(scales)
show_col(viridis(8, option = "B"))
```
## F0 Plot

"#D44842FF", "#280B54FF", "#9F2A63FF", "#FAC127FF"
```{r}
F0plot <- phe_F0 %>%
  filter(PHE == "FL50" & (YEAR %in% c(2016:2019)) & !(SITE %in% c("OVTN", "MNHT"))) %>%
  left_join(sites, by = "SITE") %>%
  group_by(manu_site, PLANT_ID) %>%
  summarise(MEAS = mean(MEAS, na.rm = TRUE))

F0vsGWAS <- phe_all %>%
  left_join(sites, by = "SITE") %>%
  filter(PHE == "FL50" & WHERE == "GWAS" & !(SITE %in% c("FRMI", "OVTN")) & SUBPOP %in% c("Midwest", "Gulf")) %>%
  ggplot(aes(x = SUBPOP, y = as_date(MEAS, origin = "2019-01-01"))) +
  geom_hline(yintercept = as_date(173, origin = "2019-01-01"), color = "#FDE725FF", size = 1) +
  geom_violin(aes(fill = SUBPOP)) + 
  facet_wrap(~manu_site, nrow = 2) +
  geom_hline(data = F0plot, aes(yintercept = as_date(MEAS, origin = "2019-01-01"), color = PLANT_ID), linetype = 2) +
  scale_fill_manual(values = c("#442C83", "#F47F72")) +
  scale_color_manual(values = c("#D44842FF", "#280B54FF", "#9F2A63FF", "#FAC127FF")) +
  coord_flip() + theme(legend.position = "right", axis.text.x = element_text(hjust = 1, vjust = 1, angle = 45)) +
  xlab("Subpopulation") + ylab("Flowering Date")
F0vsGWAS
save_plot(filename = "../manuscript/plots/F0_vs_GWAS_distribution.png", plot = F0vsGWAS)
```


```{r}
phe_F2 %>%
  group_by(PLANT_ID) %>%
  summarise(count = n()) %>% arrange(count)

FWCRvsGWAS <- phe_all %>%
  filter((WHERE == "FWCR") | (WHERE == "GWAS" & SUBPOP %in% c("Midwest", "Gulf"))) %>%
  filter(PHE == "FL50" & !(SITE %in% c("OVTN", "MNHT", "FRMI"))) %>%
  left_join(sites, by = "SITE") %>%
  dplyr::select(-(Longitude:Note))  %>%
  mutate(POP = case_when(WHERE == "FWCR" & !(PLANT_ID %in% c("AP13", "DAC", "VS16", "WBC", "AxD", "VxW")) ~ "F2",
                         WHERE == "FWCR" & (PLANT_ID %in% c("AP13", "DAC", "VS16", "WBC")) ~ "F0",
                         WHERE == "FWCR" & (PLANT_ID %in% c("AxD", "VxW")) ~ "F1",
                            WHERE == "GWAS" ~ as.character(SUBPOP)))

summary(as_factor(FWCRvsGWAS$POP))
F0plot <- phe_F0 %>%
  filter(PHE == "FL50" & (YEAR %in% c(2016:2019)) & !(SITE %in% c("OVTN", "MNHT"))) %>%
  left_join(sites, by = "SITE") %>%
  group_by(manu_site, PLANT_ID) %>%
  summarise(MEAS = mean(MEAS, na.rm = TRUE))

FWCRvsGWAS %>%
  filter(!(POP %in% c("F0", "F1")) & (YEAR == 2019 | (YEAR == 2018 & SITE == "TMPL"))) %>%
  ggplot(aes(x = POP, y = as_date(MEAS, origin = "2019-01-01"))) +
  geom_hline(yintercept = as_date(173, origin = "2019-01-01"), color = "#FDE725FF", size = 1) +
  geom_violin(aes(fill = POP)) + 
  facet_wrap(~manu_site, nrow = 2) +
  geom_hline(data = F0plot, aes(yintercept = as_date(MEAS, origin = "2019-01-01"), color = PLANT_ID), linetype = 2) +
  geom_hline(data = F1plot, aes(yintercept = as_date(MEAS, origin = "2019-01-01"), color = PLANT_ID), linetype = 3) +
  scale_fill_manual(values = c("lightgrey", "#F47F72", "#442C83")) +
  scale_color_manual(values = c("#D44842FF", "grey", "#280B54FF", "#9F2A63FF", "black", "#FAC127FF")) +
  coord_flip() + theme(legend.position = "right", axis.text.x = element_text(hjust = 1, vjust = 1, angle = 45)) +
  xlab("Subpopulation") + ylab("Flowering Date")

FWCRvsGWAS %>%
  filter(!(POP %in% c("F0", "F1")) & (YEAR == 2018 | (WHERE == "GWAS" & YEAR == 2019))) %>%
  ggplot(aes(x = POP, y = as_date(MEAS, origin = "2019-01-01"))) +
  geom_hline(yintercept = as_date(173, origin = "2019-01-01"), color = "#FDE725FF", size = 1) +
  geom_violin(aes(fill = POP)) + 
  facet_wrap(~manu_site, nrow = 2) +
  geom_hline(data = F0plot, aes(yintercept = as_date(MEAS, origin = "2019-01-01"), color = PLANT_ID), linetype = 2) +
  geom_hline(data = F1plot, aes(yintercept = as_date(MEAS, origin = "2019-01-01"), color = PLANT_ID), linetype = 3) +
  scale_fill_manual(values = c("lightgrey", "#F47F72", "#442C83")) +
  scale_color_manual(values = c("#D44842FF", "grey", "#280B54FF", "#9F2A63FF", "black", "#FAC127FF")) +
  coord_flip() + theme(legend.position = "right", axis.text.x = element_text(hjust = 1, vjust = 1, angle = 45)) +
  xlab("Subpopulation") + ylab("Flowering Date")

FWCRvsGWAS %>%
  filter(!(POP %in% c("F0", "F1")) & WHERE == "FWCR") %>%
  ggplot(aes(x = as_factor(YEAR), y = as_date(MEAS, origin = "2019-01-01"))) +
  geom_hline(yintercept = as_date(173, origin = "2019-01-01"), color = "#FDE725FF", size = 1) +
  geom_violin(aes(fill = as_factor(YEAR))) + 
  facet_wrap(~manu_site, nrow = 2) +
  geom_jitter(data = filter(FWCRvsGWAS, POP %in% c("F0", "F1")), aes(color = PLANT_ID), shape = 4, height = 0) +
  #geom_hline(data = F0plot, aes(yintercept = as_date(MEAS, origin = "2019-01-01"), color = PLANT_ID), linetype = 2) +
  #geom_hline(data = F1plot, aes(yintercept = as_date(MEAS, origin = "2019-01-01"), color = PLANT_ID), linetype = 3) +
  scale_fill_viridis(discrete = TRUE, end = 0.8) + 
  scale_color_manual(values = c("#D44842FF", "grey", "#280B54FF", "#9F2A63FF", "black", "#FAC127FF")) +
  coord_flip() + theme(legend.position = "right", axis.text.x = element_text(hjust = 1, vjust = 1, angle = 45)) +
  xlab("Year") + ylab("Flowering Date") + ylim(c(as_date(50, origin = "2019-01-01"), as_date(300, origin = "2019-01-01")))

save_plot(filename = "../manuscript/plots/FWCR_distribution_by_year.png", plot = last_plot())

FWCRvsGWAS %>%
  filter(!(POP %in% c("F0", "F1")) & WHERE == "FWCR") %>%
  ggplot(aes(x = as_factor(YEAR), y = as_date(MEAS, origin = "2019-01-01"))) +
  geom_hline(yintercept = as_date(173, origin = "2019-01-01"), color = "#FDE725FF", size = 1) +
  geom_jitter(data = filter(FWCRvsGWAS, POP %in% c("F0")), aes(color = PLANT_ID), shape = 4, height = 0) +
  geom_violin(aes(fill = as_factor(YEAR))) + 
  facet_wrap(~manu_site, nrow = 2) +
  
  #geom_hline(data = F0plot, aes(yintercept = as_date(MEAS, origin = "2019-01-01"), color = PLANT_ID), linetype = 2) +
  #geom_hline(data = F1plot, aes(yintercept = as_date(MEAS, origin = "2019-01-01"), color = PLANT_ID), linetype = 3) +
  scale_fill_viridis(discrete = TRUE, end = 0.8) + 
  scale_color_manual(values = c("#D44842FF", "#280B54FF", "#9F2A63FF",  "#FAC127FF")) +
  coord_flip() + theme(legend.position = "right", axis.text.x = element_text(hjust = 1, vjust = 1, angle = 45)) +
  xlab("Year") + ylab("Flowering Date") + ylim(c(as_date(50, origin = "2019-01-01"), as_date(300, origin = "2019-01-01")))

save_plot(filename = "../manuscript/plots/FWCR_F0_distribution_by_year.png", plot = last_plot())
  
```

(How many days behind the parents was each F1 cross, on average, across all 4 years of data?)  
```{r}
F1_F0_diff <- FWCRvsGWAS %>%
  filter((POP %in% c("F0", "F1")) & WHERE == "FWCR") %>%
  group_by(SITE, YEAR, PLANT_ID) %>%
  summarise(meanFL = mean(MEAS, na.rm = TRUE)) %>%
  pivot_wider(names_from = PLANT_ID, values_from = meanFL) %>%
  mutate(earlyFL_F1_F0_diff = AxD - DAC,
         lateFL_F1_F0_diff = VxW - VS16,
         earlyFL_F1_F0_diff_g = AP13 - AxD,
         lateFL_F1_F0_diff_g = WBC - VxW
         )  %>%
  ungroup()
F1_F0_diff %>%
  summarise(mean_early_F1_F0_diff = mean(earlyFL_F1_F0_diff, na.rm = TRUE),
            mean_late_F1_F0_diff = mean(lateFL_F1_F0_diff, na.rm = TRUE),
            mean_early_F1_F0_diff_g = mean(earlyFL_F1_F0_diff_g, na.rm = TRUE),
            mean_late_F1_F0_diff_g = mean(lateFL_F1_F0_diff_g, na.rm = TRUE))

sd(F1_F0_diff$earlyFL_F1_F0_diff, na.rm = TRUE)
sd(F1_F0_diff$lateFL_F1_F0_diff, na.rm = TRUE)
sd(F1_F0_diff$earlyFL_F1_F0_diff_g, na.rm = TRUE)
sd(F1_F0_diff$lateFL_F1_F0_diff_g, na.rm = TRUE)
```

```{r}
Gulf_minFL <- FWCRvsGWAS %>%
  filter((POP %in% c("F0"))) %>%
  group_by(SITE, YEAR, PLANT_ID) %>%
  summarise(minFL = min(MEAS, na.rm = TRUE)) %>%
  filter(PLANT_ID %in% c("AP13", "WBC")) %>%
  pivot_wider(names_from = PLANT_ID, values_from = minFL, names_prefix = "minFL_")
Gulf_meanFL <- FWCRvsGWAS %>%
  filter((POP %in% c("F0"))) %>%
  group_by(SITE, YEAR, PLANT_ID) %>%
  summarise(meanFL = mean(MEAS, na.rm = TRUE)) %>%
  filter(PLANT_ID %in% c("AP13", "WBC")) %>%
  pivot_wider(names_from = PLANT_ID, values_from = meanFL, names_prefix = "meanFL_")

F2_meanFL <- FWCRvsGWAS %>%
  filter((POP %in% c("F2"))) %>%
  group_by(SITE, YEAR, PLANT_ID) %>%
  summarise(meanFL = mean(MEAS, na.rm = TRUE)) %>% 
  left_join(Gulf_meanFL) %>%
  filter(meanFL > meanFL_AP13 | meanFL > meanFL_WBC)
F2_minFL <- FWCRvsGWAS %>%
  filter((POP %in% c("F2"))) %>%
  group_by(SITE, YEAR, PLANT_ID) %>%
  summarise(meanFL = mean(MEAS, na.rm = TRUE)) %>% 
  left_join(Gulf_minFL) %>%
  filter(meanFL >= minFL_AP13 | meanFL >= minFL_WBC)

F2_meanFL %>%
  group_by(YEAR, PLANT_ID) %>%
  tally() %>% arrange(desc(n))
F2_minFL %>%
  group_by( PLANT_ID) %>%
  tally() %>% arrange(desc(n))


478/14672
2308/14672
```
Only 3.26% of F2 flowering dates occurred after the average flowering date for one or both Gulf parents; 13.3% of F2 flowering dates occurred after the minimum flowering date for one or both Gulf parents.


Only 358 of 801 F2 individuals ever flowered after the average flowering date Gulf parent, and only 102 did so in more than one site or year. (13 in three + site/years, 2 in 5-6).

minimum flowering date for Gulf parents
PLANT_ID  n
91	15			
402	13			
105	12			
194	11			
210	11			
248	11			
196	10			
214	10	
