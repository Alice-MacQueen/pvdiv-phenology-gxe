---
title: "DYLN lag plots"
author: "Alice MacQueen"
date: "7/13/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(cowplot)
library(viridis)
library(lubridate)
source("~/Github/Functions_ggplot-theme-adjustments_2018-01-03.R")
```

#

```{r}
wea_df <- readRDS("~/Github/pvdiv-phenology-gxe/data/Weather_with_PTT_2019.rds")
metadata <- readRDS("~/Github/pvdiv-phenology-gxe/data/metadata.rds")
sites <- readRDS("~/Github/pvdiv-phenology-gxe/data/sites.rds")
phenotypes <- readRDS("~/Github/pvdiv-phenology-gxe/data/Phenology_CGDD_PTT_and_rainfall_phenotypes.rds")
jday_phe <- readRDS("~/Github/pvdiv-phenology-gxe/data/Julian_date_GDD_and_rainfall_phenotypes_4wcr_and_gwas.rds")
```

```{r}
jday_phe <- wea_df %>%
  group_by(SITE) %>%
  mutate(dyln_change_sec = (DYLN - lag(DYLN))*60*60,
         FL50 = yday(DOY)) %>%
  select(DOY, DYLN, dyln_change_sec, everything(), -PTT_12C) %>%
  right_join(jday_phe, by = c("SITE", "FL50"))
  
jday_phe <- jday_phe %>%
  select(-(TMAX:CPTT_11C))

sites <- wea_df %>%
  group_by(SITE) %>%
  filter(DOY == "2019-06-22") %>%
  select(SITE, DYLN) %>%
  rename(Longest_dyln = DYLN) %>%
  right_join(sites)

sites <- wea_df %>%
  group_by(SITE) %>%
  filter(DOY <= "2019-06-22") %>%
  summarise(CGDD_solstice = sum(GDD_12C_SM)) %>%
  right_join(sites)

asreml_h2 <- jday_phe %>%
  select(PLANT_ID:SITE, FL50:GR50, CGDD_12C, CRAIN, CRAIN_5d, -DOY) %>%
  rename(dyln_fl50 = DYLN, cgdd_12c_gr2fl = CGDD_12C, crain_gr2fl = CRAIN) %>%
  left_join(wea_df) %>%
  group_by(SITE, PLOT_GL) %>%
  filter(between(DOY, as_date(FL50, origin = "2019-01-01") - 6, as_date(FL50, origin = "2019-01-01"))) %>%
  mutate(crain_2d = RAIN_SM + lag(RAIN_SM),
         crain_3d = RAIN_SM + lag(RAIN_SM) + lag(RAIN_SM, n = 2),
         crain_7d = sum(RAIN_SM)) %>%
  filter(DOY == as_date(FL50, origin = "2019-01-01")) %>%
  filter(SUBPOP %in% c("Midwest", "Gulf") & !(SITE %in% c("OVTN", "FRMI")))
asreml_h2 <- asreml_h2 %>%
  select(-(TMAX:CPTT_13C))
saveRDS(asreml_h2, file = "../data/Weather_related_phe_for_asreml_h2.rds")
```



```{r}
jday_phe <- metadata %>%
  rename(Lat_origin = LATITUDE, Long_origin = LONGITUDE) %>%
  select(PLANT_ID, SUBPOP, Lat_origin, Long_origin) %>%
  right_join(jday_phe)
jday_phe <- jday_phe %>%
  left_join(sites)

jday_phe$SUBPOP <- factor(jday_phe$SUBPOP, levels = c("4X", "Atlantic", "Gulf", "Midwest", "8X"))
jday_phe$SITE <- factor(jday_phe$SITE, levels = c("KING", "PKLE", "TMPL", "OVTN", "STIL", "CLMB", "LINC", "FRMI", "KBSM", "BRKG"))
jday_phe$manu_site <- factor(jday_phe$manu_site, levels = rev(c("TX1", "TX2", "TX3", "TX4", "OK", "MO", "NE", "IL", "MI", "SD")))
```

```{r}
color_code <- c("grey", "#6E91CB","#F47F72", "#442C83", "#090906", "grey")
col1 <- jday_phe %>%
  filter(!(SITE %in% c("OVTN", "FRMI")) & !is.na(SUBPOP)) %>%
  ggplot(aes(x = dyln_change_sec)) + 
  geom_density(aes(group = SUBPOP, color = SUBPOP), size = 0.75) + 
  facet_wrap(~manu_site, scales = "free", nrow = 8) + 
  geom_vline(xintercept = 0, linetype = 2) +
  theme(legend.position = "none", axis.text = element_text(size = 8)) +
  scale_color_manual(values = color_code) + 
  xlim(c(-200, 150)) +
  xlab("Daylength change (s) at 
       flowering") + 
  ylab("Density")
save_plot("../manuscript/plots/Dyln_change_by_site.png", plot = col1, base_height = 8, base_asp = 0.3)

col2 <- jday_phe %>%
  filter(!(SITE %in% c("OVTN", "FRMI")) & !is.na(SUBPOP)) %>%
  ggplot(aes(x = DYLN)) + 
  geom_density(aes(group = SUBPOP, color = SUBPOP), size = 0.75) + 
  facet_wrap(~manu_site, scales = "free_y", nrow = 8) + 
  geom_vline(data = filter(sites, !(SITE %in% c("OVTN", "FRMI"))),
             aes(xintercept = Longest_dyln), linetype = 2) +
  theme(legend.position = "none", axis.text = element_text(size = 8)) +
  scale_color_manual(values = color_code) + 
  xlim(c(10, 16)) +
  xlab("Daylength (hrs) at 
       flowering") + 
  ylab("Density")
save_plot("../manuscript/plots/Dyln_by_site.png", plot = col2, base_height = 8, base_asp = 0.3)
  
col3 <- jday_phe %>%
  filter(!(SITE %in% c("OVTN", "FRMI")) & !is.na(SUBPOP)) %>%
  ggplot(aes(x = CRAIN_5d)) + 
  geom_density(aes(group = SUBPOP, color = SUBPOP), size = 0.75) + 
  facet_wrap(~manu_site, scales = "free_y", nrow = 8) + 
  theme(legend.position = "none", axis.text = element_text(size = 8)) +
  scale_color_manual(values = color_code) + 
  xlab("Rainfall (mm) five days
       before flowering") + 
  ylab("Density")
save_plot("../manuscript/plots/CRAIN_5d_by_site.png", plot = col3, base_height = 8, base_asp = 0.3)
 
col4 <- jday_phe %>%
  filter(!(SITE %in% c("OVTN", "FRMI")) & !is.na(SUBPOP)) %>%
  ggplot(aes(x = CGDD_12C)) + 
  geom_density(aes(group = SUBPOP, color = SUBPOP), size = 0.75) + 
  facet_wrap(~manu_site, scales = "free_y", nrow = 8) + 
  theme(legend.position = "none", axis.text = element_text(size = 8)) +
  scale_color_manual(values = color_code) + 
  xlab("Cumulative GDD 
       (12C) at flowering") + 
  ylab("Density")
save_plot("../manuscript/plots/CGDD_by_site.png", plot = col4, base_height = 8, base_asp = 0.3)

col5 <- jday_phe %>%
  filter(!(SITE %in% c("OVTN", "FRMI")) & !is.na(SUBPOP)) %>%
  ggplot(aes(x = as_date(FL50, origin = "2019-01-01"))) + 
  geom_density(aes(group = SUBPOP, color = SUBPOP), size = 0.75) + 
  geom_vline(xintercept = as_date(173, origin = "2019-01-01"), linetype = 2) +
  facet_wrap(~manu_site, scales = "free_y", nrow = 8) + 
  theme(legend.position = "none", axis.text = element_text(size = 8)) +
  scale_color_manual(values = color_code) + 
  xlab("Flowering 
       Date") + 
  ylab("Density")
save_plot("../manuscript/plots/FL50_by_site.png", plot = col5, base_height = 8, base_asp = 0.3)

FL50_1 <- plot_grid(col5, col2, col1, col4, col3, nrow = 1)
save_plot("../manuscript/plots/Five_FL50_weather_cues_by_site.png", plot = FL50_1, base_height = 8, base_width = 9.85)
```

Same plots but histograms for just Gulf and Midwest
consign all the other groups to the supplement
```{r}
hist_phe <- jday_phe %>%
  filter(!(SITE %in% c("OVTN", "FRMI"))  & SUBPOP %in% c("Gulf", "Midwest"))
color_code <- c("#F47F72", "#442C83")
col1 <- hist_phe %>%
  ggplot(aes(x = dyln_change_sec)) + 
  geom_histogram(aes(group = SUBPOP, fill = SUBPOP), binwidth = 10) + 
  facet_wrap(~manu_site, scales = "free_y", nrow = 8) + 
  geom_vline(xintercept = 0, linetype = 2) +
  theme(legend.position = "none", axis.text = element_text(size = 8)) +
  scale_fill_manual(values = color_code) + 
  xlim(c(-200, 105)) +
  xlab("Daylength change (s) at 
       flowering") + 
  ylab("")
save_plot("../manuscript/plots/Dyln_change_by_site_histogram.png", plot = col1, base_height = 7.5, base_asp = 0.27)

col2 <- hist_phe %>%
  ggplot(aes(x = DYLN)) + 
  geom_histogram(aes(group = SUBPOP, fill = SUBPOP), binwidth = 0.15) + 
  facet_wrap(~manu_site, scales = "free_y", nrow = 8) + 
  geom_vline(data = filter(sites, !(SITE %in% c("OVTN", "FRMI"))),
             aes(xintercept = Longest_dyln), linetype = 2) +
  theme(legend.position = "none", axis.text = element_text(size = 8)) +
  scale_fill_manual(values = color_code) + 
  xlim(c(11, 15.55)) +
  xlab("Daylength (hrs) at 
       flowering") + 
  ylab("")
save_plot("../manuscript/plots/Dyln_by_site_histogram.png", plot = col2, base_height = 7.5, base_asp = 0.27)
  
col3 <- hist_phe %>%
  ggplot(aes(x = CRAIN_5d)) + 
  geom_histogram(aes(group = SUBPOP, fill = SUBPOP), binwidth = 10) + 
  facet_wrap(~manu_site, scales = "free_y", nrow = 8) + 
  theme(legend.position = "none", axis.text = element_text(size = 8)) +
  scale_fill_manual(values = color_code) + 
  xlab("Rainfall (mm) five days
       before flowering") + 
  ylab("")
save_plot("../manuscript/plots/CRAIN_5d_by_site_histogram.png", plot = col3, base_height = 7.5, base_asp = 0.27)
 
col4 <- hist_phe %>%
  ggplot(aes(x = CGDD_12C)) + 
  geom_histogram(aes(group = SUBPOP, fill = SUBPOP), binwidth = 100) + 
  geom_vline(data = filter(sites, !(SITE %in% c("OVTN", "FRMI"))),
             aes(xintercept = CGDD_solstice), linetype = 2) +
  facet_wrap(~manu_site, scales = "free_y", nrow = 8) + 
  theme(legend.position = "none", axis.text = element_text(size = 8)) +
  scale_fill_manual(values = color_code) + 
  xlab("Cumulative GDD 
       (12C) at flowering") + 
  ylab("")
save_plot("../manuscript/plots/CGDD_by_site_histogram.png", plot = col4, base_height = 7.5, base_asp = 0.27)

col5 <- hist_phe %>%
  ggplot(aes(x = as_date(FL50, origin = "2019-01-01"))) + 
  geom_histogram(aes(group = SUBPOP, fill = SUBPOP), binwidth = 8) + 
  geom_vline(xintercept = as_date(173, origin = "2019-01-01"), linetype = 2) +
  facet_wrap(~manu_site, scales = "free_y", nrow = 8) + 
  theme(legend.position = "none", axis.text = element_text(size = 8)) +
  scale_fill_manual(values = color_code) + 
  xlab("Flowering 
       Date") + 
  ylab("Number of Individuals")
save_plot("../manuscript/plots/FL50_by_site_histogram.png", plot = col5, base_height = 7.5, base_asp = 0.27)

col7 <- hist_phe %>%
  ggplot(aes(x = as_date(GR50, origin = "2019-01-01"))) + 
  geom_histogram(aes(group = SUBPOP, fill = SUBPOP), binwidth = 8) + 
  geom_vline(xintercept = as_date(173, origin = "2019-01-01"), linetype = 2) +
  facet_wrap(~manu_site, scales = "free_y", nrow = 8) + 
  theme(legend.position = "none", axis.text = element_text(size = 8)) +
  scale_fill_manual(values = color_code) + 
  xlab("Greenup 
       Date") + 
  ylab("Number of Individuals")
save_plot("../manuscript/plots/GR50_by_site_histogram.png", plot = col7, base_height = 7.5, base_asp = 0.27)

col6 <- hist_phe %>%
  ggplot(aes(x = CRAIN)) + 
  geom_histogram(aes(group = SUBPOP, fill = SUBPOP), binwidth = 50) + 
  facet_wrap(~manu_site, scales = "free_y", nrow = 8) + 
  theme(legend.position = "none", axis.text = element_text(size = 8)) +
  scale_fill_manual(values = color_code) + 
  xlab("Rainfall (mm) greenup
       to flowering") + 
  ylab("")
save_plot("../manuscript/plots/CRAIN_by_site_histogram.png", plot = col6, base_height = 7.5, base_asp = 0.27)

FL50_1 <- plot_grid(col5, col2, col1, col4, col3, nrow = 1)
save_plot("../manuscript/plots/Five_FL50_weather_cues_by_site_histogram.png", plot = FL50_1, base_height = 7.5, base_asp = 1.3)

FL50_2 <- plot_grid(col5, col2, col1, col4, nrow = 1)
save_plot("../manuscript/plots/Four_FL50_weather_cues_by_site_histogram.png", plot = FL50_2, base_height = 7.5, base_asp = 1)

FL50_3 <- plot_grid(col7, col5, col6, col3, nrow = 1)
save_plot("../manuscript/plots/GR50_FL50_CRAIN_by_site_histogram.png", plot = FL50_3, base_height = 7.5, base_asp = 1)
```
## ASReml: Heritabilities for these phenotypes, defined by particular environmental cues. The reasoning being that if a phenotype defined by a cue has higher heritability, it's more likely that that cue is playing a role in flowering. I could just introduce all of these traits this way and talk about them this way, instead of introducing and defeating hypotheses. That might also be a softer start. 

# ASReml-R analyses on server

```{r}
library(tidyverse)
library(asreml)
library(switchgrassGWAS)
library(cowplot)
library(viridis)
library(corpcor)
```

```{r}
source("~/Github/Functions_ggplot-theme-adjustments_2018-01-03.R")
workingdir <- file.path("~", "Github", "pvdiv-phenology-gxe")
outputdir <- file.path(workingdir, "manuscript", "plots")
metadata <- read_rds(file.path(workingdir, "data", "metadata.rds"))
sites <- read_rds(file.path(workingdir, "data", "sites.rds"))
subpops <- read_rds(file.path(workingdir, "data", "subpop_color_coding.rds"))
phe <- read_rds(file.path(workingdir, "data",
                          "Weather_related_phe_for_asreml_h2.rds"))
```

```{r}
k_full <- read_rds("~/Github/pvdiv-genome/tensite_twoyear/Kinship_van_Raden_630_individuals_SNPs_r2_20percent.rds")
#k_mid <- read_rds("~/Github/pvdiv-genome/tensite_twoyear/Kinship_van_Raden_method_138_individuals_midwest_genotype_and_admixed.rds")
#k_gulf <- read_rds("~/Github/pvdiv-genome/tensite_twoyear/Kinship_van_Raden_method_214_individuals_gulf_genotype_and_admixed.rds")
```

```{r}
site_v <- c("TX1", "TX2", "TX3", "OK", "MO", "NE", "MI", "SD")
subpop_v <- c("Gulf", "Midwest")
phe_v <- c("dyln_fl50", "dyln_change_sec", "FL50", "GR50", "cgdd_12c_gr2fl",
           "crain_gr2fl", "CRAIN_5d", "crain_2d", "crain_3d", "crain_7d")
i = 1
j = 1
k = 1

phe_single$SUBPOP <- phe_single(dyln_cue$SUBPOP, levels = c("Midwest", "Gulf",
                                                            "Atlantic", "4X",
                                                            "8X"))
h2_table <- tibble()

for(i in 4:8){
  for(j in seq_along(subpop_v)){
    for(k in seq_along(phe_v)){
      phe_single <- phe %>%
  left_join(sites) %>%
  filter(manu_site == site_v[i] & SUBPOP %in% subpop_v[j]) %>%
  rename(phenotype = eval(phe_v[k])) %>%
  mutate(PLANT_ID = as_factor(PLANT_ID),
         SITE = as_factor(SITE),
         PLOT_GL = as_factor(PLOT_GL)) %>%
  as.data.frame()


asr_out <- asreml(phenotype ~ 1,
                   random = ~vm(PLANT_ID, k_full),
                   residual = ~idv(units),
                   data = phe_single, 
                   workspace = "3gb")
#phe_v[k]
#summary(asr_out)$varcomp
#summary(asr_out)$bic
h2_est <- vpredict(asr_out, h2 ~ V1/(V1+V2)) %>% as_tibble() %>%
  mutate(site = site_v[i],
         subpop = subpop_v[j],
         phe = phe_v[k],
         bic = summary(asr_out)$bic[1],
         loglik = summary(asr_out)$loglik)

if(i == 1 & j == 1 & k == 1){
  h2_table <- add_row(h2_est)
} else {
  h2_table <- add_row(h2_table, h2_est)
}
tryCatch({
    save_plot(filename=file.path(outputdir, paste0("ASReml_performance_",
                                               site_v[i], "_", subpop_v[j],
                                               "_", phe_v[k], ".png")), 
          plot = plot(asr_out))
  }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})

    }
  }
}

```
factors:
PLANT_ID, SUBPOP (if both Gulf & Midwest are included), SITE/manu_site (if multiple sites are included)
covariates:
Lat_origin

```{r}
site_v <- c("TX1", "TX2", "TX3", "OK", "MO", "NE", "MI", "SD")
subpop_v <- c("Gulf", "Midwest")
phe_v <- c("dyln_fl50", "dyln_change_sec", "FL50", "GR50", "cgdd_12c_gr2fl",
           "crain_gr2fl", "CRAIN_5d", "crain_2d", "crain_3d", "crain_7d")
i = 1
k = 1

phe_single$SUBPOP <- phe_single(dyln_cue$SUBPOP, levels = c("Midwest", "Gulf",
                                                            "Atlantic", "4X",
                                                            "8X"))
h2_table <- tibble()

for(i in seq_along(site_v)){
    for(k in seq_along(phe_v)){
phe_single <- phe %>%
  left_join(sites) %>%
  filter(manu_site == site_v[i] & SUBPOP %in% subpop_v) %>%
  rename(phenotype = eval(phe_v[k])) %>%
  mutate(PLANT_ID = as_factor(PLANT_ID),
         SITE = as_factor(SITE),
         PLOT_GL = as_factor(PLOT_GL)) %>%
  as.data.frame()


asr_out <- asreml(phenotype ~ 1,
                   random = ~vm(PLANT_ID, k_full),
                   residual = ~idv(units),
                   data = phe_single, 
                   workspace = "3gb")
#phe_v[k]
#summary(asr_out)$varcomp
#summary(asr_out)$bic
h2_est <- vpredict(asr_out, h2 ~ V1/(V1+V2)) %>% as_tibble() %>%
  mutate(site = site_v[i],
         subpop = "Gulf_and_Midwest",
         phe = phe_v[k],
         bic = summary(asr_out)$bic[1],
         loglik = summary(asr_out)$loglik)

#if(i == 1 & j == 1 & k == 1){
#  h2_table <- add_row(h2_est)
#} else {
  h2_table <- add_row(h2_table, h2_est)
#}
tryCatch({
    save_plot(filename=file.path(outputdir, paste0("ASReml_performance_",
                                               site_v[i], "_Gulf_and_Midwest_",
                                               phe_v[k], ".png")), 
          plot = plot(asr_out))
  }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})

    }
  }

# all sites for subpops separately
for(j in seq_along(subpop_v)){
  for(k in seq_along(phe_v)){
  phe_single <- phe %>%
    left_join(sites) %>%
    filter(manu_site %in% site_v & SUBPOP %in% subpop_v[j]) %>%
    rename(phenotype = eval(phe_v[k])) %>%
    mutate(PLANT_ID = as_factor(PLANT_ID),
           SITE = as_factor(SITE),
           PLOT_GL = as_factor(PLOT_GL)) %>%
    as.data.frame()
  
  
  asr_out <- asreml(phenotype ~ 1,
                     random = ~vm(PLANT_ID, k_full) +
                       ~idv(SITE),
                     residual = ~idv(units),
                     data = phe_single, 
                     workspace = "3gb")
  #phe_v[k]
  #summary(asr_out)$varcomp
  #summary(asr_out)$bic
  h2_est <- vpredict(asr_out, h2 ~ V2/(V1+V2+V3)) %>% as_tibble() %>%
    mutate(site = site_v[i],
           subpop = subpop_v[j],
           phe = phe_v[k],
           bic = summary(asr_out)$bic[1],
           loglik = summary(asr_out)$loglik)

#if(i == 1 & j == 1 & k == 1){
#  h2_table <- add_row(h2_est)
#} else {
  h2_table <- add_row(h2_table, h2_est)
#}
  tryCatch({
      save_plot(filename=file.path(outputdir, paste0("ASReml_performance_",
                                                 "eight_sites_", subpop_v[j],
                                                 "_", phe_v[k], ".png")), 
            plot = plot(asr_out))
    }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})

  }
}

# all sites for both midwest & gulf
for(k in seq_along(phe_v)){
      phe_single <- phe %>%
  left_join(sites) %>%
  filter(manu_site %in% site_v & SUBPOP %in% subpop_v) %>%
  rename(phenotype = eval(phe_v[k])) %>%
  mutate(PLANT_ID = as_factor(PLANT_ID),
         SITE = as_factor(SITE),
         PLOT_GL = as_factor(PLOT_GL)) %>%
  as.data.frame()


asr_out <- asreml(phenotype ~ 1,
                   random = ~vm(PLANT_ID, k_full),
                   residual = ~idv(units),
                   data = phe_single, 
                   workspace = "3gb")
#phe_v[k]
#summary(asr_out)$varcomp
#summary(asr_out)$bic
h2_est <- vpredict(asr_out, h2 ~ V2/(V1+V2+V3)) %>% as_tibble() %>%
  mutate(site = site_v[i],
         subpop = subpop_v[j],
         phe = phe_v[k],
         bic = summary(asr_out)$bic[1],
         loglik = summary(asr_out)$loglik)

if(i == 1 & j == 1 & k == 1){
  h2_table <- add_row(h2_est)
} else {
  h2_table <- add_row(h2_table, h2_est)
}
tryCatch({
    save_plot(filename=file.path(outputdir, paste0("ASReml_performance_",
                                               "eight_sites_Gulf_and_Midwest",
                                               "_", phe_v[k], ".png")), 
          plot = plot(asr_out))
  }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})

}
```




also dyln at flowering
also dyln change as a function of latitude of origin
also dyln as a function of lat of origin?

```{r}
jday_phe <- jday_phe %>%
  mutate(Lat_origin_1 = round(Lat_origin))

jday_phe %>%
  filter(!(SITE %in% c("OVTN", "FRMI")) & !is.na(SUBPOP)) %>%
  ggplot(aes(x = dyln_change_sec, y = Lat_origin)) + 
  geom_point(aes(group = SUBPOP, color = SUBPOP), alpha = 0.75) + 
  facet_grid(manu_site~SUBPOP, scales = "free") + geom_vline(xintercept = 0, linetype = 2) +
  theme(legend.position = "right") +
  scale_color_manual(values = color_code) + xlim(c(-200, 150)) +
  xlab("Daylength change on day of flowering (s)")


jday_phe %>%
  filter(!(SITE %in% c("OVTN", "FRMI")) & !is.na(SUBPOP)) %>%
  ggplot(aes(x = DYLN, y = Lat_origin)) + 
  geom_point(aes(group = manu_site, color = manu_site), alpha = 0.4) + 
  facet_wrap(~SUBPOP, scales = "free_y", nrow = 2) + geom_vline(xintercept = 0, linetype = 2) +
  theme(legend.position = "right") +
  scale_color_viridis(discrete = TRUE, end = 0.95) + xlim(c(10.5, 16.5))
  xlab("Daylength on day of flowering")
  
  jday_phe %>%
  filter((manu_site %in% c("TX1", "TX2", "TX3")) & SUBPOP %in% c("Gulf", "Midwest")) %>%
  ggplot(aes(x = dyln_change_sec, y = Lat_origin_1)) + 
  geom_boxplot(aes(group = Lat_origin_1), orientation = "y") + 
    geom_point(aes(y = Lat_origin, color = SUBPOP), alpha = 0.3) +
  facet_wrap(~manu_site, scales = "free") + geom_vline(xintercept = 0, linetype = 2) +
  theme(legend.position = "right") +
  scale_color_manual(values = color_code[3:4]) + 
  xlab("Daylength change on day of flowering (s)")

  ?geom_boxplot
```

# Plot ASReml h2 on map
load data from previous section also (line 268; ASReml-R analyses on server)
```{r}
h2_table <- read_csv("~/Github/pvdiv-phenology-gxe/analysis/heritability/h2_table_single_site_and_eight_site_midwest_and_gulf_subpops_FL50.csv")
library(maps)
library(ggmap)
usa <- map_data("usa")
```

```{r}
h2plot <- h2_table %>%
  left_join(sites, by = c("site" = "manu_site"))
```


```{r}
h2plot %>%
  filter(subpop == "Gulf_and_Midwest" & phe %in% c("FL50", "crain_gr2fl", "dyln_change_sec", "cgdd_12c_gr2fl", "dyln_fl50", "crain_2d", "CRAIN_5d")) %>%
  ggplot() + 
  geom_polygon(data = usa, aes(x=long, y = lat, group = group), fill = "white", 
               color = "black") +
  coord_quickmap(xlim = c(-105, -66), ylim = c(25, 50)) +
  geom_jitter(aes(x = Longitude, y = Latitude, 
                                  color = Estimate, shape = phe),
              width = 1, height = 1) + 
  labs(x = "Longitude", y = "Latitude") + 
  theme(legend.position = "right") +
  scale_color_viridis(option = "B", end = 0.95) +
  scale_shape_manual(values = c(21,22,24,20,3,4,5)) 
  #scale_fill_manual(values = c("#280B54FF","#FAC127FF", "#D44842FF", "white")) +
  #scale_color_manual(values = c(rep("black", 10), "#280B54FF","#FAC127FF", "#D44842FF", "white", "#280B54FF","#FAC127FF", "#D44842FF", "white"), guide = FALSE) +
  #scale_alpha_manual(values = c(0.7, 0.7, 0.7, 0.7), guide = FALSE)
save_plot(filename = "Map_subpops_and_Ecotypes.svg", plot = last_plot(), base_height = 5)

```

