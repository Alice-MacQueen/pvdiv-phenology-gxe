---
title: "biomass mash"
author: "Alice MacQueen"
date: "3/12/2020"
output:
  word_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(switchgrassGWAS)
library(ashr)
source("~/Github/Functions_ggplot-theme-adjustments_2018-01-03.R")
```

## 

```{r, cache = TRUE, include = FALSE}
m <- readRDS("~/Github/pvdiv-phenology-gxe/analysis/all-phenotypes-two-years/BIOMASS/Strong_Effects25684SNPs.rds")
gxe <- get_GxE(m)
covariances <- readRDS("~/Github/pvdiv-phenology-gxe/analysis/all-phenotypes-two-years/BIOMASS/Mash_data_driven_covariances_25684.rds")
```


```{r, include=FALSE, cache = TRUE}
#' Return the estimated mixture proportions
#' @param m the mash result
#' @param dimension indicates whether you want the mixture proportions for the covariances, grid, or all
#' @return a named vector containing the estimated mixture proportions.
#' @details If the fit was done with `usepointmass=TRUE` then the first element of the returned vector will correspond to the null, and the remaining elements
#' to the non-null covariance matrices.
#' Suppose the fit was done with $K$ covariances and a grid of length $L$.
#' If `dimension=cov` then the returned vector will be of length $K$ (or $K+1$ if
#' `usepointmass=TRUE`).  If `dimension=grid` then the returned vector will be of length $L$ (or $L+1$).
#' If `dimension=all` then the returned vector will be of length $LK$ (or $LK+1$).
#' The names of the vector will be informative for which combination each element corresponds to.
#' @importFrom ashr get_fitted_g
#' @export
get_estimated_pi = function(m, dimension = c("cov","grid","all")){
  dimension = match.arg(dimension)
  if(dimension=="all"){
    get_estimated_pi_no_collapse(m)
  } else {
    g = get_fitted_g(m)
    pihat = g$pi
    pihat_names = NULL
    pi_null = NULL

    if(g$usepointmass){
      pihat_names=c("null",pihat_names)
      pi_null = pihat[1]
      pihat = pihat[-1]
    }

    pihat = matrix(pihat,nrow=length(g$Ulist))
    if(dimension=="cov"){
      pihat = rowSums(pihat)
      pihat_names = c(pihat_names,names(g$Ulist))
    } else if(dimension=="grid"){
      pihat = colSums(pihat)
      pihat_names = c(pihat_names,1:length(g$grid))
    }

    pihat = c(pi_null,pihat)
    names(pihat) = pihat_names
    return(pihat)
  }
}

get_estimated_pi_no_collapse = function(m){
  g = get_fitted_g(m)
  pihat = g$pi
  names(pihat) = names(expand_cov(g$Ulist, g$grid, g$usepointmass))
  pihat
}

```


```{r, cache = TRUE}
covar <- enframe(get_estimated_pi(m), name = "Covariances")

covar[21,2]*100
enframe(get_estimated_pi(m), name = "Covariances") %>%
  ggplot(aes(x = Covariances, y = value)) + geom_bar(stat = "identity") +
  theme(axis.text.x = element_text(hjust = 1, angle = 45))
```
`r covar[21,2]*100`% of all effects load on to the "Equal Effects" covariance matrix.

Here is the pattern of effects for ED_PCA_1. The SITES are in alphabetical order - BRKG is X1,  CLMB X2, etc. 
```{r, cache = TRUE}
mash_plot_pairwise_sharing(corrmatrix = covariances$ED_PCA_1)
```

# Differential Sensitivity
```{r, cache = TRUE}
length(get_significant_results(m))
mash_plot_pairwise_sharing(corrmatrix = gxe$S_DS)
max(gxe$S_DS)
min(gxe$S_DS)
```
`r length(get_significant_results(m))` SNPs have significant effects in the mash analysis. Of those, between `r min(gxe$S_DS)` and `r max(gxe$S_DS)` have differentially significant effects between pairs of conditions.

# Antagonistic Pleiotropy
```{r, cache = TRUE}
mash_plot_pairwise_sharing(corrmatrix = gxe$S_AP)
```
`r length(get_significant_results(m))` SNPs have significant effects in the mash analysis. Of those, between `r min(gxe$S_AP)` and `r max(gxe$S_AP)` have antagonistically pleiotropic effects between pairs of conditions.

Between `r min(gxe$S_2_no)` and `r max(gxe$S_2_no)` have effects of the same magnitude and same sign between pairs of conditions.
