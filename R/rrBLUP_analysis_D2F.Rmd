---
title: "BLUP anaysis"
author: "Alice MacQueen"
date: "8/6/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(rlang)
library(rrBLUP)
library(switchgrassGWAS)
library(viridis)
library(cowplot)
```



## Present BLUPs/breeding values

```{r load data}
V_g <- readRDS(file.path("~", "Github", "pvdiv-phenology-gxe", "data",
                            paste0("Kinship_van_Raden_method_363g_",
                                   "Midwest_and_Gulf_subset_maf0.05.rds")))
phe <- readRDS("~/Github/pvdiv-phenology-gxe/data/Phenotypes_D2F_fourway_project.rds")
metadata <- read_rds(file.path("~", "Github", "pvdiv-phenotypes", "data", "metadata.rds")) %>%
  mutate(SUBPOP = case_when(!is.na(GENETIC_SUBPOP_KINSHIP) ~ as.character(GENETIC_SUBPOP_KINSHIP),
                            !is.na(PLOIDY) ~ as.character(PLOIDY),
                            TRUE ~ NA_character_))

phe_site <- phe %>%
  pivot_longer(cols = -PLANT_ID, names_to = "SITE_PHE", values_to = "MEAS") %>%
  separate(SITE_PHE, into = c("SITE", "PHE")) %>%
  pivot_wider(names_from = "PHE", values_from = "MEAS")

sites <- read_rds("~/Github/pvdiv-phenotypes/data/sites.rds")
fourway_sites <- c("BRKG", "CLMB", "KBSM", "KING", "LINC", "PKLE", "STIL")
```

```{r}
phe_post <- readRDS("~/Github/pvdiv-phenotypes/data/post_replant/Phenotypes_long_non_Blackwell_replants_post_2019_replant.rds")
phe_pre <- readRDS("~/Github/pvdiv-phenotypes/data/pre_replant/Phenotypes_all_pre_2019_replant.rds")

phe_pre2 <- phe_pre %>% 
  mutate(PLANT_ID = case_when(grepl("AP13", PLANT_ID) ~ "AP13",
                              TRUE ~ PLANT_ID)) %>%
  dplyr::select(SITE, PLOT_GL, PLANT_ID, TC_EOS_2018, GR1:GR50, SRV)

phe_post2 <- phe_post %>%
  mutate(PLANT_ID = case_when(grepl("AP13", PLANT_ID) ~ "AP13",
                              TRUE ~ PLANT_ID)) %>%
  separate(SITE_PHE, into = c("site", "PHE"), sep = c(5)) %>%
  dplyr::select(-site) %>%
  filter(PHE %in% c("GR50","FL1", "FL50", "BIOMASS", "TC_EOS", "HT_PAN_EOS", "EM1", "EM50", "SRV")) %>%
   pivot_wider(names_from = "PHE", values_from = "MEAS") %>%
  group_by(PLANT_ID, SITE) %>% add_tally(name = "Per_site_count") %>%
  dplyr::select(SITE:PLANT_ID, Per_site_count, everything())

phe_all <- phe_post2 %>%
  left_join(phe_pre2, by = c("SITE", "PLOT_GL", "PLANT_ID"))

phe_all %>%
  dplyr::select(SITE:PLANT_ID, BIOMASS, SRV) %>%
  write_rds(., path = "~/Github/pvdiv-fitness-2019/data/All_phenotypes_fitness.rds")
```

# Instead of D2F, PTT2F? photothermal time to flowering, from greenup.

```{r}
ptt_df <- readRDS(file = "~/Github/pvdiv-phenology-gxe/data/Weather_with_PTT_2019.rds")

gdd_df <- ptt_df %>%
  mutate(GDD_0C_SM = ifelse((TMAX_SM + TMIN_SM)/2 >= 0,
                      (TMAX_SM + TMIN_SM)/2 - 0,
                      0)) %>%
  dplyr::select(DOY, SITE, Day_of_year, DYLN, GDD_13C_SM:GDD_8C_SM, GDD_0C_SM)

GR_start <- phe_all %>% 
  left_join(metadata, by = "PLANT_ID") %>%
  #filter(D2F > 10 & SUBPOP == "Midwest") %>%
  ungroup() %>%
  group_by(SITE, PLOT_GL, PLANT_ID) %>%
  summarise(GR_start = floor(min(GR50)))
FL_end <- phe_all %>% 
  ungroup() %>%
  group_by(SITE, PLOT_GL, PLANT_ID) %>%
  summarise(FL_end = ceiling(max(FL50)))

tmp2 <- gdd_df %>%
  dplyr::select(DOY, SITE, Day_of_year, DYLN, GDD_13C_SM:GDD_0C_SM) %>%
  left_join(GR_start, by = "SITE") %>%
  left_join(FL_end, by = c("SITE", "PLOT_GL", "PLANT_ID")) %>%
  group_by(SITE, Day_of_year, PLOT_GL, PLANT_ID) %>%
  filter(between(Day_of_year, GR_start, FL_end)) %>% 
  ungroup()

tmp2 %>%
  group_by(SITE, PLOT_GL, PLANT_ID, GR_start, FL_end) %>%
  summarise(CGDD_0C = sum(GDD_0C_SM),
            CGDD_8C = sum(GDD_8C_SM),
            CGDD_13C = sum(GDD_13C_SM),
            CDYLN = sum(DYLN),
            min_dyln = min(DYLN),
            mean_dyln = mean(DYLN),
            max_dyln = max(DYLN),
            sd_dyln = sd(DYLN),
            cv_dyln = mean_dyln / sd_dyln
            ) %>%
  left_join(metadata) %>%
  dplyr::select(-(LIBRARY:PLANTED_2018)) %>%
  left_join(phe_all)
  mutate(D2F = FL_end - GR_start) %>%
  filter(D2F > 10) %>%
  ggplot(aes(x = CGDD_13C, y = CDYLN)) + 
  geom_point(aes(color = SUBPOP)) + facet_wrap(~SITE) 
  
phe_meta <- phe_all %>%
  left_join(metadata) %>%
  dplyr::select(-(LIBRARY:PLANTED_2018))

library(lubridate)
library(viridis)

tmp2$SITE <- factor(tmp2$SITE, levels = c("KING", "PKLE", "TMPL", "OVTN", "STIL", "CLMB", "LINC", "FRMI", "KBSM", "BRKG"))
phe_meta$SITE <- factor(phe_meta$SITE, levels = c("KING", "PKLE", "TMPL", "OVTN", "STIL", "CLMB", "LINC", "FRMI", "KBSM", "BRKG"))
tmp2 %>%
  dplyr::select(DOY, DYLN, SITE) %>%
  unique() %>%
  filter(SITE != "OVTN") %>%
  ggplot(aes(x = DOY, y = DYLN)) + 
    geom_point() + 
    facet_wrap(~SITE) + 
    geom_jitter(data = filter(phe_meta, SITE != "OVTN" & SUBPOP %in% c("Midwest", "Gulf")), aes(x = as_date(FL1, origin = "2018-12-31"), color = SUBPOP, y = 6.5), width = 0, height = 1, alpha = 0.15) + ylim(c(3,16)) + 
    geom_jitter(data = filter(phe_meta, SITE != "OVTN" & SUBPOP %in% c("Midwest", "Gulf")), aes(x = as_date(FL50, origin = "2018-12-31"), color = SUBPOP, y = 4), width = 0, height = 1, alpha = 0.2) +
  scale_color_viridis(discrete = TRUE, end = 0.8, direction = -1) + xlab("Day of year") + ylab("Daylength (hrs)") +
  geom_vline(xintercept = as_date(365/2-8, origin = "2018-12-31"), linetype = 2) +
  geom_text(aes(y = 4, x = as_date(40, origin = "2018-12-31"), label = "FL50")) +
  geom_text(aes(y = 6.5, x = as_date(32, origin = "2018-12-31"), label = "FL1")) +
  geom_text(aes(y = 9, x = as_date(40, origin = "2018-12-31"), label = "GR50")) + 
    geom_jitter(data = filter(phe_meta, SITE != "OVTN" & SUBPOP %in% c("Midwest", "Gulf")), aes(x = as_date(GR50, origin = "2018-12-31"), color = SUBPOP, y = 9), width = 0, height = 1, alpha = 0.1)

save_plot(filename = "../analysis/environmental-index/Daylength_vs_GR_FL1_FL50_Gulf_and_Midwest_10_sites_2019_longest_day_line.png", plot = last_plot(), base_height = 6)


```


# Analysis for pvdiv like I did for the CDBN
```{r}
# PHE <- list(quote(BRKG_D2F), quote(CLMB_D2F))
PHE <- list(quote(FL50), quote(GR50), quote(BIOMASS), quote(TC_EOS), 
            quote(HT_PAN_EOS), quote(FL1), quote(EM1), quote(EM50),
            quote(TC_EOS_2018), quote(GR1))
rrkinblupout <- list()
kinseqblup <- list()
bluptable <- list()

for(i in seq_along(PHE)){

  testdf <- phe_all %>%
    left_join(metadata) %>%
    filter(!is.na(eval(PHE[[i]])) & GENETIC_SUBPOP_KINSHIP %in% c("Midwest", 
                                                                    "Gulf")) %>%
    as.data.frame()
  
  bluprrk <- kin.blup(data = testdf, geno = "PLANT_ID", pheno = deparse(PHE[[i]]),
                        K = V_g, fixed = "SITE") # , fixed = c("Location_code", "LbY")
  
  rrkinblupout[[i]] <- enframe(bluprrk$g, name = "PLANT_ID", 
                               value = deparse(PHE[[i]])) 
      
    # Which Taxa were phenotyped for this phenotype? Just keep those for GWAS.
  taxa_phenotyped <- testdf %>%
    dplyr::select(PLANT_ID, !! PHE[[i]]) %>%
    as_tibble() %>%
    group_by(PLANT_ID) %>%
    summarise(count = n())
  kinseqblup[[i]] <- taxa_phenotyped %>%
    left_join(rrkinblupout[[i]], by = "PLANT_ID")
  
  bluptable[[i]] <- tibble(Phenotype = deparse(PHE[[i]]), V_a = bluprrk$Vg, 
                      V_e = bluprrk$Ve) %>%
    mutate(h2 = V_a / (V_a + V_e))

  saveRDS(bluprrk, paste0("~/Github/pvdiv-phenology-gxe/data-raw/ignore/", 
                          PHE[[i]],
                          "_363g_Gulf_and_Midwest_10Site_BLUPs_kinship.rds"))
}
```
From Houle 1992:

Crow 1958: "opportunity for selection": I = V_P / X_bar^2
X_bar represents the population mean before selection.
V_P phenotypic trait variance. `var()`

To calculate CV (coefficient of variation) you take the standard deviation of the data and divide it by the mean of the data.  sqrt(V_P) / X_bar

I is related to the phenotypic coefficient of variation, CV_P = 100*sqrt(V_P) / X_bar
(this is just CV * 100 to be a percentage).

Relative evolvability of fitness:

I_A = V_A / X_bar^2 = (CV_A / 100)^2
I_A is also an appropriate indicator of the variability of fitness as large values must be the result of powerful forces maintaining genetic variance. 

A variance to mean ratio is the most appropriate measure of the evolvability of a trait.


Compared three quantities:

Residual coefficient of variation CV_R = 100 * sqrt(V_P - V_A) / X_bar

h^2 narrow sense heritability = V_A / V_P

CV_A = 100*sqrt(V_A) / X_bar

```{r}
phe_all %>% left_join(metadata) %>%
  pivot_longer(values_to = "MEAS", cols = TC_EOS:GR50, names_to = "PHE") %>%
  dplyr::select(-LIBRARY, -(GENETIC_SUBPOP_KINSHIP:PLANTED_2018)) %>%
  filter(SUBPOP %in% c("Gulf", "Midwest")) %>%
  group_by(SUBPOP, SITE, PHE) %>%
  summarise(X_bar = mean(MEAS, na.rm = TRUE),
            V_P = var(MEAS, na.rm = TRUE),
            I = V_P / X_bar^2, 
            CV_P = 100*sqrt(V_P) / X_bar) %>%
  arrange(desc(I))

cov

BLUPs <- select(metadata, PLANT_ID, SUBPOP) %>%
  filter(SUBPOP %in% c("Midwest", "Gulf")) %>%
  left_join(dplyr::select(kinseqblup[[1]], PLANT_ID, 3))

for(i in seq_along(kinseqblup)[-1]){
  BLUPs <- BLUPs %>%
    left_join(dplyr::select(kinseqblup[[i]], PLANT_ID, 3))
}

BLUPtable <- bluptable[[1]]

for(i in seq_along(bluptable)[-1]){
  BLUPtable <- BLUPtable %>%
    full_join(bluptable[[i]])
}

BLUPtable
phe_all %>% left_join(metadata) %>%
  pivot_longer(values_to = "MEAS", cols = TC_EOS:GR50, names_to = "PHE") %>%
  dplyr::select(-LIBRARY, -(GENETIC_SUBPOP_KINSHIP:PLANTED_2018)) %>%
  filter(SUBPOP %in% c("Gulf", "Midwest")) %>%
  group_by(PHE) %>%
  summarise(X_bar = mean(MEAS, na.rm = TRUE),
            V_P = var(MEAS, na.rm = TRUE),
            I = V_P / X_bar^2, 
            CV_P = 100*sqrt(V_P) / X_bar) %>%
  arrange(desc(I)) %>%
  full_join(BLUPtable, by = c("PHE" = "Phenotype")) %>%
  mutate(I_A = V_a / X_bar^2,
         CV_R = 100 * sqrt(V_P - V_a) / X_bar, 
         CV_A = 100 * sqrt(V_a) / X_bar,
         CV_E = 100 * sqrt(V_e) / X_bar) %>%
  write_csv(., "~/Github/pvdiv-phenology-gxe/data-raw/ignore/Phenotypic_CVs_10_site_fixed_effects_363g_Gulf_and_Midwest.csv")
```
# Start here
- want to break down heritabilities etc by site and by subpop
- want to do this for D2F and GDD_GR2FL also. Find these quantities for phe_all.


# h^2 etc for Midwest
```{r}
# PHE <- list(quote(BRKG_D2F), quote(CLMB_D2F))
PHE <- list(quote(FL50), quote(GR50), quote(BIOMASS), quote(TC_EOS), 
            quote(HT_PAN_EOS), quote(FL1), quote(EM1), quote(EM50),
            quote(TC_EOS_2018), quote(GR1))
rrkinblupout <- list()
kinseqblup <- list()
bluptable <- list()

for(i in seq_along(PHE)){

  testdf <- phe_all %>%
    left_join(metadata) %>%
    filter(!is.na(eval(PHE[[i]])) & GENETIC_SUBPOP_KINSHIP %in% c("Midwest", 
                                                                    "Gulf")) %>%
    as.data.frame()
  
  bluprrk <- kin.blup(data = testdf, geno = "PLANT_ID", pheno = deparse(PHE[[i]]),
                        K = V_g, fixed = "SITE") # , fixed = c("Location_code", "LbY")
  
  rrkinblupout[[i]] <- enframe(bluprrk$g, name = "PLANT_ID", 
                               value = deparse(PHE[[i]])) 
      
    # Which Taxa were phenotyped for this phenotype? Just keep those for GWAS.
  taxa_phenotyped <- testdf %>%
    dplyr::select(PLANT_ID, !! PHE[[i]]) %>%
    as_tibble() %>%
    group_by(PLANT_ID) %>%
    summarise(count = n())
  kinseqblup[[i]] <- taxa_phenotyped %>%
    left_join(rrkinblupout[[i]], by = "PLANT_ID")
  
  bluptable[[i]] <- tibble(Phenotype = deparse(PHE[[i]]), V_a = bluprrk$Vg, 
                      V_e = bluprrk$Ve) %>%
    mutate(h2 = V_a / (V_a + V_e))

  saveRDS(bluprrk, paste0("~/Github/pvdiv-phenology-gxe/data-raw/ignore/", 
                          PHE[[i]],
                          "_363g_Gulf_and_Midwest_10Site_BLUPs_kinship.rds"))
}
```
From Houle 1992:

Crow 1958: "opportunity for selection": I = V_P / X_bar^2
X_bar represents the population mean before selection.
V_P phenotypic trait variance. `var()`

To calculate CV (coefficient of variation) you take the standard deviation of the data and divide it by the mean of the data.  sqrt(V_P) / X_bar

I is related to the phenotypic coefficient of variation, CV_P = 100*sqrt(V_P) / X_bar
(this is just CV * 100 to be a percentage).

Relative evolvability of fitness:

I_A = V_A / X_bar^2 = (CV_A / 100)^2
I_A is also an appropriate indicator of the variability of fitness as large values must be the result of powerful forces maintaining genetic variance. 

A variance to mean ratio is the most appropriate measure of the evolvability of a trait.


Compared three quantities:

Residual coefficient of variation CV_R = 100 * sqrt(V_P - V_A) / X_bar

h^2 narrow sense heritability = V_A / V_P

CV_A = 100*sqrt(V_A) / X_bar

```{r}
phe_all %>% left_join(metadata) %>%
  pivot_longer(values_to = "MEAS", cols = TC_EOS:GR50, names_to = "PHE") %>%
  dplyr::select(-LIBRARY, -(GENETIC_SUBPOP_KINSHIP:PLANTED_2018)) %>%
  filter(SUBPOP %in% c("Gulf", "Midwest", "Atlantic")) %>%
  group_by(SUBPOP, SITE, PHE) %>%
  summarise(X_bar = mean(MEAS, na.rm = TRUE),
            V_P = var(MEAS, na.rm = TRUE),
            I = V_P / X_bar^2, 
            CV_P = 100*sqrt(V_P) / X_bar) %>%
  arrange(PHE, SITE, SUBPOP)

BLUPs <- select(metadata, PLANT_ID, SUBPOP) %>%
  filter(SUBPOP %in% c("Midwest", "Gulf")) %>%
  left_join(dplyr::select(kinseqblup[[1]], PLANT_ID, 3))

for(i in seq_along(kinseqblup)[-1]){
  BLUPs <- BLUPs %>%
    left_join(dplyr::select(kinseqblup[[i]], PLANT_ID, 3))
}

BLUPtable <- bluptable[[1]]

for(i in seq_along(bluptable)[-1]){
  BLUPtable <- BLUPtable %>%
    full_join(bluptable[[i]])
}

BLUPtable
phe_all %>% left_join(metadata) %>%
  pivot_longer(values_to = "MEAS", cols = TC_EOS:GR50, names_to = "PHE") %>%
  dplyr::select(-LIBRARY, -(GENETIC_SUBPOP_KINSHIP:PLANTED_2018)) %>%
  filter(SUBPOP %in% c("Gulf", "Midwest")) %>%
  group_by(PHE) %>%
  summarise(X_bar = mean(MEAS, na.rm = TRUE),
            V_P = var(MEAS, na.rm = TRUE),
            I = V_P / X_bar^2, 
            CV_P = 100*sqrt(V_P) / X_bar) %>%
  arrange(desc(I)) %>%
  full_join(BLUPtable, by = c("PHE" = "Phenotype")) %>%
  mutate(I_A = V_a / X_bar^2,
         CV_R = 100 * sqrt(V_P - V_a) / X_bar, 
         CV_A = 100 * sqrt(V_a) / X_bar,
         CV_E = 100 * sqrt(V_e) / X_bar) %>%
  write_csv(., "~/Github/pvdiv-phenology-gxe/data-raw/ignore/Phenotypic_CVs_10_site_fixed_effects_363g_Gulf_and_Midwest.csv")
```

Table:
Phenotype: Used to get the BLUP solution for the genetic values, or breeding values
Vg: REML estimate of the genetic variance
Ve: REML estimate of the error variance
h2: Narrow sense heritability, Vg / (Vg + Ve)

```{r}
i = 1

rrblupout <- readRDS(paste0("../data-raw/", PHE[[i]], "_BLUPs_kinship.rds"))

bluprange <- max(rrblupout$g) - min(rrblupout$g)
ggplot(METG_Seq327) +
  geom_histogram(aes(x = !! sym(PHE[[i]])))

CIrow <- METG_Seq327 %>%
  summarise(lowCI = quantile(!! sym(PHE[[i]]), 0.025, na.rm = TRUE),
            upCI = quantile(!! sym(PHE[[i]]), 0.975, na.rm = TRUE),
            count = sum(!is.na(!! sym(PHE[[i]]))))
CItable <- tibble(Phenotype = deparse(PHE[[i]]), `lower bound` = CIrow$lowCI,
                  `upper bound` = CIrow$upCI, range = bluprange, count = CIrow$count)

for(i in seq_along(PHE)[-1]){
  rrblupout <- readRDS(paste0("../data-raw/", PHE[[i]], "_BLUPs_kinship.rds"))
  bluprange <- max(rrblupout$g) - min(rrblupout$g)
  CIrow <- METG_Seq327 %>%
  summarise(lowCI = quantile(!! sym(PHE[[i]]), 0.025, na.rm = TRUE),
            upCI = quantile(!! sym(PHE[[i]]), 0.975, na.rm = TRUE),
            count = sum(!is.na(!! sym(PHE[[i]]))))
  CItable <- add_row(CItable, Phenotype = deparse(PHE[[i]]), `lower bound` = CIrow$lowCI,
                  `upper bound` = CIrow$upCI, range = bluprange, count = CIrow$count)
}

blupstable <- bluptable %>% 
  left_join(CItable)

write_csv(blupstable, path = "BLUP_Descriptive_Statistics.csv")

blupstable <- blupstable %>%
  add_column(sigFDR = c(0, 0, 0, 0, 1, 1, 0, 0, 1, 0, 1, 1, 0, 0, 1, 0, 0, 1, 1, 0, 0))

wilcox.test(x = blupstable$count[blupstable$sigFDR == 0], y = blupstable$count[blupstable$sigFDR == 1], paired = FALSE, alternative = "l")
wilcox.test(x = blupstable$h2[blupstable$sigFDR == 0], y = blupstable$h2[blupstable$sigFDR == 1], paired = FALSE, alternative = "l")
```



# Per subpop analysis

# Analysis for pvdiv like I did for the CDBN
```{r}
# PHE <- list(quote(BRKG_D2F), quote(CLMB_D2F))
PHE <- list(quote(FL50), quote(GR50), quote(BIOMASS), quote(TC_EOS), 
            quote(HT_PAN_EOS), quote(FL1), quote(EM1), quote(EM50),
            quote(TC_EOS_2018), quote(GR1))
rrkinblupout <- list()
kinseqblup <- list()
bluptable <- list()

for(i in seq_along(PHE)){

  testdf <- phe_all %>%
    left_join(metadata) %>%
    filter(!is.na(eval(PHE[[i]])) & GENETIC_SUBPOP_KINSHIP %in% c("Midwest")) %>%
    as.data.frame()
  
  bluprrk <- kin.blup(data = testdf, geno = "PLANT_ID", pheno = deparse(PHE[[i]]),
                        K = V_g, fixed = "SITE") # , fixed = c("Location_code", "LbY")
  
  rrkinblupout[[i]] <- enframe(bluprrk$g, name = "PLANT_ID", 
                               value = deparse(PHE[[i]])) 
      
    # Which Taxa were phenotyped for this phenotype? Just keep those for GWAS.
  taxa_phenotyped <- testdf %>%
    dplyr::select(PLANT_ID, !! PHE[[i]]) %>%
    as_tibble() %>%
    group_by(PLANT_ID) %>%
    summarise(count = n())
  kinseqblup[[i]] <- taxa_phenotyped %>%
    left_join(rrkinblupout[[i]], by = "PLANT_ID")
  
  bluptable[[i]] <- tibble(Phenotype = deparse(PHE[[i]]), V_a = bluprrk$Vg, 
                      V_e = bluprrk$Ve) %>%
    mutate(h2 = V_a / (V_a + V_e))

  saveRDS(bluprrk, paste0("~/Github/pvdiv-phenology-gxe/data-raw/ignore/", 
                          PHE[[i]],
                          "_134g_Midwest_10Site_BLUPs_kinship.rds"))
}
```

```{r}
BLUPs <- select(metadata, PLANT_ID, SUBPOP) %>%
  filter(SUBPOP %in% c("Midwest")) %>%
  left_join(dplyr::select(kinseqblup[[1]], PLANT_ID, 3))

for(i in seq_along(kinseqblup)[-1]){
  BLUPs <- BLUPs %>%
    left_join(dplyr::select(kinseqblup[[i]], PLANT_ID, 3))
}

BLUPtable <- bluptable[[1]]

for(i in seq_along(bluptable)[-1]){
  BLUPtable <- BLUPtable %>%
    full_join(bluptable[[i]])
}

BLUPtable
phe_all %>% left_join(metadata) %>%
  pivot_longer(values_to = "MEAS", cols = TC_EOS:GR50, names_to = "PHE") %>%
  dplyr::select(-LIBRARY, -(GENETIC_SUBPOP_KINSHIP:PLANTED_2018)) %>%
  filter(SUBPOP %in% c("Midwest")) %>%
  group_by(PHE) %>%
  summarise(X_bar = mean(MEAS, na.rm = TRUE),
            V_P = var(MEAS, na.rm = TRUE),
            I = V_P / X_bar^2, 
            CV_P = 100*sqrt(V_P) / X_bar) %>%
  arrange(desc(I)) %>%
  full_join(BLUPtable, by = c("PHE" = "Phenotype")) %>%
  mutate(I_A = V_a / X_bar^2,
         CV_R = 100 * sqrt(V_P - V_a) / X_bar, 
         CV_A = 100 * sqrt(V_a) / X_bar,
         CV_E = 100 * sqrt(V_e) / X_bar) %>%
  write_csv(., "~/Github/pvdiv-phenology-gxe/data-raw/ignore/Phenotypic_CVs_10_site_fixed_effects_134g_Midwest.csv")
```

# Per site analysis

GR50, D2F, FL50, and CGDD_13C

```{r}
gdd_all <- tmp2 %>%
  group_by(SITE, PLOT_GL, PLANT_ID, FL_end, GR_start) %>%
  summarise(CGDD_0C = sum(GDD_0C_SM),
            CGDD_8C = sum(GDD_8C_SM),
            CGDD_13C = sum(GDD_13C_SM),
            CDYLN = sum(DYLN)
            ) %>%
  mutate(D2F = FL_end - GR_start) %>%
  left_join(metadata) %>%
  dplyr::select(-(LIBRARY:PLANTED_2018)) %>%
  left_join(phe_all)
```

```{r}
i=1; j = 7; k=3
(i-1)*length(fourway_site_list)*length(subpop_list) + (k-1)*length(subpop_list) + j
```
15 phe (i), 7 sites (k), 3 subpops (j)

Would like to compare subpops at each site and for each phe.
so same phe number is closest together

i*j*k + j*k + j

```{r}
PHE <- list(quote(CGDD_13C), quote(CGDD_8C), quote(CGDD_0C), quote(D2F), quote(FL50), quote(GR50), quote(CDYLN), quote(BIOMASS), quote(TC_EOS), 
            quote(HT_PAN_EOS), quote(FL1), quote(EM1), quote(EM50),
             quote(GR1))  # quote(TC_EOS_2018),
fourway_site_list <- list(quote(BRKG), quote(CLMB), quote(KBSM), quote(KING), quote(LINC), quote(PKLE), quote(STIL))
subpop_list <- list(Midwest_and_Gulf = c("Midwest", "Gulf"), Gulf = c("Gulf"),
                    Midwest = c("Midwest")) #, Full = c("Atlantic", "Gulf",
                                             #        "Midwest"))

rrkinblupout <- list()
kinseqblup <- list()
bluptable <- list()

for(i in seq_along(PHE)){
  for(k in seq_along(fourway_site_list)){
    for(j in seq_along(subpop_list)){

      list_counter <- (i-1)*length(fourway_site_list)*length(subpop_list) + (k-1)*length(subpop_list) + j
  testdf <- gdd_all %>%
    left_join(metadata, by = c("PLANT_ID", "SUBPOP")) %>%
    filter(!is.na(eval(PHE[[i]])) & 
             GENETIC_SUBPOP_KINSHIP %in% subpop_list[[j]] & 
             SITE %in% deparse(fourway_site_list[[k]])) %>%
    as.data.frame()
  
  bluprrk <- kin.blup(data = testdf, geno = "PLANT_ID", 
                      pheno = deparse(PHE[[i]]), K = V_g) #, fixed = c("SITE")
  
  rrkinblupout[[list_counter]] <- enframe(bluprrk$g, name = "PLANT_ID", 
                               value = deparse(PHE[[i]])) 
      
    # Which Taxa were phenotyped for this phenotype? Just keep those for GWAS.
  taxa_phenotyped <- testdf %>%
    dplyr::select(PLANT_ID, !! PHE[[i]]) %>%
    as_tibble() %>%
    group_by(PLANT_ID) %>%
    summarise(count = n())
  kinseqblup[[list_counter]] <- taxa_phenotyped %>%
    left_join(rrkinblupout[[list_counter]], by = "PLANT_ID")
  
  bluptable[[list_counter]] <- tibble(Phenotype = deparse(PHE[[i]]), 
                                      V_a = bluprrk$Vg, V_e = bluprrk$Ve,
                                      SITE = deparse(fourway_site_list[[k]]),
                                      Subpop = names(subpop_list)[j]) %>%
    mutate(h2 = V_a / (V_a + V_e))

  #saveRDS(bluprrk, paste0("~/Github/pvdiv-phenology-gxe/data-raw/ignore/", 
  #                        "Kinship_BLUPs_", fourway_site_list[[k]], "_",
  #                        PHE[[i]], "_", nrow(taxa_phenotyped), "g_",
  #                        names(subpop_list)[j], ".rds"))
    }
  }
}

```

```{r}
BLUPs <- select(metadata, PLANT_ID, SUBPOP) %>%
  filter(SUBPOP %in% c("Midwest", "Gulf")) %>%
  left_join(dplyr::select(kinseqblup[[1]], PLANT_ID, 3))

for(i in seq_along(kinseqblup)[-1]){
  BLUPs <- BLUPs %>%
    left_join(dplyr::select(kinseqblup[[i]], PLANT_ID, 3))
}

BLUPtable <- bluptable[[1]]

for(i in seq_along(bluptable)[-1]){
  if(!is.null(bluptable[[i]])){
  BLUPtable <- BLUPtable %>%
    full_join(bluptable[[i]])
  }
}

BLUPtable
gdd_all %>% left_join(metadata) %>%
  pivot_longer(values_to = "MEAS", cols = c(CGDD_0C:D2F, TC_EOS:GR50), names_to = "PHE") %>%
  dplyr::select(-LIBRARY, -(GENETIC_SUBPOP_KINSHIP:PLANTED_2018)) %>%
  filter(SUBPOP %in% c("Midwest", "Gulf")) %>%
  group_by(PHE, SITE, SUBPOP) %>%
  summarise(X_bar = mean(MEAS, na.rm = TRUE),
            V_P = var(MEAS, na.rm = TRUE),
            I = V_P / X_bar^2, 
            CV_P = 100*sqrt(V_P) / X_bar) %>%
  #arrange(desc(I)) %>%
  full_join(BLUPtable, by = c("PHE" = "Phenotype", "SITE", "SUBPOP" = "Subpop")) %>%
  mutate(I_A = V_a / X_bar^2,
         CV_R = 100 * sqrt(V_P - V_a) / X_bar, 
         CV_A = 100 * sqrt(V_a) / X_bar,
         CV_E = 100 * sqrt(V_e) / X_bar) %>%
  filter(SITE %in% fourway_sites) %>%
  arrange(SUBPOP, PHE, SITE) %>%
  write_csv(., "~/Github/pvdiv-phenology-gxe/data-raw/ignore/Phenotypic_CVs_Individual_sites.csv")

gdd_all %>% left_join(metadata) %>%
  pivot_longer(values_to = "MEAS", cols = c(CGDD_0C:D2F, TC_EOS:GR50), names_to = "PHE") %>%
  dplyr::select(-LIBRARY, -(GENETIC_SUBPOP_KINSHIP:PLANTED_2018)) %>%
  filter(SUBPOP %in% c("Midwest", "Gulf")) %>%
  group_by(PHE, SITE) %>%
  summarise(X_bar = mean(MEAS, na.rm = TRUE),
            V_P = var(MEAS, na.rm = TRUE),
            I = V_P / X_bar^2, 
            CV_P = 100*sqrt(V_P) / X_bar) %>%
  #arrange(desc(I)) %>%
  full_join(BLUPtable, by = c("PHE" = "Phenotype", "SITE")) %>%
  mutate(I_A = V_a / X_bar^2,
         CV_R = 100 * sqrt(V_P - V_a) / X_bar, 
         CV_A = 100 * sqrt(V_a) / X_bar,
         CV_E = 100 * sqrt(V_e) / X_bar) %>%
  filter(SITE %in% fourway_sites) %>%
  arrange(Subpop, PHE, SITE) %>%
  write_csv(., "~/Github/pvdiv-phenology-gxe/data-raw/ignore/Phenotypic_CVs_Individual_sites_2.csv")
```

```{r}
h2table <- read_csv("~/Github/pvdiv-phenology-gxe/data-raw/ignore/Phenotypic_CVs_Individual_sites_Gulf_Midwest.csv")

h2table %>%
  mutate(I_A = V_a / X_bar^2,
         CV_R = 100 * sqrt(V_P - V_a) / X_bar, 
         CV_A = 100 * sqrt(V_a) / X_bar,
         CV_E = 100 * sqrt(V_e) / X_bar) %>%
  filter(PHE == "D2F") %>%
  ggplot(aes(x = SUBPOP, y = h2)) + 
  geom_bar(stat = "identity") + facet_wrap(~SITE) + ylim(c(0,1)) + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
save_plot(filename = "../analysis/Heritability_D2F_by_Site_and_Subpop.png", 
          plot = last_plot())

h2table %>%
  mutate(I_A = V_a / X_bar^2,
         CV_R = 100 * sqrt(V_P - V_a) / X_bar, 
         CV_A = 100 * sqrt(V_a) / X_bar,
         CV_E = 100 * sqrt(V_e) / X_bar) %>%
  filter(PHE == "FL50") %>%
  ggplot(aes(x = SUBPOP, y = h2)) + 
  geom_bar(stat = "identity") + facet_wrap(~SITE) + ylim(c(0,1)) + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
save_plot(filename = "../analysis/Heritability_FL50_by_Site_and_Subpop.png", 
          plot = last_plot())

h2table %>%
  mutate(I_A = V_a / X_bar^2,
         CV_R = 100 * sqrt(V_P - V_a) / X_bar, 
         CV_A = 100 * sqrt(V_a) / X_bar,
         CV_E = 100 * sqrt(V_e) / X_bar) %>%
  filter(PHE == "GR50") %>%
  ggplot(aes(x = SUBPOP, y = h2)) + 
  geom_bar(stat = "identity") + facet_wrap(~SITE) + ylim(c(0,1)) + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
save_plot(filename = "../analysis/Heritability_GR50_by_Site_and_Subpop.png", 
          plot = last_plot())

h2table %>%
  mutate(I_A = V_a / X_bar^2,
         CV_R = 100 * sqrt(V_P - V_a) / X_bar, 
         CV_A = 100 * sqrt(V_a) / X_bar,
         CV_E = 100 * sqrt(V_e) / X_bar) %>%
  filter(PHE %in% c("CGDD_0C", "CGDD_8C", "CGDD_13C", "D2F", "FL50", "CDYLN", "FL1", "GR50")) %>%
  ggplot(aes(x = PHE, y = h2)) + 
  geom_point(aes(color = SUBPOP)) + facet_wrap(~SITE) + ylim(c(0,1)) + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
  scale_color_viridis(discrete = TRUE, end = 0.8, direction = -1)
save_plot(filename = "../analysis/Heritability_Various_flowering_time_measures_by_Site_and_Subpop.png", 
          plot = last_plot())
```

