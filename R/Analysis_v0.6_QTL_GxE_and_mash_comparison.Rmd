---
title: "Analysis_v0.7_QTL_GxE"
author: "Alice MacQueen"
date: "1/26/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(cowplot)
library(here)
library(data.table)
```

# TRIAL script
# -------------------------
NB: Trial script to compare the QTL to the mash results using env covar matrices.

## 3a. Log-likelihoods
```{r}
source("~/Github/Functions_ggplot-theme-adjustments_2018-01-03.R")
mashdir <- here("analysis", "mash_greedy_algorithm", "mash_h2_diag_covar")

numSNPs_v <- c(19000, 19000, 19000, 19000, 24000, 33000)
suffix_v <- c("FL50_Gulf_and_Midwest", "FL50_Gulf", "GR50_Gulf_and_Midwest",
              "GR50_Gulf", "GR50_Midwest", "FL50_Midwest")
```


```{r}
m_gulf_gr_hyp <- readRDS(file.path(mashdir,  
                                   paste0("Strong_mash_posterior_",
                                          "est_w_ahm_random_greedy_h2_diag_Ulist", 
                                          numSNPs_v[4], "_SNPs_",
                                          suffix_v[4], ".rds")))
m_gulf_fl_hyp <- readRDS(file.path(mashdir,  
                                   paste0("Strong_mash_posterior_",
                                          "est_w_ahm_random_greedy_h2_diag_Ulist", 
                                          numSNPs_v[2], "_SNPs_",
                                          suffix_v[2], ".rds")))

m_midw_gr_hyp <- readRDS(file.path(mashdir,  
                                   paste0("Strong_mash_posterior_",
                                          "est_w_ahm_random_greedy_h2_diag_Ulist", 
                                          numSNPs_v[5], "_SNPs_",
                                          suffix_v[5], ".rds")))
m_midw_fl_hyp <- readRDS(file.path(mashdir,  
                                   paste0("Strong_mash_posterior_",
                                          "est_w_ahm_random_greedy_h2_diag_Ulist", 
                                          numSNPs_v[6], "_SNPs_",
                                          suffix_v[6], ".rds")))

m_gam_gr_hyp <- readRDS(file.path(mashdir,  
                                   paste0("Strong_mash_posterior_",
                                          "est_w_ahm_random_greedy_h2_diag_Ulist", 
                                          numSNPs_v[3], "_SNPs_",
                                          suffix_v[3], ".rds")))
m_gam_fl_hyp <- readRDS(file.path(mashdir,  
                                   paste0("Strong_mash_posterior_",
                                          "est_w_ahm_random_greedy_h2_diag_Ulist", 
                                          numSNPs_v[1], "_SNPs_",
                                          suffix_v[1], ".rds")))

```

## QTL
```{r}
qtldf <- read_csv("~/Github/pvdiv-phenology-gxe/phenology-fourway/5-QTLmappingForAlice/QTLsWithFlankMarkers_FL50_phenotypes_Alice_7_SITES_Full_model.csv")

qtldf <- qtldf %>%
  separate(flank_lo, into = c("CHR", "Pos_Mb_lo"), sep = "_", convert = TRUE) %>%
  separate(flank_hi, into = c("flank", "Pos_Mb_hi"), sep = "_", convert = TRUE) %>%
  mutate(Pos_Mb_lo = round(Pos_Mb_lo, digits = 2),
         Pos_Mb_hi = round(Pos_Mb_hi, digits = 2)) %>%
  dplyr::select(CHR, Pos_Mb_lo, Pos_Mb_hi, lodcolumn, lod, everything()) %>%
  arrange(CHR, Pos_Mb_lo)

qtlplot <- qtldf %>%
  mutate(phe = case_when(lodcolumn == "FL50" ~ "flowering",
                              lodcolumn == "dyln_change_sec_2d_prior" ~ "daylength change (s) 2d prior",
                              lodcolumn == "dyln_change_sec" ~ "daylength change (s) 1d prior",
                              lodcolumn == "GR50" ~ "greenup",
                              lodcolumn == "crain_gr2fl" ~ "Rainfall, GR to FL")) %>%
  #filter(phe %in% c("Daylength", "GDD, GR to FL")) %>%
  mutate(POS_lo = Pos_Mb_lo * 1000000,
         POS_hi = Pos_Mb_hi * 1000000)

qtlplot$phe <- factor(qtlplot$phe, 
                      levels = c("flowering", "daylength change (s) 2d prior",
                                 "GDD, GR to FL", "Daylength",
                                          "daylength change (s)",
                                          "Rainfall, 1 day",
                                                  #"Rainfall, 2d sum",
                                                  "Rainfall, 3d sum",
                                                  "Rainfall, 5d sum"#,
                                                  #"Rainfall, 7d sum"
                                                  ))
```



```{r}
get_post_weights <- function(m){
  log10bf_df <- switchgrassGWAS:::get_log10bf(m = m) %>%
      as.data.frame() %>%
      rownames_to_column(var = "value") %>%
      dplyr::mutate(value = as.integer(.data$value)) %>%
      as_tibble() %>%
      left_join(switchgrassGWAS:::get_marker_df(m = m), by = "value") %>%
      dplyr::rename(log10BayesFactor = .data$V1) %>%
      dplyr::select(-.data$value)
  
  pw_df <- as_tibble(m$posterior_weights)
  pw_df <- switchgrassGWAS:::get_marker_df(m = m) %>%
    bind_cols(pw_df)
  
  ggman_df <- pw_df %>%
    #left_join(m_meta) %>%
    tidyr::separate(.data$Marker, into = c("Chr", "Pos"), remove = FALSE, sep = "_",
             extra = "merge", convert = TRUE) %>%
    dplyr::left_join(log10bf_df, by = "Marker") %>%
    dplyr::arrange(.data$Chr, .data$Pos) 
  return(ggman_df)
}

pw_gg <- get_post_weights(m_gulf_gr_hyp) %>%
  mutate(subpop = "Gulf",
         phenotype = "greenup")
pw_gf <- get_post_weights(m_gulf_fl_hyp) %>%
  mutate(subpop = "Gulf",
         phenotype = "flowering")

pw_mg <- get_post_weights(m_midw_gr_hyp) %>%
  mutate(subpop = "Midwest",
         phenotype = "greenup")
pw_mf <- get_post_weights(m_midw_fl_hyp) %>%
  mutate(subpop = "Midwest",
         phenotype = "flowering")

pw_gamg <- get_post_weights(m_gam_gr_hyp) %>%
  mutate(subpop = "Both",
         phenotype = "greenup")
pw_gamf <- get_post_weights(m_gam_fl_hyp) %>%
  mutate(subpop = "Both",
         phenotype = "flowering")
```

# Get any mash overlaps for QTL intervals
```{r}
pw_3f <- pw_gf %>%
  filter(log10BayesFactor > 2.56) %>%
  full_join(filter(pw_mf, log10BayesFactor > 2)) %>%
  full_join(filter(pw_gamf, log10BayesFactor > 2.65)) %>%
  arrange(Chr, Pos) %>%
  #filter(log10BayesFactor > 3) %>%
  dplyr::select(Chr:Pos, log10BayesFactor, subpop, phenotype, everything())

pw_3f_all <- pw_gf %>%
  full_join(pw_mf) %>%
  full_join(pw_gamf) %>%
  arrange(Chr, Pos) %>%
  dplyr::select(Chr:Pos, log10BayesFactor, subpop, phenotype, everything())

qtlplot
summary(pw_3f$log10BayesFactor)
quantile(pw_gf$log10BayesFactor, 0.99)  # Gulf: Use 2.56
quantile(pw_mf$log10BayesFactor, 0.99)  # Midwest: Use 2
quantile(pw_gamf$log10BayesFactor, 0.99)  # GAM: Use 2.65
quantile(pw_mf$log10BayesFactor, 0.995119)

quantile(pw_gg$log10BayesFactor, 0.99)  # Gulf: Use 2.0989
quantile(pw_mg$log10BayesFactor, 0.99)  # Midwest: Use 4.6831
quantile(pw_gamg$log10BayesFactor, 0.99)  # GAM: Use 3.0865

1-0.96196895
1-0.8006157
2/464  # GT 0.5%? No 0.0043%
22/418 # GT 3.8031? Yes 5.26%
42/255 # GT 19.93843%? No 16.47%

pw_3g <- pw_gg %>%
  filter(log10BayesFactor > 2.0989) %>%
  full_join(filter(pw_mg, log10BayesFactor > 4.6831)) %>%
  full_join(filter(pw_gamg, log10BayesFactor > 3.0865)) %>%
  arrange(Chr, Pos) %>%
  #filter(log10BayesFactor > 3) %>%
  dplyr::select(Chr:Pos, log10BayesFactor, subpop, phenotype, everything())
```
## SNPs sig in 1% tail or BF>2, whichever is stricter:
```{r}
pw_3f %>%
  arrange(desc(log10BayesFactor)) %>%
  pivot_longer(cols = null:flowering.simple_het_1.13, names_to = "Covar Matrix", values_to = "Posterior Weight") %>%
  filter(`Posterior Weight` > 0.01) %>%
  arrange(desc("Posterior Weight"))

pw_3g %>%
  arrange(desc(log10BayesFactor)) %>%
  pivot_longer(cols = null:greenup.singleton.MO.15, names_to = "Covar Matrix", values_to = "Posterior Weight") %>%
  filter(`Posterior Weight` > 0.01) %>%
  arrange(desc("Posterior Weight"))
```
3,4,6 >99% on gulf.crain_7d

1,2,8 on singleton.TX3 9.3e-01
5 on flowering.si

```{r}
qtlplot_fl <- qtlplot %>% 
  filter(lodcolumn %in% c("FL50", "dyln_change_sec_2d_prior")) 
qtlplot_gr <- qtlplot %>% 
  filter(lodcolumn %in% c("GR50", "dyln_change_sec")) 

i=1  # from 1 to 16
## In block & > 2
QTLandBF <- pw_3f %>%
  filter(Chr %in% qtlplot$CHR[i] & between(Pos, qtlplot$POS_lo[i], qtlplot$POS_hi[i])) %>%
  group_by(subpop) %>% tally()
## BF>2
inBF <- pw_3f %>%
  group_by(subpop) %>% tally()
## BF not > 2 (all minus BF > 2, all is below)
allwrtBF <- pw_3f_all %>%
  group_by(subpop) %>% tally()
## All in block
inQTL <- pw_3f_all %>%
  filter(Chr %in% qtlplot$CHR[i] & between(Pos, qtlplot$POS_lo[i], qtlplot$POS_hi[i])) %>%
  group_by(subpop) %>% tally()

QTLandBF
inQTL

phyper(QTLandBF$n[1], inBF$n[1], allwrtBF$n[1]-inBF$n[1], inQTL$n[1], 
       lower.tail = FALSE) # Both
phyper(QTLandBF$n[2], inBF$n[2], allwrtBF$n[2]-inBF$n[2], inQTL$n[2], 
       lower.tail = FALSE) # Gulf
phyper(QTLandBF$n[3], inBF$n[3], allwrtBF$n[3]-inBF$n[3], inQTL$n[3], 
       lower.tail = FALSE) # Midwest
```
BF > 2 results: 5 QTL intervals
1 ~ G
2: M
6: G, M
10: G&M, M
11: G, M
12: G&M, G
14 ~ G&M
16 ~ G&M

BF > 3 results: 7 QTL intervals. Different intervals, too. So I think having the same BF cutoff for these different mash results will give misleading conclusions. Do a % cutoff instead.
4 ~ G&M
6: G
8: G, M
11: M
12: G&M, G
13: M
14: G&M
15: M

1137 SNPs in 2K region. 66 sig > 2 in mash. 2/464 Midwest, 22/418 Gulf, 42/255 Both.

Summary statistics for log 10 Bayes Factor for pw_3f df
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
  2.000   2.234   2.568   2.848   3.140  10.385 
90% 3.936367
95% 4.622242
99% 6.257548

Gulf
90% 1.410253
95% 1.828653
99% 2.911984
Top 3.8% of Gulf is above 2.

Midwest 
90% 0.72685
95% 0.949753
99% 1.616983
Top 0.5% of Midwest is above 2.

G&M
90% 2.595963
95% 3.196745
99% 4.65753
top 20% of G&M is above 2.


## Hypergeometric test for significance of overlaps
phyper(10, 50, 200 - 50, 25, lower.tail = FALSE)
phyper(A&B, inB, notinB, inA, lower.tail = FALSE)
```{r}
phyper(22, 336, 50490-336, 418, lower.tail = FALSE)
phyper(AandB$n[2], inB$n[2], allwrtB$n[2]-inB$n[2], inA$n[2], 
       lower.tail = FALSE)
```

In block & > 2, >2, not > 2, in block
22, 336, 50490-336, 418


BF > 2
Both	7125			
Gulf	1921			
Midwest	336	

All SNPs
Both	35735			
Gulf	50490			
Midwest	63367	


Is there an enrichment of SNPs in the top 1% (5%? 10%?) of the distribution for each mash result in the QTL regions?
1% is probably best out of these three arbitrary cutoffs.
```{r}
m <- m_gulf_fl_hyp
qtl_df <- qtlplot

get_QTL_enrichment <- function(m, qtl_df, quantile = 0.95){
  pw_df_all <- get_post_weights(m)
  if("lod" %in% colnames(qtl_df)) {
    qtl_df <- qtl_df %>%
      arrange(desc(lod)) %>%
      mutate(pos = as.integer(pos)) %>%
      group_by(CHR, pos) %>%
      dplyr::slice(1) %>%
      arrange(CHR, pos)
  }
  
  BFthresh <- quantile(pw_df_all$log10BayesFactor, quantile)
  pw_df <- pw_df_all %>%
    filter(log10BayesFactor > BFthresh) %>%
    dplyr::select(Chr:Pos, log10BayesFactor, everything())
  
  for(i in 1:nrow(qtl_df)){  # from 1 to 16
  ## In block & > 2
  QTLandBF <- pw_df %>%
    filter(Chr %in% qtl_df$CHR[i] & between(Pos, qtl_df$POS_lo[i],
                                             qtl_df$POS_hi[i])) %>% 
    tally()
  ## BF>2
  inBF <- pw_df %>%
    tally()
  ## BF not > 2 (all minus BF > 2, all is below)
  allwrtBF <- pw_df_all %>%
    tally()
  ## All in block
  inQTL <- pw_df_all %>%
    filter(Chr %in% qtl_df$CHR[i] & between(Pos, qtl_df$POS_lo[i],
                                             qtl_df$POS_hi[i])) %>%
    tally()
  notinBF <- (allwrtBF$n[1]-inBF$n[1])
  pval <- phyper(QTLandBF$n[1], inBF$n[1], allwrtBF$n[1]-inBF$n[1], 
                 inQTL$n[1], lower.tail = FALSE)
  
  if(i == 1){
  outputdf <- tibble(Chr = qtl_df$CHR[i], Pos_lo = qtl_df$POS_lo[i], Pos_hi = qtl_df$POS_hi[i], inQTLandBF = QTLandBF$n[1], inBF = inBF$n[1], notinBF = notinBF, inQTL = inQTL$n[1], pvalue = pval)
  } else {
    outputdf <- outputdf %>%
      add_row(Chr = qtl_df$CHR[i], Pos_lo = qtl_df$POS_lo[i], Pos_hi = qtl_df$POS_hi[i],inQTLandBF = QTLandBF$n[1], inBF = inBF$n[1], notinBF = notinBF, inQTL = inQTL$n[1], pvalue = pval)
    }
  }
  return(outputdf)
}


enrich_gf <- get_QTL_enrichment(m_gulf_fl_hyp, qtl_df = qtlplot_fl, 0.99) %>%
  mutate(subpop = "Gulf", phenotype = "flowering")
enrich_mf <- get_QTL_enrichment(m_midw_fl_hyp, qtl_df = qtlplot_fl, 0.99) %>%
  mutate(subpop = "Midwest", phenotype = "flowering")
enrich_gamf <- get_QTL_enrichment(m_gam_fl_hyp, qtl_df = qtlplot_fl, 0.99) %>%
  mutate(subpop = "Both", phenotype = "flowering")

enrich_df <- enrich_gf %>%
  full_join(enrich_mf) %>%
  full_join(enrich_gamf) %>%
  arrange(Chr, Pos_lo)
enrich_df <- enrich_df %>%
  left_join(qtlplot_fl, by = c("Chr" = "CHR", "Pos_lo" = "POS_lo", "Pos_hi" = "POS_hi")) %>%
  dplyr::select(Chr, Pos_lo, Pos_hi, inQTLandBF:subpop, lod, lodcolumn, pos) %>%
  unique() %>%
  arrange(Chr, Pos_lo, lodcolumn)

enrich_df %>%
  filter(pvalue < 0.05)
  
t.test(enrich_df[enrich_df$pvalue < 0.05,]$lod, enrich_df[enrich_df$pvalue >= 0.05,]$lod) 
qtlplot_fl %>% group_by(CHR, POS_lo) %>% tally() # 21-24 unique QTL by Pos lo/hi. 23 by QTL maximum. 12 of 24 have enriched mash hits.

```

16 QTL. In all cases there was at least one SNP in the QTL interval that was in the 1% tail of SNPs in one of the three flowering mash runs.
We also looked for enrichment of SNPs in the 1% tail of significance in the mash distribution within each QTL interval. (in random genomic intervals of the same size do we see a similar level of enrichment?)
Half of these QTL had a significant enrichment of significant results for mash compared to expectations given the number of SNPs in the QTL interval.

2K: 2 QTL (lod 14 & 17), 1 enriched (in Midwest) (lod 17: CGDD_12C)
2N: 4 QTL (3 non-overlapping) (lod 19, 39, 17, 15), 2 enriched (lod 39 dylnfl50 in Midwest, in Both & 15 CGDD_12C in all three)
4K: 2 QTL, 2 enriched (lod 40 dyln in Midwest & 33 dyln in Gulf)
5N: 4 QTL (3 non-overlapping) (lod 55, 25, 17, 33), 3 enriched (2 non-overlapping) (lod 25 dyln in Midwest, 17 CGDD in Gulf, in Midwest, 33 dyln in Gulf, in Both)
7K: 2 QTL, 0 en (lod 14, 13)
8N: 1 QTL, 0 en (lod 15)
9N: 1 QTL, 0 en (lod 18)


in Midwest & for CGDD: 3
in Midwest & for dyln:
in Gulf & for CGDD: 
```{r}
qtlplot %>%
  group_by(lodcolumn) %>%
  tally()
qtlplot %>%
  group_by(CHR, Pos_Mb_lo, Pos_Mb_hi) %>%
  tally()
qtlplot %>%
  filter(lodcolumn %in% c("dyln_change_sec", "FL50"))
```

# Make random QTL dataframe

This random df just needs a CHR, POS_lo, and POS_hi column to work in the get_QTL_enrichment function I made. 
```{r}
sig_random <- c()
chr_size_mash <- pw_3f_all %>%
  ungroup() %>%
  group_by(Chr) %>%
  dplyr::summarise(Pos_lo = min(Pos),
                   Pos_hi = max(Pos))

for(j in 1:1000){
  qtl_size <- qtlplot_fl %>%
    dplyr::select(CHR, POS_lo, POS_hi) %>%
    dplyr::distinct() %>%   # don't doublecount completely overlapping QTL
    #(does doublecount partially overlapping QTL, however.)
    group_by(CHR, POS_lo) %>%
    dplyr::mutate(Size = POS_hi - POS_lo) %>%
    dplyr::select(CHR, POS_lo, Size)

  rchr <- chr_size_mash$Chr[sample(1:18, nrow(qtl_size), replace = TRUE)]
  rposlo <- c()
  for(i in 1:length(rchr)){
    rposlo[i] <- sample(chr_size_mash$Pos_lo[which(chr_size_mash$Chr == rchr[i])]:chr_size_mash$Pos_hi[which(chr_size_mash$Chr == rchr[i])], 1)
  }
  
  random_qtl <- tibble(CHR = rchr, POS_lo = rposlo, Size = qtl_size$Size) %>%
    mutate(POS_hi = POS_lo + Size) %>%
    arrange(CHR, POS_lo)

  random_gf <- get_QTL_enrichment(m = m_gulf_fl_hyp, qtl_df = random_qtl, 0.99) %>%
    mutate(subpop = "Gulf", phenotype = "flowering")
  random_mf <- get_QTL_enrichment(m_midw_fl_hyp, qtl_df = random_qtl, 0.99) %>%
    mutate(subpop = "Midwest", phenotype = "flowering")
  random_gamf <- get_QTL_enrichment(m_gam_fl_hyp, qtl_df = random_qtl, 0.99) %>%
    mutate(subpop = "Both", phenotype = "flowering")
  
  random_df <- random_gf %>%
    full_join(random_mf) %>%
    full_join(random_gamf) %>%
    arrange(Chr, Pos_lo)

  sig_random[j] <- nrow(filter(random_df, pvalue < 0.05))
}
saveRDS(sig_random, file = "../data/Random_QTL_df_significant_enrichments_of_mash_1per_tail_SNPs_1000runs.rds")
tibble(`mash 1% tail significant enrichments` = sig_random) %>%
  ggplot(aes(x = `mash 1% tail significant enrichments` )) +
  switchgrassGWAS::theme_oeco +
  geom_histogram(binwidth = 1) + 
  xlim(c(1, 24)) + ylab("") +
  geom_vline(xintercept = 16, linetype = 2, color = "red")
save_plot(filename = "../manuscript/Coauthors/PNAS/Revision/Figure_4_QTL_overlaps_random_QTL_enrichments_with_mash_1000runs.png", plot = last_plot(), base_height = 1.8, base_asp = 1.8)

tibble(sig_r = sig_random) %>%
  arrange(desc(sig_r))
11/1000
```

### Same process for greenup

```{r}

enrich_gg <- get_QTL_enrichment(m_gulf_gr_hyp, qtl_df = qtlplot_gr, 0.95) %>%
  mutate(subpop = "Gulf", phenotype = "greenup")
enrich_mg <- get_QTL_enrichment(m_midw_gr_hyp, qtl_df = qtlplot_gr, 0.9959) %>%
  mutate(subpop = "Midwest", phenotype = "greenup")
enrich_gamg <- get_QTL_enrichment(m_gam_gr_hyp, qtl_df = qtlplot_gr, 0.95) %>%
  mutate(subpop = "Both", phenotype = "greenup")

enrich_gr <- enrich_gg %>%
  full_join(enrich_mg) %>%
  full_join(enrich_gamg) %>%
  arrange(Chr, Pos_lo)
enrich_gr <- enrich_gr %>%
  left_join(qtlplot_gr, by = c("Chr" = "CHR", "Pos_lo" = "POS_lo", "Pos_hi" = "POS_hi")) %>%
  dplyr::select(Chr, Pos_lo, Pos_hi, inQTLandBF:subpop, lod, lodcolumn, pos) %>%
  unique() %>%
  arrange(Chr, Pos_lo, lodcolumn)

enrich_gr %>%
  filter(pvalue < 0.05)
  
t.test(enrich_gr[enrich_gr$pvalue < 0.05,]$lod, enrich_gr[enrich_gr$pvalue >= 0.05,]$lod) 
qtlplot_gr %>% group_by(CHR, POS_lo) %>% tally() # 21-24 unique QTL by Pos lo/hi. 23 by QTL maximum. 12 of 24 have enriched mash hits.

```

