---
title: "Analysis_v1.1_covariance_comparisons"
author: "Alice MacQueen"
date: 2022-01-06
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(here)
library(rlist)
library(vegan)
library(geosphere)
```

#

Compare covariance matrices - phenotypic covariance matrices used as Uhyp, some genetic covariance matrices I made with ASReml, and potentially some new genetic covariance matrices that Li will make.

Load covariance matrices
```{r}
outputdir <- file.path(here("analysis", "gwas", "BLUPs", "single_sites"))
mashdir <- file.path(here("analysis", "mash"))

metadata <- read_rds(here("data", "metadata.rds"))
# pvdiv PLANT_ID metadata
sites <- read_rds(here("data", "sites.rds"))
# pvdiv common garden metadata
subpops <- read_rds(here("data", "subpop_color_coding.rds"))
phe_gr_df <- read_rds(here("data",
                           "Weather_related_phe_for_asreml_h2_GR50.rds"))
# all greenup related phenotypes, including greenup as functions of weather variables.
phe_fl_df <- read_rds(here("data",
                           "Weather_related_phe_for_asreml_h2_FL50.rds"))
# all flowering related phenotypes, including functions of weather variables.
k_full <- read_rds(here("data",                             "Kinship_van_Raden_630_individuals_SNPs_r2_20percent.rds"))
# kinship matrix for 630 tetraploid individuals.

## vectors with subsets of gardens, phenotypes, and genetic subpopulations.
site_v <- list(TX1 = "TX1", TX2 = "TX2", TX3 = "TX3", OK = "OK", MO = "MO",
               NE = "NE", MI = "MI", SD = "SD")
subpop_v <- list(Gulf_and_Midwest = "363g_12.1M", Midwest = "134g_8.8M", 
                 Gulf = "229g_10.3M")
subpop_v2 <- list(Gulf_and_Midwest = c("Gulf", "Midwest"), Midwest = "Midwest",
                  Gulf = "Gulf")
phe_single <- c("FL50", "dyln_fl50", "cgdd_12c_gr2fl", "crain_gr2fl",
                "crain_1d", "GR50", "cgdd_12c_10d")
phe_mult <- list(flowering_5 = c("FL50", "dyln_fl50", "cgdd_12c_gr2fl",
                                 "crain_gr2fl", "crain_1d"), 
                 greenup_2 = c("GR50", "cgdd_12c_10d"))
# paths to large SNP files
inputfiles <- read_delim(here("analysis", "gwas", "inputkinship.txt"),  
                         delim = " ", 
                         col_names = "SNPfiles") 



## Define U_hyp: needs to change for Midwest, which drops gardens. -------------

U_hyp <- list()
# change based on phenotype ---------------
#phe_hyp <- c("cgdd_12c_10d", "cgdd_12c_18d", "cgdd_12c_5d", 
#             "tave_5d", "tave_10d", "tave_18d")
phe_hyp <- c("FL50", "GR50", "dyln_fl50", "dyln_change_sec", "cgdd_12c_gr2fl", 
             "crain_gr2fl", "crain_1d", "crain_3d", "crain_5d")


for(i in seq_along(phe_hyp)){
  for(k in seq_along(subpop_v2)){
    
    cov_df <- phe_fl_df %>%
      ungroup() %>%
      left_join(select(sites, SITE, manu_site), by = "SITE") %>%
      filter(SUBPOP %in% subpop_v2[[k]]) %>%
      select(PLANT_ID, SUBPOP, manu_site, phe_hyp[i]) %>%
      group_by(PLANT_ID, SUBPOP, manu_site) %>%
      mutate(IND = row_number()) %>%
      pivot_wider(names_from = manu_site, values_from = phe_hyp[i]) %>%
      mutate(PLANT_ID = as.factor(PLANT_ID),
             IND = as.factor(IND)) %>%
      select(-IL) %>%
      select(PLANT_ID, SUBPOP, IND, MI, MO, NE, OK, SD, TX1, TX2, TX3) ##### 
    
    cor_phe <- cor(cov_df[,-(1:3)], use = "pairwise")
    # Set diagonal of this matrix = coefficient of variation within each garden.
    diag(cor_phe) <- cov_df %>%
      ungroup() %>%
      summarise(MI = sqrt(var(MI, na.rm = TRUE))/mean(MI, na.rm = TRUE),  #####
                MO = sqrt(var(MO, na.rm = TRUE))/mean(MO, na.rm = TRUE),
                NE = sqrt(var(NE, na.rm = TRUE))/mean(NE, na.rm = TRUE),
                OK = sqrt(var(OK, na.rm = TRUE))/mean(OK, na.rm = TRUE),
                SD = sqrt(var(SD, na.rm = TRUE))/mean(SD, na.rm = TRUE),
                TX1 = sqrt(var(TX1, na.rm = TRUE))/mean(TX1, na.rm = TRUE),
                TX2 = sqrt(var(TX2, na.rm = TRUE))/mean(TX2, na.rm = TRUE),
                TX3 = sqrt(var(TX3, na.rm = TRUE))/mean(TX3, na.rm = TRUE)) %>%
      as_vector()

    U_hyp <- list.prepend(U_hyp, cor_phe)
    names(U_hyp)[1] <- paste0(phe_hyp[i], "_", names(subpop_v2)[k])
  }
}

```

How similar are the flowering Uhyp covar matrices?
```{r}
site_dists <- distm(cbind(sites_for_dist$Longitude, sites_for_dist$Latitude), fun = distHaversine)
dist_sites <- as.dist(site_dists)

U_dist <- list()
for(i in seq_along(U_hyp)) {
  U_dist[[i]] <- as.dist(U_hyp[[i]])
  
}
names(U_dist) <- names(U_hyp)

mantel.rtest(dist_sites, dist_cgdd_12c_gr2fl_Gulf, nrepet = 500)

i = 1; j = 10
pval_mantel <- data.frame()
for(i in seq_along(U_dist)) {
  for (j in seq_along(U_dist)) {
  pval_mantel[i, j] <- mantel.rtest(U_dist[[i]], U_dist[[j]], nrepet = 1000)[5]   
  }
}
colnames(pval_mantel) <- names(U_dist)
pval_mantel %>%
  add_column(matrix_row = names(U_dist), .before = TRUE) %>%
  pivot_longer(cols = 2:28, names_to = "matrix_col", values_to = "pvalue") %>%
  #filter(matrix_row != matrix_col) %>%
  arrange(pvalue) %>%
  filter(matrix_col %in% c("dyln_fl50_Gulf_and_Midwest", "dyln_fl50_Gulf", "dyln_change_sec_Midwest", "cgdd_12c_gr2fl_Gulf", "cgdd_12c_gr2fl_Gulf_and_Midwest",
                            "cgdd_12c_gr2fl_Midwest", "GR50_Midwest", "GR50_Gulf", "GR50_Gulf_and_Midwest", "FL50_Gulf", "FL50_Midwest",
                           "FL50_Gulf_and_Midwest")) %>%
  filter(matrix_row %in% c("dyln_fl50_Gulf_and_Midwest", "dyln_fl50_Gulf", "dyln_change_sec_Midwest", "cgdd_12c_gr2fl_Gulf", "cgdd_12c_gr2fl_Gulf_and_Midwest",
                            "cgdd_12c_gr2fl_Midwest",  "GR50_Midwest", "GR50_Gulf", "GR50_Gulf_and_Midwest", "FL50_Gulf", "FL50_Midwest",
                           "FL50_Gulf_and_Midwest")) %>%
  ggplot(aes(x = matrix_col, y = matrix_row)) + 
  geom_tile(aes(fill = -log10(pvalue) > 2.5, color = -log10(pvalue)), size = 5, 
            width = 0.75, height = 0.75) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) +
  scale_fill_viridis_d(end = 0.95, option = "B") +
  scale_color_viridis_c(end = 0.8, option = "D")

mantel.rtest(U_dist$cgdd_12c_gr2fl_Midwest, U_dist$crain_1d_Gulf)

sites$manu_site <- factor(sites$manu_site, levels = c("MI", "MO", "NE", "OK", "SD", "TX1", "TX2", "TX3")) 

sites_for_dist <- sites %>%
  filter(!is.na(manu_site)) %>%
  arrange(manu_site)

-log10(.005)
.05/50
?geom_tile
```
MI MO NE OK SD TX1 TX2 TX3

In contrast, if the tested correlation matrix does not have a significant relationship with the geographic separation of the samples (Mantel statistic R: 0.138, p value = 0.052). In that case, as samples became physically more separated their corresponding correlation matrix do not necessarily become more dissimilar.

144 of 552 pairwise comparisons (of nonidentical matrices) were significant.
26%. A reasonable chunk.
```{r}
144/552
```

```{r}
pval_mantel %>%
  add_column(matrix_row = names(U_dist), .before = TRUE) %>%
  pivot_longer(cols = 2:28, names_to = "matrix_col", values_to = "pvalue") %>%
  #filter(matrix_row != matrix_col) %>%
  arrange(pvalue) %>%
  ggplot(aes(x = matrix_col, y = matrix_row)) + 
  geom_tile(aes(fill = -log10(pvalue) > 2.5, color = -log10(pvalue)), size = 4, 
            width = 0.75, height = 0.75) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) +
  scale_fill_viridis_d(end = 0.95, option = "B") +
  scale_color_viridis_c(end = 0.8, option = "D")
```


Correlations for greenup matrices?

Distance correlations with flowering?

Three flowering matrices correlated with physical site distance: 
crain_3d_Gulf  0.01698302
crain_3d_Gulf_and_Midwest  0.02797203
crain_1d_Gulf  0.03996004
```{r}
mantel.rtest(dist_sites, dist_cgdd_12c_gr2fl_Gulf, nrepet = 500)

pval_mantel_dist <- c()
for(i in seq_along(U_dist)) {
  pval_mantel_dist[i] <- mantel.rtest(dist_sites, U_dist[[i]], nrepet = 1000)[5] }
names(pval_mantel_dist) <- names(U_dist)
```


## Distance correlations with greenup?

## Correlations between FL G & P matrices?

Need to make FL50 P correlation matrix
```{r}
U_dist$FL50_Gulf


cov_df <- var_table %>%
  filter(Phenotype == "FL50" & Subpop == "Gulf") %>%
  select(-SE, -Phenotype, -Subpop, -loglik) %>%
  pivot_wider(names_from = Garden_2, values_from = Estimate) %>%
  filter(Value == "r_G") %>%
  select(-Value) %>%
  add_row(Garden_1 = "SD") %>%
  column_to_rownames(var = "Garden_1") %>%
  add_column(TX1 = NA, .before = TRUE) %>%
  as.matrix()
diag(cov_df)
h2_diag_mean <- var_table %>%
  filter(Phenotype == "FL50" & Subpop == "Gulf") %>%
  filter(Value %in% c("h2_garden1", "h2_garden2")) %>%
  select(-SE, -Phenotype, -Subpop, -loglik)  %>%
  pivot_longer(cols = Garden_1:Garden_2, names_to = "GardenNo", values_to = "Site") %>%
  filter(!(Value == "h2_garden1" & GardenNo == "Garden_2") & !(Value == "h2_garden2" & GardenNo == "Garden_1") ) %>%
  group_by(Site) %>%
  summarize(h2 = mean(Estimate)) %>%
  arrange(desc(Site))

diag(cov_df) <- h2_diag_mean$h2

makeSymmU <- function(m) {
   m[upper.tri(m)] <- t(m)[upper.tri(m)]
   return(m)
}
makeSymmL <- function(m) {
   m[lower.tri(m)] <- t(m)[lower.tri(m)]
   return(m)
}

cov_mat <- makeSymmL(cov_df)
cov_df <- as.data.frame(cov_mat) %>%
  rownames_to_column() %>%
  select(rowname, MI, MO, NE, OK, SD, TX1, TX2, TX3)
cov_df$rowname <- factor(cov_df$rowname, levels = c("MI", "MO", "NE", "OK", 
                                                    "SD", "TX1", "TX2", "TX3"))
cov_mat <- cov_df %>%
  arrange(rowname) %>%
  column_to_rownames() %>%
  as.matrix()

cov_dist <- as.dist(cov_mat)
U_dist$FL50_Gulf
cov_dist
mantel.rtest(cov_dist, U_dist$FL50_Gulf, nrepet = 100000)
```
G & P for FL50 have p-value of 9.9999e-05 (minimum for 100K replicates, I believe). There is a relationship between the two matrices. Well, good, I should hope so.

## Correlations between GR G & P matrices?
```{r}

var_table <- read_csv(here("analysis", "genetic-covariances",
                           "Two_site_var_table_up_to_300_iterations.csv"))
var_table$Garden_2 <- factor(var_table$Garden_2, levels = c("SD", "MI", "NE", "MO", "OK", "TX3", "TX2"))
var_table$Garden_1 <- factor(var_table$Garden_1, levels = c("SD", "MI", "NE", "MO", "OK", "TX3", "TX2", "TX1"))

var_table %>%
  ggplot(aes(x = Garden_1, y = Garden_2)) + 
  geom_raster(aes(fill = Estimate)) + 
  facet_grid(rows = vars(Phenotype), cols = vars(Subpop)) +
      scale_fill_gradientn(colors = c("#440154FF", "#3B528BFF", "#2C728EFF",
                                      "white", "#27AD81FF", "#5DC863FF",
                                      "#FDE725FF"), limits = c(-1,1))


```


Basically can only meaningfully compare Gulf FL50 & GR50 at the moment. Li may have 7 more to share with me soon.

Gotta go through this process to get the matrices to be comparable.
```{r}
U_dist$GR50_Gulf


cov_df <- var_table %>%
  filter(Phenotype == "GR50" & Subpop == "Gulf") %>%
  select(-SE, -Phenotype, -Subpop, -loglik) %>%
  pivot_wider(names_from = Garden_2, values_from = Estimate) %>%
  filter(Value == "r_G") %>%
  select(-Value) %>%
  add_row(Garden_1 = "SD") %>%
  column_to_rownames(var = "Garden_1") %>%
  add_column(TX1 = NA, .before = TRUE) %>%
  as.matrix()
diag(cov_df)
h2_diag_mean <- var_table %>%
  filter(Phenotype == "GR50" & Subpop == "Gulf") %>%
  filter(Value %in% c("h2_garden1", "h2_garden2")) %>%
  select(-SE, -Phenotype, -Subpop, -loglik)  %>%
  pivot_longer(cols = Garden_1:Garden_2, names_to = "GardenNo", values_to = "Site") %>%
  filter(!(Value == "h2_garden1" & GardenNo == "Garden_2") & !(Value == "h2_garden2" & GardenNo == "Garden_1") ) %>%
  group_by(Site) %>%
  summarize(h2 = mean(Estimate)) %>%
  arrange(desc(Site))

diag(cov_df) <- h2_diag_mean$h2

makeSymmU <- function(m) {
   m[upper.tri(m)] <- t(m)[upper.tri(m)]
   return(m)
}
makeSymmL <- function(m) {
   m[lower.tri(m)] <- t(m)[lower.tri(m)]
   return(m)
}

cov_mat <- makeSymmL(cov_df)
cov_df <- as.data.frame(cov_mat) %>%
  rownames_to_column() %>%
  select(rowname, MI, MO, NE, OK, SD, TX1, TX2, TX3)
cov_df$rowname <- factor(cov_df$rowname, levels = c("MI", "MO", "NE", "OK", 
                                                    "SD", "TX1", "TX2", "TX3"))
cov_mat <- cov_df %>%
  arrange(rowname) %>%
  column_to_rownames() %>%
  as.matrix()

cov_dist <- as.dist(cov_mat)
U_dist$GR50_Gulf
cov_dist
mantel.rtest(cov_dist, U_dist$GR50_Gulf, nrepet = 100000)
```

G & P are pretty trivially not the same here. No relationship between these matrices. Too bad. p = 0.51.
Actually, belay that, I was comparing GR50 Gulf P & FL50 Gulf G! I would hope those are different.

G & P for GR50 have p-value of 0.00074 (100K replicates). There is a relationship between the two matrices. Well, good, I should hope so. Both I would count as a significant relationship by my criteria for cov matrices earlier, that is, the somewhat arbitrary/by eye cutoff of -log10p > 2.5 (p < .00316.)
```{r}
74/100000
-log10(.00073999)
-log10(9.99e-05)
-log10(.003162)
```
Mantel test, from Wikipedia:
In contrast to the ordinary use of the correlation coefficient, to assess significance of any apparent departure from a zero correlation, the rows and columns of one of the matrices are subjected to random permutations many times, with the correlation being recalculated after each permutation. The significance of the observed correlation is the proportion of such permutations that lead to a higher correlation coefficient.

The reasoning is that if the null hypothesis of there being no relation between the two matrices is true, then permuting the rows and columns of the matrix should be equally likely to produce a larger or a smaller coefficient. In addition to overcoming the problems arising from the statistical dependence of elements within each of the two matrices, use of the permutation test means that no reliance is being placed on assumptions about the statistical distributions of elements in the matrices. 