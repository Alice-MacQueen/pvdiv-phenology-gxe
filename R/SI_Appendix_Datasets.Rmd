---
title: "SI_Appendix_Datasets"
author: "Alice MacQueen"
date: 2021-06-24
output: html_document
---

Edited 2024-05-17 for revision2.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(here)
library(cowplot)
library(switchgrassGWAS)
library(ashr)
```

# 

Make all these datasets:

```         
Dataset 1. SNP-associated effects and standard errors for green-up estimated using the Gulf genetic subpopulation.
Dataset 2. SNP-associated effects and standard errors for green-up estimated using the Midwest genetic subpopulation.
Dataset 3. SNP-associated effects and standard errors for green-up estimated using Both genetic subpopulations.
Dataset 4. SNP-associated effects and standard errors for flowering estimated using the Gulf genetic subpopulation.
Dataset 5. SNP-associated effects and standard errors for flowering estimated using the Midwest genetic subpopulation.
Dataset 6. SNP-associated effects and standard errors for flowering estimated using Both genetic subpopulations.
Dataset 7. Genes within QTL that have functionally validated roles in flowering in rice.
Dataset 8. Overlap between quantitative trait loci for flowering measured using an outbred pseudo-F2 mapping population, and significant mash effect estimates (with a log10Bayes Factor > 2, or in the 1% tail of most significant mash results) found using three overlapping diversity panels. Genes within 20kb with a functionally validated role in flowering in rice are  indicated. 
```

# Dataset 1-6: mash objects

```{r}
mashdir <- here("analysis", "mash_greedy_algorithm", "mash_h2_diag_covar")

numSNPs_v <- c(19000, 19000, 19000, 19000, 24000, 33000)
suffix_v <- c("FL50_Gulf_and_Midwest", "FL50_Gulf", "GR50_Gulf_and_Midwest",
              "GR50_Gulf", "GR50_Midwest", "FL50_Midwest")
```

```{r}
m_gulf_gr_hyp <- readRDS(file.path(mashdir,  
                                   paste0("Strong_mash_posterior_",
                                          "est_w_ahm_random_greedy_h2_diag_Ulist", 
                                          numSNPs_v[4], "_SNPs_",
                                          suffix_v[4], ".rds")))
m_gulf_fl_hyp <- readRDS(file.path(mashdir,  
                                   paste0("Strong_mash_posterior_",
                                          "est_w_ahm_random_greedy_h2_diag_Ulist", 
                                          numSNPs_v[2], "_SNPs_",
                                          suffix_v[2], ".rds")))

m_midw_gr_hyp <- readRDS(file.path(mashdir,  
                                   paste0("Strong_mash_posterior_",
                                          "est_w_ahm_random_greedy_h2_diag_Ulist", 
                                          numSNPs_v[5], "_SNPs_",
                                          suffix_v[5], ".rds")))
m_midw_fl_hyp <- readRDS(file.path(mashdir,  
                                   paste0("Strong_mash_posterior_",
                                          "est_w_ahm_random_greedy_h2_diag_Ulist", 
                                          numSNPs_v[6], "_SNPs_",
                                          suffix_v[6], ".rds")))

m_gam_gr_hyp <- readRDS(file.path(mashdir,  
                                   paste0("Strong_mash_posterior_",
                                          "est_w_ahm_random_greedy_h2_diag_Ulist", 
                                          numSNPs_v[3], "_SNPs_",
                                          suffix_v[3], ".rds")))
m_gam_fl_hyp <- readRDS(file.path(mashdir,  
                                   paste0("Strong_mash_posterior_",
                                          "est_w_ahm_random_greedy_h2_diag_Ulist", 
                                          numSNPs_v[1], "_SNPs_",
                                          suffix_v[1], ".rds")))
```




## SI Appendix Table S1 Info

#### random SNP inputs

```{r}
popkey = list(all = "Gulf_and_Midwest", midwest = "Midwest", gulf = "Gulf")
phekey = list(greenup = "GR50", flowering = "FL50")
# i=2; j=1

for (i in seq_along(popkey)) {
  for (j in seq_along(phekey)) {
    
    if (i == 2 & j == 1) {
      betas <- readRDS(file = here("analysis", "mash", popkey[[i]], "inputs", 
                                 paste0("B_hat_random_df_24000topSNPs_",
                                        phekey[[j]], "_", popkey[[i]], ".rds")))
      stderr <- readRDS(file = here("analysis", "mash", popkey[[i]], "inputs", 
                                 paste0("S_hat_random_df_24000topSNPs_",
                                        phekey[[j]], "_", popkey[[i]], ".rds")))
    } else if (i == 2 & j == 2) {
      betas <- readRDS(file = here("analysis", "mash", popkey[[i]], "inputs", 
                                 paste0("B_hat_random_df_33000topSNPs_",
                                        phekey[[j]], "_", popkey[[i]], ".rds")))
      stderr <- readRDS(file = here("analysis", "mash", popkey[[i]], "inputs", 
                                 paste0("S_hat_random_df_33000topSNPs_",
                                        phekey[[j]], "_", popkey[[i]], ".rds")))
    } else {
      betas <- readRDS(file = here("analysis", "mash", popkey[[i]], "inputs", 
                                 paste0("B_hat_random_df_19000topSNPs_",
                                        phekey[[j]], "_", popkey[[i]], ".rds")))
      stderr <- readRDS(file = here("analysis", "mash", popkey[[i]], "inputs", 
                                 paste0("S_hat_random_df_19000topSNPs_",
                                        phekey[[j]], "_", popkey[[i]], ".rds")))
    }
    print(paste(names(popkey)[i], names(phekey)[j], "random SNP set (input into greedy mash algorithm) has", nrow(betas), "SNPs"))
  }
}

```

So random SNP sets have 71-127K SNPs.

#### strong SNP inputs

Numbers for this section: We then selected 19K relatively unlinked (r2 < 0.2) SNPs from each univariate GWAS that had the largest effect estimates in each GWAS (hereafter "strong" effects), which gave sets of 48K - 80K SNPs, and jointly re-estimated these effect size estimates at all eight sites using the set of significant covariance matrices that most improved the model fit on the random effects. Notably, the majority of these "strong" effects were not significant in univariate GWAS.

```{r}
switchgrassGWAS:::get_marker_df(m_gulf_gr_hyp) # 45931
switchgrassGWAS:::get_marker_df(m_gulf_fl_hyp) # 50490
switchgrassGWAS:::get_marker_df(m_midw_gr_hyp) # 49030
switchgrassGWAS:::get_marker_df(m_midw_fl_hyp) # 63367
switchgrassGWAS:::get_marker_df(m_gam_gr_hyp)  # 44765
switchgrassGWAS:::get_marker_df(m_gam_fl_hyp)  # 35735
```

```{r}
m <- m_gulf_gr_hyp
dataset_creation_function <- function(m, filename){

  all_effects <- switchgrassGWAS:::get_marker_df(m)
  BF <- switchgrassGWAS:::get_log10bf(m) |> 
    as.vector()
  all_effects$log10BF <- BF
  
  Means <- get_pm(m)
  StdErr <- get_psd(m)
  lfsr <- get_lfsr(m)
  # increase clarity of column names for Supplement data
  colnames(StdErr) <- colnames(StdErr) %>%
    str_replace(., "Stand_Bhat", "Effect_StandardError_") %>%
    str_replace(., "Gulf_and_Midwest", "Both") %>%
    str_replace(., "GR50", "GreenupDate") %>%
    str_replace(., "FL50", "FloweringDate")
  colnames(Means) <- colnames(Means) %>%
    str_replace(., "Stand_Bhat", "Effect_Mean_") %>%
    str_replace(., "Gulf_and_Midwest", "Both") %>%
    str_replace(., "GR50", "GreenupDate") %>%
    str_replace(., "FL50", "FloweringDate")
  colnames(lfsr) <- colnames(lfsr) %>%
    str_replace(., "Stand_Bhat", "Effect_lfsr_") %>%
    str_replace(., "Gulf_and_Midwest", "Both") %>%
    str_replace(., "GR50", "GreenupDate") %>%
    str_replace(., "FL50", "FloweringDate")
  
  all_effects <- cbind(all_effects, Means, StdErr, lfsr) %>%
    select(starts_with("Marker"), log10BF, ends_with("TX1"), ends_with("TX2"),
           ends_with("TX3"), ends_with("OK"), ends_with("MO"), ends_with("NE"),
           ends_with("MI"), ends_with("SD"))
  
  all_effects |> 
    write_csv(filename)
  
}


dataset_creation_function(m_gulf_gr_hyp, filename = here("manuscript", "revision2", "SI_Appendix", "Dataset_1_Gulf_vegetative_growth_date.csv"))
dataset_creation_function(m_gulf_fl_hyp, filename = here("manuscript", "revision2", "SI_Appendix", "Dataset_4_Gulf_reproductive_growth_date.csv"))

dataset_creation_function(m_gam_gr_hyp, filename = here("manuscript", "revision2", "SI_Appendix", "Dataset_3_Both_subpopulations_vegetative_growth_date.csv"))
dataset_creation_function(m_gam_fl_hyp, filename = here("manuscript", "revision2", "SI_Appendix", "Dataset_6_Both_subpopulations_reproductive_growth_date.csv"))

dataset_creation_function(m_midw_fl_hyp, filename = here("manuscript", "revision2", "SI_Appendix", "Dataset_5_Midwest_reproductive_growth_date.csv"))
dataset_creation_function(m_midw_gr_hyp, filename = here("manuscript", "revision2", "SI_Appendix", "Dataset_2_Midwest_vegetative_growth_date.csv"))
```


### Overlap with Hd1 from switchgrass functional validation study

```{r}
df_gam_fl <- read_csv(here("manuscript", "revision2", "SI_Appendix", "Dataset_6_Both_subpopulations_reproductive_growth_date.csv"))
df_gam_fl <- read_csv(here("manuscript", "revision2", "SI_Appendix", "Dataset_4_Gulf_reproductive_growth_date.csv"))
df_gam_fl <- read_csv(here("manuscript", "revision2", "SI_Appendix", "Dataset_5_Midwest_reproductive_growth_date.csv"))

df_gam_fl |> 
  separate(Marker, into = c("Chr", "Pos"), sep = "_", 
           remove = FALSE, convert = TRUE) |> 
  filter(Chr == "Chr04K", between(Pos, 23100000, 23200000)) |> 
  pivot_longer(cols = matches("lfsr"), names_to = "Garden", values_to = "lfsr")

get_significant_results(m_gam_fl_hyp) |> 
  as.data.frame() |> 
  rownames_to_column(var = "Marker") |> 
  separate(Marker, into = c("Chr", "Pos"), sep = "_", 
           remove = FALSE, convert = TRUE) |> 
  filter(Chr == "Chr04K", between(Pos, 23100000, 23200000))

mash_plot_effects(m = m_gam_fl_hyp, i = 13819)
```
Chr04K_23164108 in Both has log10BF ~ 2.3
Chr04K_23179015 in Gulf has log10BF ~ 1.86
Nearby SNPs _not_ significant in Midwest. log10BF ~ 0.1

# Dataset 7

```{r}
if (!require("BiocManager", quietly = TRUE))
    install.packages("BiocManager")

BiocManager::install("AnnotationDbi")
BiocManager::install("GenomicFeatures")
BiocManager::install("VariantAnnotation")
```

Find: `qtlplot` in Analysis_v0.6_QTL_interval_plotting. Really, find code to remake this with new QTL from revision2.

Find this file on NAS: "\~/Github/pvdiv-genome/Pvirgatum_516_v5.1.gene.txdb.sqlite"

Couldn't find it on the NAS, scp'd it from the Juenger Lab Server: `scp -i ~/Documents/server_keys/jls_alice alice@popgen.biosci.utexas.edu:/home/alice/Github/pvdiv-genome/Pvirgatum_516_v5.1.gene.txdb.sqlite ~/Documents/Github/pvdiv-phenology-gxe/data-raw/ignore/`

It's too big to commit; had to add it to data-raw/ignore files ignored by .gitignore.

```{r}
qtldf <- read_csv(here("phenology-fourway/5-QTLmappingForAlice/QTLsWithFlankMarkers_FL50_phenotypes_Alice_7_SITES_Full_model.csv"))

qtldf <- qtldf %>%
  separate(flank_lo, into = c("CHR", "Pos_Mb_lo"), sep = "_", convert = TRUE) %>%
  separate(flank_hi, into = c("flank", "Pos_Mb_hi"), sep = "_", convert = TRUE) %>%
  mutate(Pos_Mb_lo = round(Pos_Mb_lo, digits = 2),
         Pos_Mb_hi = round(Pos_Mb_hi, digits = 2)) %>%
  dplyr::select(CHR, Pos_Mb_lo, Pos_Mb_hi, lodcolumn, lod, everything()) %>%
  arrange(CHR, Pos_Mb_lo)

qtlplot <- qtldf %>%
  mutate(phe = case_when(lodcolumn == "FL50" ~ "Flowering Date",
                         lodcolumn == "dyln_fl50" ~ "Daylength",
                         lodcolumn == "dyln_change_sec" ~ 
                           "daylength change (s)",
                         lodcolumn == "dyln_change_sec_2d_prior" ~ 
                           "daylength change, 2 days prior (s)",
                         lodcolumn == "GR50" ~ "Greenup Date",
                         lodcolumn == "crain_gr2fl" ~ "Rainfall, GR to FL")) %>%
  #filter(phe %in% c("Daylength", "GDD, GR to FL")) %>%
  mutate(POS_lo = Pos_Mb_lo * 1000000,
         POS_hi = Pos_Mb_hi * 1000000)

qtlplot$phe <- factor(qtlplot$phe, 
                      levels = c("Flowering Date", "Rainfall, GR to FL",
                                 "GDD, GR to FL", "Daylength",
                                 "daylength change (s)",
                                 "daylength change, 2 days prior (s)",
                                 "Rainfall, 1 day",
                                 "Greenup Date",
                                                  #"Rainfall, 2d sum",
                                                  "Rainfall, 3d sum",
                                                  "Rainfall, 5d sum"#,
                                                  #"Rainfall, 7d sum"
                                                  ))
```

```{r}
library(AnnotationDbi)
library(GenomicFeatures)
library(switchgrassGWAS)
qtl_anno_df <- qtlplot %>%
  dplyr::rename(start = POS_lo, end = POS_hi)
not_all_na <- function(x) any(!is.na(x))
txdb <- loadDb("~/Documents/Github/pvdiv-phenology-gxe/data-raw/ignore/Pvirgatum_516_v5.1.gene.txdb.sqlite")
# source("~/Github/Functions_ggplot-theme-adjustments_2018-01-03.R")

ftanno <- read_csv(here("data/Pvirgatum_v5.1.annotation_FTGeneHomologs.csv"))
ftkey <- read_delim(here("data", "OsGene_keyword_table.txt"),
                    delim = "\t")
ftanno %>%
  filter(!is.na(OsGene)) %>%
  left_join(ftkey, by = c("OsGene" = "Symbol")) %>%
  filter(Keyword %in% c("flowering time", "heading date")) %>% unique()

osgene_keyword_df <- ftkey %>%
  dplyr::select(-RAPdb, -MSU) %>%
  group_by(Symbol, Keyword) %>%
  dplyr::slice(1) %>%
  pivot_wider(names_from = Keyword, values_from = Title)

osgene_key <- osgene_keyword_df %>%
  dplyr::select(Symbol, `flowering time`, `heading date`, anther, flower,
                `floral meristem`, `floral meristem determinacy`, flowering,
                `flower development`, `carpel differentiation`, stamen, 
                `stamen number`, vegetative, `plant growth`, `chloroplast development`, chloroplast) %>%
  pivot_longer(cols = -Symbol, names_to = "Keyword", values_to = "Title") %>%
  filter(!is.na(Title)) %>%
  pivot_wider(names_from = Keyword, values_from = Title)

os_annos <- ftanno %>%
  filter(OsGene %in% osgene_key$Symbol | !is.na(AtGene)) %>%
  mutate(Pos_Mb = round(start/10000)/100,
         #Pos_Mb_e = floor(start/10000)/100,
         POS_bin = round(Pos_Mb*100/2)) %>%# ,
         #POS_bin_hi = round(Pos_Mb_e*100/2))
  dplyr::select(OsGene, AtGene, locusName, everything()) %>%
  dplyr::rename(`Gene ID` = locusName)

qtl_annos <- switchgrassGWAS::pvdiv_table_topsnps(df = qtl_anno_df, type = "table", txdb = txdb) %>%
    inner_join(os_annos, by = c("Gene ID")) %>%
    left_join(osgene_key, by = c("OsGene" = "Symbol")) %>%
    dplyr::select(where(not_all_na)) %>%
    group_by(CHR, pos, `Gene ID`) %>%
    dplyr::slice(1) 

names(qtl_annos)
all_na_gr_fl <- rowSums(is.na(qtl_annos[,59:70]))
add_column(qtl_annos, GR_FL_Osgene_NA = all_na_gr_fl, .before = TRUE) %>%
  group_by(CHR, pos, GR_FL_Osgene_NA < 12) %>%
  tally()
flowering_qtl_annos <- add_column(qtl_annos, GR_FL_Osgene_NA = all_na_gr_fl, .before = TRUE) %>%
  filter(GR_FL_Osgene_NA < 12) %>%
  dplyr::select(CHR, pos, phe, lod, Pos_Mb_lo, Pos_Mb_hi, ci_lo, ci_hi, `Gene ID`,  gene_start:gene_width, `Arabidopsis thaliana homolog`:`Rice gene annotation`, OsGene, anther:`floral meristem determinacy`) |> 
  mutate(
    Phenology_type = case_when(phe %in% 
                                 c("Flowering Date", 
                                   "daylength change, 2 days prior (s)") ~
                                 "Flowering Date",
                               phe %in% c("Greenup Date", 
                                          "daylength change (s)") ~ 
                                 "Greenup Date",
                               TRUE ~ NA_character_
                               ),
    .before = 3)

flowering_qtl_annos |> 
  filter(Phenology_type == "Greenup Date")
  
flowering_qtl_annos |> 
  arrange(Phenology_type) |> 
  write_csv(here("manuscript/revision2/SI_Appendix/Dataset_7_QTL_intervals_with_functionally_validated_homologs.csv"))
```

# Dataset 8

All flowering and green-up QTL intervals contained at least one SNP significant in at least one mash run at a log10-transformed Bayes Factor \> 2, or in the 1% tail of significance, whichever was stricter.

## Objects generated earlier

Get `qtlplot` object by running code starting at about line 150 (for Dataset 7). Get `m_gulf_fl_hyp` and other objects by running code starting at about line 35 (for Datasets 1-6).

## Thresholds

Decide on cutoff to use for rug plots and enrichment analysis: SNPs sig in 1% tail or BF\>2, whichever is stricter

1% tail is stricter in all cases except Midwest flowering, where BF\>2 is stricter, equivalent to a 0.49% tail (0.995119 quantile).

What is the Bayes Factor at the 99th quantile? If it's not above 2, what is the quantile where the BF \> 2?

```{r}
#quantile(pw_gf$log10BayesFactor, 0.99)  # Gulf: Use 2.56 BF
#quantile(pw_mf$log10BayesFactor, 0.99)  # Midwest: Use 2 BF
#quantile(pw_gamf$log10BayesFactor, 0.99)  # GAM: Use 2.65 BF
#quantile(pw_mf$log10BayesFactor, 0.995119)

#quantile(pw_gg$log10BayesFactor, 0.99)  # Gulf: Use 2.0989 BF
#quantile(pw_mg$log10BayesFactor, 0.99)  # Midwest: Use 4.6831 BF
#quantile(pw_gamg$log10BayesFactor, 0.99)  # GAM: Use 3.0865 BF
```

Now there are significant greenup date QTL, separate QTL & mash into greenup and flowering associations, and look for overlaps just within each phenology type.

```{r}
m <- m_gulf_fl_hyp
qtl_df <- qtlplot |>   # split by Phenology type. Define based on Figure 4.
  mutate(
    Phenology_type = case_when(phe %in% 
                                 c("Flowering Date", 
                                   "daylength change, 2 days prior (s)") ~
                                 "Flowering Date",
                               phe %in% c("Greenup Date", 
                                          "daylength change (s)") ~ 
                                 "Greenup Date",
                               TRUE ~ NA_character_
                               ),
    .before = 3)
qtl_fl <- qtl_df |> 
  filter(Phenology_type == "Flowering Date")
qtl_gr <- qtl_df |> 
  filter(Phenology_type == "Greenup Date")

subpop = "Gulf"
phe = "Flowering Date"

qtl_mash_overlap_function <- function(qtl, m, subpop, phe, onepcttail = 2){

  mash_df <- switchgrassGWAS:::get_log10bf(m = m) %>%
      as.data.frame() %>%
      dplyr::mutate(value = row_number()) %>%
      as_tibble() %>%
      left_join(switchgrassGWAS:::get_marker_df(m = m), by = "value") %>%
      dplyr::rename(log10BayesFactor = .data$V1) %>%
      dplyr::select(-.data$value) |> 
  ## TODO: FIX list/matrix column here
    tidyr::separate(.data$Marker, into = c("Chr", "Pos"), remove = FALSE, 
                    sep = "_", extra = "merge", convert = TRUE) %>%
    dplyr::arrange(.data$Chr, .data$Pos)

  for(i in 1:nrow(qtl)){  # from 1 to 16
    ## In block & > 2
    qtl_sub <- mash_df %>%
      filter(Chr %in% qtl$CHR[i] & between(Pos, qtl$POS_lo[i],
                                               qtl$POS_hi[i])) %>% 
      filter(log10BayesFactor > 2)
  
    if(i == 1){
    outputdf <- tibble(Chr = qtl$CHR[i], QTL_Pos_lo = qtl$POS_lo[i], 
                       QTL_Pos_hi = qtl$POS_hi[i], 
                       QTL_phenotype = qtl$lodcolumn[i], 
                       QTL_LOD = qtl$lod[i], mash_Pos = qtl_sub$Pos, 
                       mash_log10BayesFactor = qtl_sub$log10BayesFactor, mash_subpop = subpop, 
                       mash_phenotype = phe)
    } else {
      outputdf1 <- tibble(Chr = qtl$CHR[i], QTL_Pos_lo = qtl$POS_lo[i], 
                          QTL_Pos_hi = qtl$POS_hi[i], 
                          QTL_phenotype = qtl$lodcolumn[i], 
                          QTL_LOD = qtl$lod[i], mash_Pos = qtl_sub$Pos, 
                          mash_log10BayesFactor = qtl_sub$log10BayesFactor,
                          mash_subpop = subpop, 
                          mash_phenotype = phe)
      outputdf <- outputdf %>%
        full_join(outputdf1)
    }
  }
  outputdf <- outputdf |> 
    mutate(
      Marker_in_mash_1pct_tail = 
        case_when(mash_log10BayesFactor >= onepcttail ~ TRUE,
                  mash_log10BayesFactor < onepcttail ~ FALSE,
                  TRUE ~ NA)
    )
  return(outputdf)
}

overlap1 <- qtl_mash_overlap_function(qtl_fl, m_gulf_fl_hyp, 
                                      subpop = "Gulf", 
                                      phe = "Flowering Date",
                                      onepcttail = 2.56) 
overlap2 <- qtl_mash_overlap_function(qtl_fl, m_midw_fl_hyp, 
                                      subpop = "Midwest", 
                                      phe = "Flowering Date",
                                      onepcttail = 2) 
overlap3 <- qtl_mash_overlap_function(qtl_fl, m_gam_fl_hyp, 
                                      subpop = "Both", 
                                      phe = "Flowering Date",
                                      onepcttail = 2.65) 
overlap4 <- qtl_mash_overlap_function(qtl_gr, m_gulf_gr_hyp, 
                                      subpop = "Gulf", 
                                      phe = "Greenup Date",
                                      onepcttail = 2.0989) 
overlap5 <- qtl_mash_overlap_function(qtl_gr, m_midw_gr_hyp, 
                                      subpop = "Midwest", 
                                      phe = "Greenup Date",
                                      onepcttail = 4.6831) 
overlap6 <- qtl_mash_overlap_function(qtl_gr, m_gam_gr_hyp, 
                                      subpop = "Both", 
                                      phe = "Greenup Date",
                                      onepcttail = 3.0865) 

overlap4 %>%
  full_join(overlap5) %>%
  full_join(overlap6) |> 
  arrange(Chr, mash_Pos)
dataset_8 <- overlap1 %>%
  full_join(overlap2) %>%
  full_join(overlap3) %>%
  full_join(overlap4) %>%
  full_join(overlap5) %>%
  full_join(overlap6) |> 
  arrange(mash_phenotype, Chr, mash_Pos)

write_csv(dataset_8, file = here("manuscript", "revision2", "SI_Appendix",
                                 "Dataset_8_QTL_mash_overlap.csv"))
```


## Figure S1

Figure 3 is North x Texas GxE effects. Figure S1 is garden x garden GxE effects of individual loci.

Most differences in sign were between TX1, the southernmost garden, and all other gardens (SI Appendix, Figure S1). Similarly, more effects that differed in magnitude included gardens in the Texas region (52.3-55.9%), and most effect pairs in the North region were not distinguishable (91.5%).

## Figure S2

QTL x Env effects

We conducted quantitative trait loci (QTL) mapping of flowering as functions of five environmental cues that we also used as covariance matrices in mash, and identified eight QTL for flowering date, eight QTL for flowering as a function of day length change two days prior, one QTL for the start of vegetative growth, and two QTL for vegetative growth as a function of daylength change one day prior, all of which showed QTL by environment interactions (SI Appendix, Figure S2).